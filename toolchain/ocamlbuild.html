<?xml version="1.0" encoding="iso-8859-1"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
               "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<title>OCamlbuild</title>
<meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1"/>
<meta name="title" content="OCamlbuild"/>
<meta name="generator" content="Org-mode"/>
<meta name="generated" content="2012-09-02 19:15:17 EDT"/>
<meta name="author" content="Hongbo Zhang"/>
<meta name="description" content=""/>
<meta name="keywords" content=""/>
<style type="text/css">
 <!--/*--><![CDATA[/*><!--*/
  html { font-family: Times, serif; font-size: 12pt; }
  .title  { text-align: center; }
  .todo   { color: red; }
  .done   { color: green; }
  .tag    { background-color: #add8e6; font-weight:normal }
  .target { }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .right  {margin-left:auto; margin-right:0px;  text-align:right;}
  .left   {margin-left:0px;  margin-right:auto; text-align:left;}
  .center {margin-left:auto; margin-right:auto; text-align:center;}
  p.verse { margin-left: 3% }
  pre {
	border: 1pt solid #AEBDCC;
	background-color: #F3F5F7;
	padding: 5pt;
	font-family: courier, monospace;
        font-size: 90%;
        overflow:auto;
  }
  table { border-collapse: collapse; }
  td, th { vertical-align: top;  }
  th.right  { text-align:center;  }
  th.left   { text-align:center;   }
  th.center { text-align:center; }
  td.right  { text-align:right;  }
  td.left   { text-align:left;   }
  td.center { text-align:center; }
  dt { font-weight: bold; }
  div.figure { padding: 0.5em; }
  div.figure p { text-align: center; }
  div.inlinetask {
    padding:10px;
    border:2px solid gray;
    margin:10px;
    background: #ffffcc;
  }
  textarea { overflow-x: auto; }
  .linenr { font-size:smaller }
  .code-highlighted {background-color:#ffff00;}
  .org-info-js_info-navigation { border-style:none; }
  #org-info-js_console-label { font-size:10px; font-weight:bold;
                               white-space:nowrap; }
  .org-info-js_search-highlight {background-color:#ffff00; color:#000000;
                                 font-weight:bold; }
  /*]]>*/-->
</style>
<link rel="stylesheet" type="text/css" href="../css/style.css">
<script type="text/javascript">
<!--/*--><![CDATA[/*><!--*/
 function CodeHighlightOn(elem, id)
 {
   var target = document.getElementById(id);
   if(null != target) {
     elem.cacheClassElem = elem.className;
     elem.cacheClassTarget = target.className;
     target.className = "code-highlighted";
     elem.className   = "code-highlighted";
   }
 }
 function CodeHighlightOff(elem, id)
 {
   var target = document.getElementById(id);
   if(elem.cacheClassElem)
     elem.className = elem.cacheClassElem;
   if(elem.cacheClassTarget)
     target.className = elem.cacheClassTarget;
 }
/*]]>*///-->
</script>

</head>
<body>

<div id="preamble">

</div>

<div id="content">
<h1 class="title">OCamlbuild</h1>


<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#sec-1">Intorduction</a>
<ul>
<li><a href="#sec-1-1">Options</a></li>
<li><a href="#sec-1-2">Tags</a></li>
<li><a href="#sec-1-3">Handle Multiple Directories</a></li>
<li><a href="#sec-1-4">Packing</a></li>
<li><a href="#sec-1-5">Grouping Targets</a></li>
<li><a href="#sec-1-6">Debugging</a></li>
<li><a href="#sec-1-7">Documentation</a></li>
<li><a href="#sec-1-8">Glob patterns</a></li>
<li><a href="#sec-1-9">Lex Yacc</a></li>
<li><a href="#sec-1-10">ocamlfind</a></li>
<li><a href="#sec-1-11">Preprocessing</a>
<ul>
<li><a href="#sec-1-11-1">Built in flags</a></li>
</ul>
</li>
<li><a href="#sec-1-12">Principles</a>
<ul>
<li><a href="#sec-1-12-1">Rules</a></li>
<li><a href="#sec-1-12-2">Customize plugin</a></li>
</ul>
</li>
<li><a href="#sec-1-13">Mixing with C stubs</a>
<ul>
<li><a href="#sec-1-13-1">Built in support</a></li>
</ul>
</li>
<li><a href="#sec-1-14">Building cmi files</a></li>
<li><a href="#sec-1-15">Debugging</a></li>
</ul>
</li>
</ul>
</div>
</div>

<div id="outline-container-1" class="outline-2">
<h2 id="sec-1">Intorduction</h2>
<div class="outline-text-2" id="text-1">

<p>  The reason for <code>ocamlbuild</code> in OCaml is to solve the complex scheme
  to when building with the preprocessor <code>camlp4</code>. But it's very useful
  in other aspects as well.
</p>
<p>
  The building process is done in the <code>_build</code> directory. <code>ocamlbuild</code>
  copies the needed source files and compiles them.  In <code>_build</code>,
  <code>_log</code> file contains detailed building process. It's a good habit to
  refer <code>_log</code> file when you find something is wrong during the
  building process.
</p>
<p>
  <code>ocamlbuild</code> automatically creates a symbol link to the executable
  in the current directory.  There are built-in hygiene rules which
  means when start up, <i>.cmo, .cmi, or .o</i> should not appear in the
  toplevel, outside of the <i>_build</i>. Sometimes when you want to mix
  c-stubs, you tag the <i>.o</i> object file <code>precious</code> or <code>-no-hygiene</code>
</p>

</div>

<div id="outline-container-1-1" class="outline-3">
<h3 id="sec-1-1">Options</h3>
<div class="outline-text-3" id="text-1-1">


<table   border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides" id="tbl-ob_option">
<caption>Ocamlbuild options</caption>
<colgroup><col class="left" /><col class="left" />
</colgroup>
<thead>
<tr><th scope="col" class="left">Options</th><th scope="col" class="left">Comments</th></tr>
</thead>
<tbody>
<tr><td class="left">-version</td><td class="left">Display the version</td></tr>
<tr><td class="left">-vnum</td><td class="left">Display the version number</td></tr>
<tr><td class="left">-quiet</td><td class="left">Make as quiet as possible</td></tr>
<tr><td class="left">-verbose &lt;level&gt;</td><td class="left">Set the verbosity level (1 for some common error message)</td></tr>
<tr><td class="left">-documentation</td><td class="left">Show rules and flags(works with <code>_tags</code> file)</td></tr>
<tr><td class="left">-log &lt;file&gt;</td><td class="left">Set log file</td></tr>
<tr><td class="left">-no-log</td><td class="left">No log file</td></tr>
<tr><td class="left">-clean</td><td class="left">Remove build directory and other files, then exit</td></tr>
<tr><td class="left">-r</td><td class="left">Traverse directories <code>by default</code> (false: traverse to turn off)</td></tr>
</tbody>
<tbody>
<tr><td class="left">-I &lt;path&gt;</td><td class="left">Add to include directories</td></tr>
<tr><td class="left">-Is &lt;path,&hellip;&gt;</td><td class="left">(same as above, but accepts a (comma or blank)-separated list)</td></tr>
<tr><td class="left">-X &lt;path&gt;</td><td class="left">Directory to <code>ignore</code></td></tr>
<tr><td class="left">-Xs &lt;path,&hellip;&gt;</td><td class="left">(idem)</td></tr>
<tr><td class="left">-lib &lt;flag&gt;</td><td class="left">Link to this ocaml library <i>.cma</i></td></tr>
<tr><td class="left">-libs &lt;flag,&hellip;&gt;</td><td class="left">(idem)</td></tr>
<tr><td class="left">-mod &lt;module&gt;</td><td class="left">Link to this ocaml <code>module</code> <i>.cmo</i></td></tr>
<tr><td class="left">-mods &lt;module,&hellip;&gt;</td><td class="left">(idem)</td></tr>
<tr><td class="left">-pkg &lt;package&gt;</td><td class="left">Link to this ocaml findlib package</td></tr>
<tr><td class="left">-pkgs &lt;package,&hellip;&gt;</td><td class="left">(idem)</td></tr>
<tr><td class="left">-package &lt;package&gt;</td><td class="left">(idem)</td></tr>
<tr><td class="left">-lflag &lt;flag&gt;</td><td class="left">Add to ocamlc link flags</td></tr>
<tr><td class="left">-lflags &lt;flag,&hellip;&gt;</td><td class="left">(idem)</td></tr>
<tr><td class="left">-cflag &lt;flag&gt;</td><td class="left">Add to ocamlc compile flags</td></tr>
<tr><td class="left">-cflags &lt;flag,&hellip;&gt;</td><td class="left">(idem)</td></tr>
<tr><td class="left">-docflag &lt;flag&gt;</td><td class="left">Add to ocamldoc flags</td></tr>
<tr><td class="left">-docflags &lt;flag,&hellip;&gt;</td><td class="left">(idem)</td></tr>
<tr><td class="left">-yaccflag &lt;flag&gt;</td><td class="left">Add to ocamlyacc flags (you can hack for <code>menhir</code>)</td></tr>
<tr><td class="left">-yaccflags &lt;flag,&hellip;&gt;</td><td class="left">(idem)</td></tr>
<tr><td class="left">-lexflag &lt;flag&gt;</td><td class="left">Add to ocamllex flags</td></tr>
<tr><td class="left">-lexflags &lt;flag,&hellip;&gt;</td><td class="left">(idem)</td></tr>
</tbody>
<tbody>
<tr><td class="left">-ppflag &lt;flag&gt;</td><td class="left">Add to ocaml preprocessing flags</td></tr>
<tr><td class="left">-pp &lt;flag,&hellip;&gt;</td><td class="left">(idem)</td></tr>
</tbody>
<tbody>
<tr><td class="left">-tag &lt;tag&gt;</td><td class="left">Add to <code>default</code> tags</td></tr>
<tr><td class="left">-tags &lt;tag,&hellip;&gt;</td><td class="left">(idem)</td></tr>
<tr><td class="left">-tag-line &lt;tag&gt;</td><td class="left">Use this line of tags (as in _tags)</td></tr>
<tr><td class="left">-show-tags &lt;path&gt;</td><td class="left">Show tags that applies on that pathname</td></tr>
</tbody>
<tbody>
<tr><td class="left">-ignore &lt;module,&hellip;&gt;</td><td class="left">Don't try to build these modules, workaround ocamldep bug</td></tr>
<tr><td class="left">-no-links</td><td class="left">Don't make links of produced final targets</td></tr>
<tr><td class="left">-no-skip</td><td class="left">Don't skip modules that are requested by ocamldep but cannot be built</td></tr>
<tr><td class="left">-no-hygiene</td><td class="left">Don't apply sanity-check rules</td></tr>
<tr><td class="left">-no-plugin</td><td class="left">Don't build myocamlbuild.ml</td></tr>
<tr><td class="left">-no-stdlib</td><td class="left">Don't ignore stdlib modules</td></tr>
<tr><td class="left">-dont-catch-errors</td><td class="left">Don't catch and display exceptions <code>useful to display the call stack</code></td></tr>
</tbody>
<tbody>
<tr><td class="left">-just-plugin</td><td class="left">Just build myocamlbuild.ml</td></tr>
<tr><td class="left">-byte-plugin</td><td class="left">Don't use a native plugin but bytecode</td></tr>
<tr><td class="left">-plugin-option</td><td class="left">Use the option only when plugin is run</td></tr>
<tr><td class="left">-sanitization-script</td><td class="left">Change the file name for the generated sanitization script</td></tr>
<tr><td class="left">-no-sanitize</td><td class="left">Do not generate sanitization script</td></tr>
<tr><td class="left">-nothing-should-be-rebuilt</td><td class="left">Fail if something needs to be rebuilt</td></tr>
<tr><td class="left">-classic-display</td><td class="left">Display executed commands the old-fashioned way</td></tr>
<tr><td class="left">-use-menhir</td><td class="left">Use menhir instead of ocamlyacc</td></tr>
<tr><td class="left">-use-jocaml</td><td class="left">Use jocaml compilers instead of ocaml ones</td></tr>
<tr><td class="left">-use-ocamlfind</td><td class="left">Use ocamlfind to call ocaml compilers</td></tr>
<tr><td class="left">-j &lt;N&gt;</td><td class="left">Allow N jobs at once (0 for unlimited)</td></tr>
</tbody>
<tbody>
<tr><td class="left">-build-dir &lt;path&gt;</td><td class="left">Set build directory (implies no-links)</td></tr>
<tr><td class="left">-install-lib-dir &lt;path&gt;</td><td class="left">Set the install library directory</td></tr>
<tr><td class="left">-install-bin-dir &lt;path&gt;</td><td class="left">Set the install binary directory</td></tr>
<tr><td class="left">-where</td><td class="left">Display the install library directory</td></tr>
<tr><td class="left">-ocamlc &lt;command&gt;</td><td class="left">Set the OCaml bytecode compiler</td></tr>
<tr><td class="left">-ocamlopt &lt;command&gt;</td><td class="left">Set the OCaml native compiler</td></tr>
<tr><td class="left">-ocamldep &lt;command&gt;</td><td class="left">Set the OCaml dependency tool</td></tr>
<tr><td class="left">-ocamldoc &lt;command&gt;</td><td class="left">Set the OCaml documentation generator</td></tr>
<tr><td class="left">-ocamlyacc &lt;command&gt;</td><td class="left">Set the ocamlyacc tool</td></tr>
<tr><td class="left">-menhir &lt;command&gt;</td><td class="left">Set the menhir tool (use it after -use-menhir)</td></tr>
<tr><td class="left">-ocamllex &lt;command&gt;</td><td class="left">Set the ocamllex tool</td></tr>
<tr><td class="left">-ocamlmktop &lt;command&gt;</td><td class="left">Set the ocamlmktop tool</td></tr>
<tr><td class="left">-ocamlrun &lt;command&gt;</td><td class="left">Set the ocamlrun tool</td></tr>
<tr><td class="left">&ndash;</td><td class="left">Stop argument processing, remaining arguments are given to the user program</td></tr>
<tr><td class="left">-help</td><td class="left">Display this list of options</td></tr>
<tr><td class="left">&ndash;help</td><td class="left">Display this list of options</td></tr>
</tbody>
</table>



<p>
   The snippet below is a very simple example
</p>


<pre class="src src-shell-script">ocamlbuild -quiet xx.native -- args
ocamlbuild -quiet -use-ocamlfind xx.native -- args
</pre>


<p>
   You can pass flags to =ocamlc=| at compile time. i.e, <i>-cflags    -I,+lablgtk,-rectypes</i>
</p>
<p>
   You can link with <i>external</i> libraries(<i>.cma</i>). i.e, <i>-libs    unix,num</i>.  You may need additional options below to make it work
   if this not in OCaml's default search path, <i>-cflags    -I,/usr/local/lib/ocaml</i>, <i>-lflags -I,/usr/local/lib/ocaml</i>
</p>

<p>
   You can also build a library with specicfic modules included using
   <i>mllib</i> file
</p>



<pre class="src src-shell-script">cat top_level.mllib    
Dir_top_level_util
Dir_top_level  
</pre>


<p>   
   Then you can <code>ocamlbuild top_level.cma</code>, then you can use
   <code>ocamlobjinfo</code> to see exactly which modules are linked into it.
</p>



<pre class="src src-shell-script">ocamlobjinfo _build/top_level.cma | grep Unit  
Unit name: Dir_top_level_util
Unit name: Dir_top_level
</pre>


</div>

</div>

<div id="outline-container-1-2" class="outline-3">
<h3 id="sec-1-2">Tags</h3>
<div class="outline-text-3" id="text-1-2">

<p>   You can alo use <code>mlpack</code> file to do hierachical packing <code>_tags</code>
   file is for convenience.  Every source tree may have a <code>_tags</code>
   file, and each target may have a set of tags.
</p>


<p>
   You can digest the output below to get a general idea of how tags
   file work.  By preceding a tag with <i>a minus sign</i>, one can
   <code>remove</code> tags from one or more files.
</p>



<pre class="src src-shell-script">$<span style="color: #dfaf8f;">ocamlbuild</span> -show-tags test.ml

Tags for <span style="color: #cc9393;">"test.ml"</span>:
  {<span style="color: #8cd0d3;">.</span> extension:ml, file:test.ml, ocaml, pkg_camlp4.macro, pkg_menhirLib,
     pkg_ulex, predefine_ulex.ml, quiet, syntax_camlp4o, traverse, use_menhir .}

$<span style="color: #dfaf8f;">ocamlbuild</span> -show-tags test.byte
Tags for <span style="color: #cc9393;">"test.byte"</span>:
  {<span style="color: #8cd0d3;">.</span> byte, extension:byte, file:test.byte, ocaml, pkg_menhirLib, pkg_ulex,
     program, quiet, traverse, use_menhir .}

bash-3.2$ ocamlbuild -show-tags test.native
Tags for <span style="color: #cc9393;">"test.native"</span>:
  {<span style="color: #8cd0d3;">.</span> extension:native, file:test.native, native, ocaml, pkg_menhirLib,
     pkg_ulex, program, quiet, traverse, use_menhir .}
</pre>


<p>   
   The built-in <code>_tags</code> file is as follows:
</p>



<pre class="src src-shell-script">&lt;**/*.ml&gt;   or &lt;**/*.mli&gt; or &lt;**/*.ml.depends&gt; : ocaml 
&lt;**/*.byte&gt; : ocaml, byte, program 
&lt;**/*.native&gt;: ocaml, native, program
&lt;**/*.cma&gt;:ocaml, byte,library
&lt;**/*.cmxa&gt;:ocaml,native,library
&lt;**/*.cmo&gt;:ocaml,byte
&lt;**/*.cmx&gt;:ocaml,native
</pre>


<p>
   You can do some experiment do verify it, create a empty directory, and
   make a dummy ml file, then type <code>ocamlbuild -show-tags test.ml</code>,
   you will get the output as follows 
</p>



<pre class="src src-shell-script">Tags for <span style="color: #cc9393;">"test.ml"</span>: {<span style="color: #8cd0d3;">.</span> extension:ml, file:test.ml, ocaml, quiet .}
\end{bashcode}
</pre>


<p>
   <code>&lt;**/*.ml&gt;</code> means that <i>.ml</i> files in <i>current dir or sub dir</i>. A
  special tag made from the path name of the file relative to the
  toplevel of the project, is automatically defined for each file.
  Just as above, <code>test.ml</code> will be tagged <code>file:test.ml</code> and also
  <code>extension:ml</code>
</p>
</div>

</div>

<div id="outline-container-1-3" class="outline-3">
<h3 id="sec-1-3">Handle Multiple Directories</h3>
<div class="outline-text-3" id="text-1-3">

<p>   Suppose our directory structure is as follows 
</p>



<pre class="example">|---bar
|---baz
|---foo
</pre>


<p>   
   Our tags file is 
</p>



<pre class="example">&lt;bar&gt; or &lt;baz&gt; : include 
</pre>



<pre class="src src-caml"><span style="color: #dfaf8f;">open</span> <span style="color: #8cd0d3;">Printf</span>
<span style="color: #8cd0d3;">let</span> _ = <span style="color: #f0dfaf; font-weight: bold;">begin</span>
  print_int <span style="color: #8cd0d3;">Barfile</span>.i;
  print_int <span style="color: #8cd0d3;">Bazfile</span>.j;
<span style="color: #f0dfaf; font-weight: bold;">end</span>    
</pre>


<p>
   Here module <code>Barfile</code> and <code>Bazfile</code> lie in directries
   <i>bar,baz</i>. So, after typing ocamlbuild in toplevel directory, then
   your directory structure is as follows
</p>




<pre class="example">|-_build
|---bar
|---baz
|---foo
|-bar
|-baz
|-foo
</pre>

<p>
   What ocamlbuild did is straightforward if you read <code>_log</code>
</p>




<pre class="example">bash-3.2$ cat _build/_log 
### Starting build.
# Target: foo/main.ml.depends, tags: { extension:ml, file:foo/main.ml, ocaml, ocamldep, quiet, traverse }
/opt/godi/bin/ocamldep.opt -modules foo/main.ml &gt; foo/main.ml.depends
# Target: bar/barfile.ml.depends, tags: { extension:ml, file:bar/barfile.ml, ocaml, ocamldep, quiet, traverse }
/opt/godi/bin/ocamldep.opt -modules bar/barfile.ml &gt; bar/barfile.ml.depends
# Target: baz/bazfile.ml.depends, tags: { extension:ml, file:baz/bazfile.ml, ocaml, ocamldep, quiet, traverse }
/opt/godi/bin/ocamldep.opt -modules baz/bazfile.ml &gt; baz/bazfile.ml.depends
# Target: bar/barfile.cmo, tags: { byte, compile, extension:cmo, extension:ml, file:bar/barfile.cmo, file:bar/barfile.ml, implem, ocaml, quiet, traverse }
/opt/godi/bin/ocamlc.opt -c -I bar -I baz -o bar/barfile.cmo bar/barfile.ml
# Target: baz/bazfile.cmo, tags: { byte, compile, extension:cmo, extension:ml, file:baz/bazfile.cmo, file:baz/bazfile.ml, implem, ocaml, quiet, traverse }
/opt/godi/bin/ocamlc.opt -c -I baz -I bar -o baz/bazfile.cmo baz/bazfile.ml
# Target: foo/main.cmo, tags: { byte, compile, extension:cmo, extension:ml, file:foo/main.cmo, file:foo/main.ml, implem, ocaml, quiet, traverse }
/opt/godi/bin/ocamlc.opt -c -I foo -I baz -I bar -o foo/main.cmo foo/main.ml
# Target: foo/main.byte, tags: { byte, dont_link_with, extension:byte, file:foo/main.byte, link, ocaml, program, quiet, traverse }
/opt/godi/bin/ocamlc.opt bar/barfile.cmo baz/bazfile.cmo foo/main.cmo -o foo/main.byte
# Compilation successful.
</pre>



<p>
   So, you can see that <code>-I</code> flags was added <b>for each</b> included
   directory and their source was copied to <i>_build</i>, <code>foo</code> was copied
   was due to our target <code>foo/main.byte</code>. They are still <b>flat</b>
   structure actually. Ocamlbuild still takes each directory <i>as    source directory</i> and <i>do santity check</i>. Each source tree should
   still be built using ocamlbuild, it's not easy to mix with other
   build tools. You can add <code>-I</code> flags by hand, but the relative path
   does not work perfect, due to the fact that building was done in
   <code>_build</code> directory. But the good news is that it's easy to mix c
   stubs using ocamlbuild itself.
</p>
</div>

</div>

<div id="outline-container-1-4" class="outline-3">
<h3 id="sec-1-4">Packing</h3>
<div class="outline-text-3" id="text-1-4">

<ul>
<li>Binary, it's pretty easy
     create a file <code>a.mlpack</code>




<pre class="example">Bli
Blo
Blu
</pre>


<p>     
     Then type <code>ocamlbuild a.mco</code> is enough, ocamlbuild will emit
     command line such as this
</p>



<pre class="example">ocamlc.opt -pack foo.cmo bar.cmo -o a.cmo
</pre>


<p>     
     Packing modules in other directories is straightforward
</p>



<pre class="example">other1/Bli
other2/Blo
other3/Blu
</pre>

</li>
</ul>



<p>   
   The previous approach doesn't work if the files <i>bli.ml, blo.ml and    blu.ml</i> depend on each other and are in different
   directories. Let's assume that <code>blo.ml</code> depends on <code>bli.ml</code>. If
   they are in the same direcory, there is no problem because <code>Blo</code>
   sees the whole content of its directory. But if <code>otherdir1</code> and
   <code>otherdir2</code> are different, then you get an error because <code>Bli</code> is
   unbound in <code>Blo</code>.
</p>

<p>
   One solution would be to use the <i>-I</i> option: this approach will
   lead to a name clash.  Another solution is to write a plugin for
   Ocamlbuild. In our example, it is sufficient to say that the files
   in the directory <code>otherdir2</code> should see the content of both <code>otherdir1</code>
   and <code>otherdir2</code>.
</p>
<p>
   To do this we use the API function <code>Pathname.define_context</code>. Write
   the following myocamlbuild.ml in your main directory:
</p>



<pre class="src src-tuareg"><span class="linenr">1:  </span><span style="color: #ff7f00; font-weight: bold;">open</span> <span style="color: #8cd0d3;">Ocamlbuild_plugin</span><span style="color: #eadd83;">;;</span>
<span class="linenr">2:  </span>
<span class="linenr">3:  </span>dispatch <span style="color: #ff7f00; font-weight: bold;">begin</span> <span style="color: #f0dfaf; font-weight: bold;">function</span>
<span class="linenr">4:  </span> <span style="color: #dfaf8f;"> </span><span style="color: #eadd83;">|</span> After_rules <span style="color: #eadd83;">-&gt;</span>
<span class="linenr">5:  </span>      <span style="color: #8cd0d3;">Pathname</span>.define_context <span style="color: #cc9393;">"otherdir2"</span> <span style="color: #eadd83;">[</span><span style="color: #cc9393;">"otherdir1"</span><span style="color: #eadd83;">;</span> <span style="color: #cc9393;">"otherdir2"</span><span style="color: #eadd83;">]</span>
<span class="linenr">6:  </span>  <span style="color: #eadd83;">|</span> _ <span style="color: #eadd83;">-&gt;</span> <span style="color: #eadd83;">()</span>
<span class="linenr">7:  </span><span style="color: #ff7f00; font-weight: bold;">end</span>
</pre>

<p>
   Now you should be able to compile, using:
   <code>ocamlbuild main.byte</code>
</p>
<ul>
<li>Native
     In the tags file, typing something like



<pre class="example">&lt;bl{i,o,u}.cmx&gt;: for-pack(A) 
</pre>

<p>
     The initial packing module needs to be write <code>in a capital letter</code>
</p></li>
</ul>


</div>

</div>

<div id="outline-container-1-5" class="outline-3">
<h3 id="sec-1-5">Grouping Targets</h3>
<div class="outline-text-3" id="text-1-5">

<p>   You can also  group your targets <i>foo.itarget, foo.otarget</i>
</p>



<pre class="example">cat foo.itarget
main.native
main.byte 
stuff.docdir/index.html    
</pre>

<p>
   Then you can say <code>ocamlbuild foo.otarget</code>
</p>
</div>

</div>

<div id="outline-container-1-6" class="outline-3">
<h3 id="sec-1-6">Debugging</h3>
<div class="outline-text-3" id="text-1-6">


<p>
   For debugging and profiling name your target either <i>.d.byte</i>
   or <i>.p.native</i> or add a tag in <code>_tags</code> file <i>true:debug</i>.
</p>

<p>
   To debug ocmalbuild, you can add options like <code>-verbose 10</code>
</p>
</div>

</div>

<div id="outline-container-1-7" class="outline-3">
<h3 id="sec-1-7">Documentation</h3>
<div class="outline-text-3" id="text-1-7">


<p>
   To build documentation, create a file called <i>foo.odocl</i>, then
   write the modules you want to document, then build the target
   <code>foo.docdir/index.html</code>. When you use <code>-keep-code</code> flag in
   myocamlbuild.ml, only document of exposed modules are kept, which
   means that only the modules <i>that don't have signature file</i> will
   keep the source code. This is due to the fact that ocamldoc will
   try to process <i>mli</i> first, otherwise <i>ml</i> file.
</p>
<p>
   You can add such a line in your myocamlbuild.ml plugin
</p>




<pre class="src src-caml">flag [<span style="color: #cc9393;">"ocaml"</span>; <span style="color: #cc9393;">"doc"</span>] <span style="color: #bfebbf;">&amp;</span> <span style="color: #8cd0d3;">S</span>[<span style="color: #8cd0d3;">A</span><span style="color: #cc9393;">"-keep-code"</span>];
</pre>

<p>
   Or you can do it by hand
</p>



<pre class="example">ocamlbuild -ocamldoc 'ocamlfind ocamldoc -keep-code' foo.docdir/index.html
</pre>


<p>
   ocamldep seems to be lightweight to generate the dependency.  You
   can write a snippet code using ocamlgraphto generate the dependency
   graph without bothering ocamldoc
</p>
</div>

</div>

<div id="outline-container-1-8" class="outline-3">
<h3 id="sec-1-8"><span class="todo TODO"> TODO</span> Glob patterns</h3>
<div class="outline-text-3" id="text-1-8">


</div>

</div>

<div id="outline-container-1-9" class="outline-3">
<h3 id="sec-1-9">Lex Yacc</h3>
<div class="outline-text-3" id="text-1-9">

<p>    <i>mll, mly</i> files are supported by default, you can use menhir
    <code>-use-menhir</code> or add a line <code>true : use_menhir</code> Add a line in tags
    file
</p>
</div>

</div>

<div id="outline-container-1-10" class="outline-3">
<h3 id="sec-1-10">ocamlfind</h3>
<div class="outline-text-3" id="text-1-10">




<pre class="example">&lt;*.ml&gt; : pkg_sexplib.syntax, pkg_batteries.syntax, syntax_camlp4o
</pre>


<p>
    Here <code>syntax_camlp4o</code> is translated by myocamlbuild.ml to <code>-syntax     camlp4o</code> to pass to ocamlfind. <code>Pkg</code> needs <code>ocamlbuild plugin</code>
    support as well. ocamlfind can understand <code>-syntax camlp4o</code>.
</p>
<p>
    Examples with Syntax extension
</p>


<pre class="example">&lt;*.ml&gt;: package(lwt.unix), package(lwt.syntax), syntax(camlp4o) # only needs lwt.syntax when prepossessing
"prog.byte": package(lwt.unix)
</pre>


<p>
    Since 3.12,, you can use <code>-use-ocamlfind</code> to activate. ocamlfind
    predicates can be activated with the <code>predicate(...)</code> tag, like
    <code>package</code>
</p>





<pre class="example">&lt;*.ml&gt;: package(lwt.unix), package(lwt.syntax), syntax(camlp4o)
"prog.byte": package(lwt.unix)
</pre>


<p>
    ocamlbuild <b>cares</b> white space, <b>take care when write tags file</b>
</p>
</div>

</div>

<div id="outline-container-1-11" class="outline-3">
<h3 id="sec-1-11">Preprocessing</h3>
<div class="outline-text-3" id="text-1-11">

<p>   For preprocessing you can tag the file either <code>-pp</code> or tags <code>pp(cmd    ...)</code>
</p>
<p>
   There are two style to cooperate with syntax extension, one way is
   described above, making use of ocamlfind, in most case it works,
   but it does not work very well considering you want to build
   <code>.ml.ppo</code> and other stuff. And you introduce another dependency on
   ocamlfind
</p>
<p>
   The other way is to use <code>pp</code> directly, you could sym link your
   extension file to <code>camlp4 -where</code>. I found this way is <code>more</code>
   natural. And to make things even better, you don't need to symlink,
   you can finish this by using myocamlbuild.ml
</p>
<p>
   There's another case you may use syntax extension
   locally when developing  we will introduce it later.
</p>
<p>
   We can see different styles here.
</p>




<pre class="example">&lt;pa_*r.{ml,cmo,byte}&gt; : pkg_dynlink , pp(camlp4rf ), use_camlp4_full
&lt;*_ulex.{byte,native}&gt; : pkg_ulex 



&lt;pa_vector_r.{cmo,byte,native}&gt;:pkg_dynlink,use_camlp4_full,pkg_sexplib 
"map_filter_r.ml" : pp(camlp4r -filter map)
"wiki_r.ml" or "wiki2_r.ml"  : pp(camlp4rf -filter meta), use_camlp4_full
"wiki2_r.mli" : use_camlp4_full

pa_vector_r.ml:syntax_camlp4r,pkg_camlp4.quotations.r,pkg_camlp4.extend,pkg_sexplib.syntax
&lt;*_o.ml&gt; : syntax_camlp4o,pkg_sexplib.syntax
&lt;*_ulex.ml&gt; : syntax_camlp4o,pkg_ulex,pkg_camlp4.macro  
&lt;*_r.ml&gt;:syntax_camlp4r,pkg_camlp4.quotations.r,pkg_camlp4.macro,pkg_camlp4.extend 
</pre>


<p>
   Actually, <code>pp</code> is not needed here, ocamlbuild is smart
   enough to infer it as <i>.ml</i> tag.
</p>

<p>
   The <i>.mli</i> file also needs tags. For syntax extension, <i>order    matters</i>. When you use <code>pp</code> flag, you need to specify the path to
   <code>pa_xx.cmo</code>, so symbol link may help, but you can refer to
   myocamlbuild.ml, to save you from this tedious work.
</p>

</div>

<div id="outline-container-1-11-1" class="outline-4">
<h4 id="sec-1-11-1">Built in flags</h4>
<div class="outline-text-4" id="text-1-11-1">

<p>   Some built-in tags like <code>use_camlp4</code>, <code>use_camlp4_full</code> was
   propogated from <code>.ml</code> to <code>.odoc</code>, or more, they should be used
   separately from the syntax extensions
</p>
<p>
   The <code>_log</code> output is a typical processing by ocamlbuild
</p>




<pre class="example">&lt;gen_printer.ml&gt; : use_camlp4, camlp4rf
# Target: gen_printer.ml.depends, tags: { camlp4rf, extension:ml, file:gen_printer.ml, ocaml, ocamldep, quiet, traverse, use_camlp4 }
ocamlfind ocamldep -pp camlp4rf -modules gen_printer.ml &gt; gen_printer.ml.depends # cached
# Target: util.mli.depends, tags: { extension:mli, file:util.mli, ocaml, ocamldep, quiet, traverse, use_camlp4 }
ocamlfind ocamldep -modules util.mli &gt; util.mli.depends # cached
# Target: util.cmi, tags: { byte, compile, extension:mli, file:util.mli, interf, ocaml, quiet, traverse, use_camlp4 }
ocamlfind ocamlc -annot -c -I +camlp4 -o util.cmi util.mli # cached
# Target: gen_printer.odoc, tags: { camlp4rf, doc, extension:ml, file:gen_printer.ml, implem, ocaml, quiet, traverse, use_camlp4 }
ocamlfind ocamldoc -dump gen_printer.odoc -I +camlp4 -I +camlp4 -pp camlp4rf gen_printer.ml # cached
# Target: foo.docdir/gen_printer.dot, tags: {  }
rm -rf foo.docdir/gen_printer.dot
# Target: foo.docdir, tags: {  }
mkdir -p foo.docdir
# Target: foo.docdir/gen_printer.dot, tags: { doc, docfile, extension:docdir, extension:dot, file:foo.docdir, file:foo.docdir/gen_printer.dot, ocaml, quiet, traverse }
ocamlfind ocamldoc -load gen_printer.odoc -dot -o foo.docdir/gen_printer.dot
# Compilation successful.
</pre>


<p>
   Here for the file <code>gen_printer.ml</code>, both tags are necessary 
   For options <code>-ppflag</code>, and <code>-pp</code>, the source
</p>



<pre class="src src-tuareg"><span class="linenr"> 1:  </span><span style="color: #cc9393;">"-ppflag"</span><span style="color: #eadd83;">,</span> String <span style="color: #eadd83;">(</span>add_to<span style="color: #eadd83;">'</span> ocaml_ppflags_internal<span style="color: #eadd83;">),</span> <span style="color: #cc9393;">"&lt;flag&gt; Add to ocaml preprocessing flags"</span><span style="color: #eadd83;">;</span>
<span class="linenr"> 2:  </span><span style="color: #cc9393;">"-pp"</span><span style="color: #eadd83;">,</span> String <span style="color: #eadd83;">(</span>add_to ocaml_ppflags_internal<span style="color: #eadd83;">),</span> <span style="color: #cc9393;">"&lt;flag,...&gt; (idem)"</span><span style="color: #eadd83;">;</span>
<span class="linenr"> 3:  </span><span style="color: #ff7f00; font-weight: bold;">let</span> <span style="color: #8cd0d3;">add_to</span><span style="color: #dfaf8f;"> rxs x </span><span style="color: #eadd83;">=</span>
<span class="linenr"> 4:  </span>  <span style="color: #ff7f00; font-weight: bold;">let</span> <span style="color: #dfaf8f;">xs </span><span style="color: #eadd83;">=</span> <span style="color: #8cd0d3;">Lexers</span>.comma_or_blank_sep_strings <span style="color: #eadd83;">(</span><span style="color: #8cd0d3;">Lexing</span>.from_string x<span style="color: #eadd83;">)</span> <span style="color: #ff7f00; font-weight: bold;">in</span>
<span class="linenr"> 5:  </span>  rxs <span style="color: #eadd83;">:=</span> xs <span style="color: #eadd83;">::</span> <span style="color: #eadd83;">!</span>rxs
<span class="linenr"> 6:  </span><span style="color: #ff7f00; font-weight: bold;">let</span> <span style="color: #8cd0d3;">add_to</span><span style="color: #eadd83;">'</span><span style="color: #dfaf8f;"> rxs x </span><span style="color: #eadd83;">=</span>
<span class="linenr"> 7:  </span>  <span style="color: #f0dfaf; font-weight: bold;">if</span> x <span style="color: #eadd83;">&lt;&gt;</span> dummy <span style="color: #f0dfaf; font-weight: bold;">then</span>
<span class="linenr"> 8:  </span>    rxs <span style="color: #eadd83;">:=</span> <span style="color: #eadd83;">[</span>x<span style="color: #eadd83;">]</span> <span style="color: #eadd83;">::</span> <span style="color: #eadd83;">!</span>rxs
<span class="linenr"> 9:  </span>  <span style="color: #f0dfaf; font-weight: bold;">else</span>
<span class="linenr">10:  </span>    <span style="color: #eadd83;">()</span>
</pre>


</div>
</div>

</div>

<div id="outline-container-1-12" class="outline-3">
<h3 id="sec-1-12">Principles</h3>
<div class="outline-text-3" id="text-1-12">


<p>
   There's an <a href="http://www.seas.upenn.edu/~hongboz/hongbo_zhang_files/ob/">OCamlbuild API Documentation</a> for comprehensive study.b
</p>

</div>

<div id="outline-container-1-12-1" class="outline-4">
<h4 id="sec-1-12-1">Rules</h4>
<div class="outline-text-4" id="text-1-12-1">

<p>    A rule is composed of triple (Tags, Targets,
    Dependencies). ocamlbuild for all rules that are valid for this
    target.  You can set <code>-verbose 10</code> to get the backtrace in
    case of a failure.
</p>
<p>
    There are 3 stages,(hygiene, options(parsing the command line
    options), rules(adding the default rules to the system)). You
    can add hooks to what you want.
</p>



<pre class="example">{Before|After}_{options|hygiene|rules}    
</pre>


<p>
    To change the options, simply refer to the <a href="http://www.seas.upenn.edu/~hongboz/hongbo_zhang_files/ob/Options.html">Options</a> module. Read
    source file <code>ocaml_specific</code> to learn more.
</p>
</div>

</div>

<div id="outline-container-1-12-2" class="outline-4">
<h4 id="sec-1-12-2">Customize plugin</h4>
<div class="outline-text-4" id="text-1-12-2">

<ul>
<li id="sec-1-12-2-1">OCamlbuild in the toplevel<br/>




<pre class="src src-caml"><span style="color: #bfebbf;">#</span>directory <span style="color: #cc9393;">"+ocamlbuild"</span>;;
<span style="color: #bfebbf;">#</span>load <span style="color: #cc9393;">"unix.cma"</span>;;
<span style="color: #bfebbf;">#</span>load <span style="color: #cc9393;">"ocamlbuildlib.cma"</span>;;
<span style="color: #dfaf8f;">open</span> <span style="color: #8cd0d3;">Ocamlbuild_plugin</span>;;
</pre>


<p>
     Now you can do a lot of amazing things in the toplevel and write
     complex plugin system.
</p>

<p>
     We can play toplevel here
</p>





<pre class="src src-caml">rule;;
- : string <span style="color: #bfebbf;">-&gt;</span>
    <span style="color: #dfaf8f;">?tags:</span>string list <span style="color: #bfebbf;">-&gt;</span>
    <span style="color: #dfaf8f;">?prods:</span>string list <span style="color: #bfebbf;">-&gt;</span>
    <span style="color: #dfaf8f;">?deps:</span>string list <span style="color: #bfebbf;">-&gt;</span>
    <span style="color: #dfaf8f;">?prod:</span>string <span style="color: #bfebbf;">-&gt;</span>
    <span style="color: #dfaf8f;">?dep:</span>string <span style="color: #bfebbf;">-&gt;</span>
    <span style="color: #dfaf8f;">?stamp:</span>string <span style="color: #bfebbf;">-&gt;</span>
    <span style="color: #dfaf8f;">?insert:</span>[ `after <span style="color: #8cd0d3;">of</span> string <span style="color: #bfebbf;">|</span> `before <span style="color: #8cd0d3;">of</span> string <span style="color: #bfebbf;">|</span> `bottom <span style="color: #bfebbf;">|</span> `top ] <span style="color: #bfebbf;">-&gt;</span>
    <span style="color: #8cd0d3;">Ocamlbuild_plugin</span>.action <span style="color: #bfebbf;">-&gt;</span> unit
= &lt;<span style="color: #8cd0d3;">fun</span>&gt;
<span style="color: #bfebbf;">#</span> tags_of_pathname;;
- : <span style="color: #8cd0d3;">Ocamlbuild_plugin</span>.<span style="color: #8cd0d3;">Pathname</span>.t <span style="color: #bfebbf;">-&gt;</span> <span style="color: #8cd0d3;">Ocamlbuild_plugin</span>.<span style="color: #8cd0d3;">Tags</span>.t = &lt;<span style="color: #8cd0d3;">fun</span>&gt;
<span style="color: #bfebbf;">#</span> tag_file;;
- : <span style="color: #8cd0d3;">Ocamlbuild_plugin</span>.<span style="color: #8cd0d3;">Pathname</span>.t <span style="color: #bfebbf;">-&gt;</span> <span style="color: #8cd0d3;">Ocamlbuild_plugin</span>.<span style="color: #8cd0d3;">Tags</span>.elt list <span style="color: #bfebbf;">-&gt;</span> unit =
&lt;<span style="color: #8cd0d3;">fun</span>&gt;
<span style="color: #bfebbf;">#</span> flag;;
- : <span style="color: #8cd0d3;">Ocamlbuild_plugin</span>.<span style="color: #8cd0d3;">Tags</span>.elt list <span style="color: #bfebbf;">-&gt;</span> <span style="color: #8cd0d3;">Ocamlbuild_plugin</span>.<span style="color: #8cd0d3;">Command</span>.spec <span style="color: #bfebbf;">-&gt;</span> unit
= &lt;<span style="color: #8cd0d3;">fun</span>&gt;
<span style="color: #bfebbf;">#</span> dep;;
- : <span style="color: #8cd0d3;">Ocamlbuild_plugin</span>.<span style="color: #8cd0d3;">Tags</span>.elt list <span style="color: #bfebbf;">-&gt;</span>
    <span style="color: #8cd0d3;">Ocamlbuild_plugin</span>.<span style="color: #8cd0d3;">Pathname</span>.t list <span style="color: #bfebbf;">-&gt;</span> unit
= &lt;<span style="color: #8cd0d3;">fun</span>&gt;
</pre>


<p>
     The first argument is the name of the rule(uniqueness required),
     <code>~dep</code> is the dependency, <code>~prod</code> is the production.
</p>
<p>
     For example with rule
</p>


<pre class="example">~dep:"%.ml" ~prod:"%.byte" 
</pre>

<p>
     You can produce bla.byte from bal.ml
</p>
<p>
     There are some predefined commands such as Unix
     commands(cp,mv,&hellip;) as well.
     The sample code is a built-in rule in myocamlbuild source tree
</p>




<pre class="src src-caml">flag [<span style="color: #cc9393;">"ocaml"</span>; <span style="color: #cc9393;">"compile"</span>; <span style="color: #cc9393;">"thread"</span>] (<span style="color: #8cd0d3;">A</span> <span style="color: #cc9393;">"-thread"</span>)  
</pre>


<p>
     It says when tags <i>ocaml, compile, thread</i> are met together,
     <i>-thread</i> option should be emitted.
</p>
<p>
     You can go through the source code and read
</p>




<pre class="src src-caml"><span style="color: #8cd0d3;">let</span> flag tags flags = set_flags (<span style="color: #8cd0d3;">Tags</span>.of_list tags) flags
<span style="color: #8cd0d3;">let</span> dep tags deps = set_deps_of_tags (<span style="color: #8cd0d3;">Tags</span>.of_list tags) deps  
</pre>



<p>
     You can digger further and will find that <code>Tags.t</code> is actually
     <code>Set.Make(String).t</code>, but exported as an abstract type.
</p>
<p>
     <a href="http://www.seas.upenn.edu/~hongboz/hongbo_zhang_files/ob/Command.html">Command</a> module provides a bunch of useful API as well.
</p>
<p>
     Options contains mutable references to be configured
</p></li>
</ul>
<ul>
<li id="sec-1-12-2-2">Plugin Examples<br/>
<ul>
<li id="sec-1-12-2-2-1">AlphaCaml<br/>



<pre class="src src-tuareg"><span class="linenr"> 1:  </span><span style="color: #ff7f00; font-weight: bold;">open</span> <span style="color: #8cd0d3;">Ocamlbuild_plugin</span><span style="color: #eadd83;">;;</span>
<span class="linenr"> 2:  </span><span style="color: #ff7f00; font-weight: bold;">open</span> <span style="color: #8cd0d3;">Command</span><span style="color: #eadd83;">;;</span>
<span class="linenr"> 3:  </span>
<span class="linenr"> 4:  </span><span style="color: #ff7f00; font-weight: bold;">let</span> <span style="color: #dfaf8f;">alphaCaml </span><span style="color: #eadd83;">=</span> A<span style="color: #cc9393;">"alphaCaml"</span><span style="color: #eadd83;">;;</span>
<span class="linenr"> 5:  </span>
<span class="linenr"> 6:  </span>dispatch <span style="color: #ff7f00; font-weight: bold;">begin</span> <span style="color: #f0dfaf; font-weight: bold;">function</span>
<span class="linenr"> 7:  </span> <span style="color: #dfaf8f;"> </span><span style="color: #eadd83;">|</span> After_rules <span style="color: #eadd83;">-&gt;</span>
<span class="linenr"> 8:  </span>      rule <span style="color: #cc9393;">"alphaCaml: mla -&gt; ml &amp; mli"</span>
<span class="linenr"> 9:  </span>        <span style="color: #eadd83;">~</span><span style="color: #dfaf8f;">prods</span><span style="color: #eadd83;">:[</span><span style="color: #cc9393;">"%.ml"</span><span style="color: #eadd83;">;</span> <span style="color: #cc9393;">"%.mli"</span><span style="color: #eadd83;">]</span>
<span class="linenr">10:  </span>        <span style="color: #eadd83;">~</span><span style="color: #dfaf8f;">dep</span><span style="color: #eadd83;">:</span><span style="color: #cc9393;">"%.mla"</span>
<span class="linenr">11:  </span>        <span style="color: #ff7f00; font-weight: bold;">begin</span> <span style="color: #f0dfaf; font-weight: bold;">fun</span> <span style="color: #dfaf8f;">env _build </span><span style="color: #eadd83;">-&gt;</span>
<span class="linenr">12:  </span>          Cmd<span style="color: #eadd83;">(</span>S<span style="color: #eadd83;">[</span>alphaCaml<span style="color: #eadd83;">;</span> P<span style="color: #eadd83;">(</span>env <span style="color: #cc9393;">"%.mla"</span><span style="color: #eadd83;">)])</span>
<span class="linenr">13:  </span>        <span style="color: #ff7f00; font-weight: bold;">end</span>
<span class="linenr">14:  </span>  <span style="color: #eadd83;">|</span> _ <span style="color: #eadd83;">-&gt;</span> <span style="color: #eadd83;">()</span>
<span class="linenr">15:  </span><span style="color: #ff7f00; font-weight: bold;">end</span>
</pre>



<p>
      Here we show how to use rule in line [8-13], it means when
      you want to build <i>ml,mli</i> files, it will try to build it from
      <i>mla</i> first.
</p>
<p>
      To make it complete, for alphaCaml, you need some c stubs,
</p>



<pre class="example">$ ln -s /path/to/your/alphaCaml/directory/ alphaLib
$ cat _tags
"alphaLib": include, precious
</pre>


<p>
      It's very nice to make the whole directory precious, this is a
      way to mix different building units.
</p>
</li>
</ul>
<ul>
<li id="sec-1-12-2-2-2">Locally syntax extension<br/>




<pre class="src src-tuareg"><span class="linenr"> 1:  </span><span style="color: #ff7f00; font-weight: bold;">open</span> <span style="color: #8cd0d3;">Ocamlbuild_plugin</span><span style="color: #eadd83;">;;</span>
<span class="linenr"> 2:  </span><span style="color: #ff7f00; font-weight: bold;">open</span> <span style="color: #8cd0d3;">Command</span><span style="color: #eadd83;">;;</span>
<span class="linenr"> 3:  </span>dispatch <span style="color: #ff7f00; font-weight: bold;">begin</span> <span style="color: #f0dfaf; font-weight: bold;">function</span>
<span class="linenr"> 4:  </span> <span style="color: #dfaf8f;"> </span><span style="color: #eadd83;">|</span> After_rules <span style="color: #eadd83;">-&gt;</span>
<span class="linenr"> 5:  </span>      <span style="color: #7f9f7f;">(* </span><span style="color: #7f9f7f; font-style: italic;">Add pa_openin.cmo to the ocaml pre-processor when use_opening is set </span><span style="color: #7f9f7f;">*)</span>
<span class="linenr"> 6:  </span>      flag <span style="color: #eadd83;">[</span><span style="color: #cc9393;">"ocaml"</span><span style="color: #eadd83;">;</span> <span style="color: #cc9393;">"pp"</span><span style="color: #eadd83;">;</span> <span style="color: #cc9393;">"use_openin"</span><span style="color: #eadd83;">]</span> <span style="color: #eadd83;">(</span>A<span style="color: #cc9393;">"pa_openin.cmo"</span><span style="color: #eadd83;">);</span>
<span class="linenr"> 7:  </span>      <span style="color: #7f9f7f;">(* </span><span style="color: #7f9f7f; font-style: italic;">Running ocamldep on ocaml code that is tagged with use_openin will require</span>
<span class="linenr"> 8:  </span><span style="color: #7f9f7f; font-style: italic;">         the cmo.  Note that you only need this declaration when the syntax extension</span>
<span class="linenr"> 9:  </span><span style="color: #7f9f7f; font-style: italic;">         is part of the  sources to be compiled with ocamlbuild. </span><span style="color: #7f9f7f;">*)</span>
<span class="linenr">10:  </span>      dep <span style="color: #eadd83;">[</span><span style="color: #cc9393;">"ocaml"</span><span style="color: #eadd83;">;</span> <span style="color: #cc9393;">"ocamldep"</span><span style="color: #eadd83;">;</span> <span style="color: #cc9393;">"use_openin"</span><span style="color: #eadd83;">]</span> <span style="color: #eadd83;">[</span><span style="color: #cc9393;">"pa_openin.cmo"</span><span style="color: #eadd83;">];</span>
<span class="linenr">11:  </span>  <span style="color: #eadd83;">|</span> _ <span style="color: #eadd83;">-&gt;</span> <span style="color: #eadd83;">()</span>
<span class="linenr">12:  </span><span style="color: #ff7f00; font-weight: bold;">end</span><span style="color: #eadd83;">;;</span>
</pre>





<pre class="example">"bar.ml": camlp4o, use_openin
&lt;foo/*.ml&gt; or &lt;baz/**/*.ml&gt;: camlp4r, use_openin
"pa_openin.ml": use_camlp4, camlp4o  
</pre>

<p>
      Here we show how to use <i>flag, dep</i>.
</p>
</li>
</ul>
<ul>
<li id="sec-1-12-2-2-3">Ejection code<br/>




<pre class="src src-tuareg"><span class="linenr"> 1:  </span><span style="color: #ff7f00; font-weight: bold;">open</span> <span style="color: #8cd0d3;">Ocamlbuild_plugin</span>
<span class="linenr"> 2:  </span><span style="color: #ff7f00; font-weight: bold;">open</span> <span style="color: #8cd0d3;">Unix</span>
<span class="linenr"> 3:  </span><span style="color: #ff7f00; font-weight: bold;">let</span> <span style="color: #dfaf8f;">version </span><span style="color: #eadd83;">=</span> <span style="color: #cc9393;">"1.4.2+dev"</span>
<span class="linenr"> 4:  </span><span style="color: #ff7f00; font-weight: bold;">let</span> <span style="color: #dfaf8f;">time </span><span style="color: #eadd83;">=</span>
<span class="linenr"> 5:  </span>  <span style="color: #ff7f00; font-weight: bold;">let</span> <span style="color: #dfaf8f;">tm </span><span style="color: #eadd83;">=</span> <span style="color: #8cd0d3;">Unix</span>.gmtime <span style="color: #eadd83;">(</span><span style="color: #8cd0d3;">Unix</span>.time <span style="color: #eadd83;">())</span> <span style="color: #ff7f00; font-weight: bold;">in</span>
<span class="linenr"> 6:  </span>  <span style="color: #8cd0d3;">Printf</span>.sprintf <span style="color: #cc9393;">"%02d/%02d/%04d %02d:%02d:%02d UTC"</span>
<span class="linenr"> 7:  </span>    <span style="color: #eadd83;">(</span>tm.tm_mon <span style="color: #eadd83;">+</span> 1<span style="color: #eadd83;">)</span> tm.tm_mday <span style="color: #eadd83;">(</span>tm.tm_year <span style="color: #eadd83;">+</span> 1900<span style="color: #eadd83;">)</span>
<span class="linenr"> 8:  </span>    tm.tm_hour tm.tm_min tm.tm_sec
<span class="linenr"> 9:  </span><span style="color: #ff7f00; font-weight: bold;">let</span> <span style="color: #8cd0d3;">make_version</span><span style="color: #dfaf8f;"> _ _ </span><span style="color: #eadd83;">=</span>
<span class="linenr">10:  </span>  <span style="color: #ff7f00; font-weight: bold;">let</span> <span style="color: #dfaf8f;">cmd </span><span style="color: #eadd83;">=</span>
<span class="linenr">11:  </span>    <span style="color: #8cd0d3;">Printf</span>.sprintf <span style="color: #cc9393;">"let version = %S\n\</span>
<span class="linenr">12:  </span><span style="color: #cc9393;">                    let compile_time = %S"</span>
<span class="linenr">13:  </span>      version time  <span style="color: #ff7f00; font-weight: bold;">in</span>
<span class="linenr">14:  </span>  <span style="color: #8fb28f;">(** Add a command *)</span>
<span class="linenr">15:  </span>  Cmd <span style="color: #eadd83;">(</span>S <span style="color: #eadd83;">[</span> A <span style="color: #cc9393;">"echo"</span><span style="color: #eadd83;">;</span> Quote <span style="color: #eadd83;">(</span>Sh cmd<span style="color: #eadd83;">);</span> Sh <span style="color: #cc9393;">"&gt;"</span><span style="color: #eadd83;">;</span> P <span style="color: #cc9393;">"version.ml"</span> <span style="color: #eadd83;">])</span>
<span class="linenr">16:  </span>
<span class="linenr">17:  </span><span style="color: #ff7f00; font-weight: bold;">let</span><span style="color: #dfaf8f;"> </span><span style="color: #eadd83;">()</span><span style="color: #dfaf8f;"> </span><span style="color: #eadd83;">=</span> dispatch <span style="color: #ff7f00; font-weight: bold;">begin</span> <span style="color: #f0dfaf; font-weight: bold;">function</span>
<span class="linenr">18:  </span> <span style="color: #dfaf8f;"> </span><span style="color: #eadd83;">|</span> After_rules <span style="color: #eadd83;">-&gt;</span>
<span class="linenr">19:  </span>      rule <span style="color: #cc9393;">"version.ml"</span> <span style="color: #eadd83;">~</span><span style="color: #dfaf8f;">prod</span><span style="color: #eadd83;">:</span> <span style="color: #cc9393;">"version.ml"</span> make_version
<span class="linenr">20:  </span>  <span style="color: #eadd83;">|</span> _ <span style="color: #eadd83;">-&gt;</span> <span style="color: #eadd83;">()</span>
<span class="linenr">21:  </span><span style="color: #ff7f00; font-weight: bold;">end</span>
</pre>


<p>
      Here we show how to build <code>version.ml</code>. When we want to build
      <code>version.ml</code> as a target, it invoke the function <code>make_version</code>
      which invokes shell to generate the file.
      It's interesting to note that <code>Ocamlbuild_plugin.command</code> is
      written using ADT
</p>



<pre class="src src-tuareg">Cmd <span style="color: #eadd83;">(</span>S<span style="color: #eadd83;">[</span>A<span style="color: #cc9393;">"echo"</span><span style="color: #eadd83;">;</span> Quote <span style="color: #eadd83;">(</span>Sh <span style="color: #cc9393;">"content"</span><span style="color: #eadd83;">);</span> Sh<span style="color: #cc9393;">"&gt;"</span><span style="color: #eadd83;">;</span> P <span style="color: #cc9393;">"version.ml"</span><span style="color: #eadd83;">]);;</span>
<span style="color: #eadd83;">-</span> <span style="color: #eadd83;">:</span> <span style="color: #8cd0d3;">Ocamlbuild_plugin.command </span><span style="color: #eadd83;">=</span>
Cmd <span style="color: #eadd83;">(</span>S <span style="color: #eadd83;">[</span>A <span style="color: #cc9393;">"echo"</span><span style="color: #eadd83;">;</span> Quote <span style="color: #eadd83;">(</span>Sh <span style="color: #cc9393;">"content"</span><span style="color: #eadd83;">);</span> Sh <span style="color: #cc9393;">"&gt;"</span><span style="color: #eadd83;">;</span> P <span style="color: #cc9393;">"version.ml"</span><span style="color: #eadd83;">])</span>
</pre>


</li>
</ul>
<ul>
<li id="sec-1-12-2-2-4">Adding Dependency<br/>




<pre class="src src-tuareg"><span class="linenr">1:  </span><span style="color: #ff7f00; font-weight: bold;">open</span> <span style="color: #8cd0d3;">Ocamlbuild_plugin</span>
<span class="linenr">2:  </span><span style="color: #ff7f00; font-weight: bold;">let</span><span style="color: #dfaf8f;"> </span><span style="color: #eadd83;">()</span><span style="color: #dfaf8f;"> </span><span style="color: #eadd83;">=</span>
<span class="linenr">3:  </span>  dispatch <span style="color: #ff7f00; font-weight: bold;">begin</span> <span style="color: #f0dfaf; font-weight: bold;">function</span>
<span class="linenr">4:  </span> <span style="color: #dfaf8f;"> </span><span style="color: #eadd83;">|</span> After_rules <span style="color: #eadd83;">-&gt;</span>
<span class="linenr">5:  </span>    dep <span style="color: #eadd83;">[</span><span style="color: #cc9393;">"myfile"</span><span style="color: #eadd83;">]</span> <span style="color: #eadd83;">[</span><span style="color: #cc9393;">"other.ml"</span><span style="color: #eadd83;">]</span>
<span class="linenr">6:  </span>  <span style="color: #eadd83;">|</span> _ <span style="color: #eadd83;">-&gt;</span> <span style="color: #eadd83;">()</span>
<span class="linenr">7:  </span>  <span style="color: #ff7f00; font-weight: bold;">end</span>   
</pre>




<p>
      Adding dependecy is useful and sometimes necessary when you
      combine other macros <code>INCLUDE</code>.
</p>
</li>
</ul>
</li>
</ul>
</div>
</div>

</div>

<div id="outline-container-1-13" class="outline-3">
<h3 id="sec-1-13">Mixing with C stubs</h3>
<div class="outline-text-3" id="text-1-13">


<p>
   Here's a very stupid way of building c stubs: tag your c code
   precious, then mv it into <code>_build</code> directory. Then link it by hand.
</p>




<pre class="example">_tags:
&lt;single_write.o&gt; : precious

Makefile:
_build/single_write.o: single_write.o
        test -d $(LIB) || mkdir $(LIB)
        cp single_write.o $(LIB)
# tag single_write.o precious
write.cma:  _build/single_write.o write.cmo
        cd $(LIB); ocamlc -custom -a -o single_write.o write.cmo
     
</pre>


</div>

<div id="outline-container-1-13-1" class="outline-4">
<h4 id="sec-1-13-1">Built in support</h4>
<div class="outline-text-4" id="text-1-13-1">

<p>    There's built in support, solution is:
</p>




<pre class="src src-tuareg">dep <span style="color: #eadd83;">[</span><span style="color: #cc9393;">"link"</span><span style="color: #eadd83;">;</span> <span style="color: #cc9393;">"ocaml"</span><span style="color: #eadd83;">;</span> <span style="color: #cc9393;">"use_plus_stubs"</span><span style="color: #eadd83;">]</span> <span style="color: #eadd83;">[</span><span style="color: #cc9393;">"plus_stubs.o"</span><span style="color: #eadd83;">];</span>
flag<span style="color: #eadd83;">[</span><span style="color: #cc9393;">"link"</span><span style="color: #eadd83;">;</span> <span style="color: #cc9393;">"ocaml"</span><span style="color: #eadd83;">;</span> <span style="color: #cc9393;">"byte"</span><span style="color: #eadd83;">]</span> <span style="color: #eadd83;">(</span>S<span style="color: #eadd83;">[</span>A<span style="color: #cc9393;">"-custom"</span><span style="color: #eadd83;">]);</span>
</pre>


<p>
    OCamlbuild can invoke <code>gcc</code> to do the building process. The tags file is
    like this
</p>




<pre class="example">&lt;plus.{byte,native}&gt; : use_plus_stubs  
</pre>



<p>
    Notice that <code>-custom</code> is only for <code>byte</code> link, native link
    will link it by default. You can also <b>enrich your runtime</b>
    without linking to each byte file everytime.
</p>
<p>
    It's convenient for example when you using llvm, you don't need to
    link into it each time.
</p>



<pre class="example">ocamlc -make-runtime -o new_ocamlrun progc.o a_c_library.a
ocamlc -o vbcname.exe -use-runtime new_ocamlrun progocaml.cmo
</pre>



<p>
    Instead of new runtime, you can also build a toplevlel linking c
    functions
</p>



<pre class="example">ocamlmktop -custom -o ftop progc.o a_c_library.a ex.ml    
</pre>


<p>
    So you see, you have 4 choices, <i>enrich your runtime</i>, <i>toplevel</i>,
    <i>bytecode</i>, <i>native code</i>.
</p>
</div>
</div>

</div>

<div id="outline-container-1-14" class="outline-3">
<h3 id="sec-1-14">Building cmi files</h3>
<div class="outline-text-3" id="text-1-14">

<p>   <i>cmi</i> file needs library path as well, when you introduce
   external dependency.
</p>



<pre class="example">&lt;ppo.{mli}&gt; : use_camlp4   
</pre>


<p>
   Tag <i>cmi</i> file <b>does not make sense</b> , tag <i>.mli</i> file instead.
   The <code>_log</code> below is a sample output.
</p>



<pre class="example"># Target: ppo.cmi, tags: { byte, compile, extension:mli, file:ppo.mli, interf, ocaml, quiet, traverse, use_camlp4 }
ocamlfind ocamlc -annot -c -I +camlp4 -o ppo.cmi ppo.mli
</pre>

</div>

</div>

<div id="outline-container-1-15" class="outline-3">
<h3 id="sec-1-15">Debugging</h3>
<div class="outline-text-3" id="text-1-15">

<p>   Pass <i>-cflags -verbose</i> and <i>-lflags -verbose</i> to
   ocamlbuild, then read the log
</p></div>
</div>
</div>
</div>

<div id="postamble">
<a href="http://validator.w3.org/check?uri=referer">Validate XHTML 1.0</a>

</div>
</body>
</html>
