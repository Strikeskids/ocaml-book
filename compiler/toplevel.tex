

\section{toplevel}


\subsection{Topmain}
The driver module for toplevel
\subsection{Opttopmain}


\subsection{Toploop}
\subsection{Opttoploop}
First environment is encoded using a Hashtbl.
\begin{ocamlcode}
(* The table of toplevel value bindings and its accessors *)
let toplevel_value_bindings =
  (Hashtbl.create 37 : (string, Obj.t) Hashtbl.t)
let getvalue name =
  try
    Hashtbl.find toplevel_value_bindings name
  with Not_found ->
    fatal_error (name ^ " unbound at toplevel")
let setvalue name v =
  Hashtbl.replace toplevel_value_bindings name v
\end{ocamlcode}

Function \verb|eval_path| will consult the environment to 
get the object.

\begin{ocamlcode}
eval_path:Path.t -> Obj.t = <fun>
\end{ocamlcode}
After that it setup the printer which is connected with genprint.

Some useful interfaces

\begin{ocamlcode}
(* Accessors for the table of toplevel value bindings.  These functions
   must appear as first and second exported functions in this module.
   (See module Translmod.) *)
val getvalue : string -> Obj.t
val setvalue : string -> Obj.t -> unit
(* Set the load paths, before running anything *)
val set_paths : unit -> unit
(* The interactive toplevel loop *)
val loop : formatter -> unit
(* Read and execute a script from the given file *)
val run_script : formatter -> string -> string array -> bool
        (* true if successful, false if error *)
(* Interface with toplevel directives *)
type directive_fun =
   | Directive_none of (unit -> unit)
   | Directive_string of (string -> unit)
   | Directive_int of (int -> unit)
   | Directive_ident of (Longident.t -> unit)
   | Directive_bool of (bool -> unit)
val directive_table : (string, directive_fun) Hashtbl.t
        (* Table of known directives, with their execution function *)
val toplevel_env : Env.t ref
        (* Typing environment for the toplevel *)
val initialize_toplevel_env : unit -> unit
        (* Initialize the typing environment for the toplevel *)
val print_exception_outcome : formatter -> exn -> unit
        (* Print an exception resulting from the evaluation of user code. *)
val execute_phrase : bool -> formatter -> Parsetree.toplevel_phrase -> bool
        (* Execute the given toplevel phrase. Return [true] if the
           phrase executed with no errors and [false] otherwise.
           First bool says whether the values and types of the results
           should be printed. Uncaught exceptions are always printed. *)
val use_file : formatter -> string -> bool
val use_silently : formatter -> string -> bool
        (* Read and execute commands from a file.
           [use_file] prints the types and values of the results.
           [use_silently] does not print them. *)
\end{ocamlcode}


\subsection{Topdirs}
\subsection{Opttopdirs}



\subsection{Topstart}
\subsection{Opttopstart}
Simply one line 
\begin{ocamlcode}
let _ = Toploop.main ()
\end{ocamlcode}


\subsection{Expunge}

\subsection{Genprintval}
\subsection{Trace}





\begin{ocamlcode}
  val run_script: Format.formatter -> string -> string array -> bool
  val getvalue: string -> Obj.t
  val directive_table:(string,directive_fun) Hashtbl.t
  val print_exception_outcome : Format.formatter -> exn -> unit 
  val execute_phrase :
  bool->formatter->Parsetree.toplevel_phrase->bool
  val use_file : Format.formatter -> string -> bool
  (** use_silently, parse_use_file *)
  val print_value : Env.t -> Obj.t -> formatter ->
  Types.type_expr ->  unit
\end{ocamlcode}
\captionof{listing}{module Toploop}

\begin{ocamlcode}
  input_name;;
  val print_out_value : (formatter -> out_value -> unit) ref ;;
  print_out_type  : (formatter -> out_type -> unit) ref ;;
  print_out_class_type : (formatter -> out_class_type -> unit) ref ;;
  print_out_module_type : (formatter -> out_module_type -> unit) ref;;
  print_out_sig_item : (formatter -> out_sig_item -> unit) ref ;;
  print_out_phrase : (formatter -> out_phrase -> unit) ref ;;
  read_interactive_input :  (string -> string -> int -> int * bool)  ref;;
  toplevel_startup_hook : (unit -> unit) ref 
\end{ocamlcode}
\caption{listing}{module Toploop configurable refs}

\begin{ocamlcode}
Toploop.run_script Format.std_formatter "test.ml" [|"ocaml"|];;
\end{ocamlcode}
\caption{listing}{Hacking Toploop sample}

You can easily update directive table according to the source code we
get. Here we get another parser, from ocaml-source \textit{parsing}
compared with camlp4.

\begin{ocamlcode}
  dir_load
  dir_use
  dir_install_printer
  dir_trace
  dir_untrace
  dir_untrace_all
  dir_quit
  dir_cd 
  load_file : Format.formatter -> string -> bool  (** using Dynlink internal*)
\end{ocamlcode}
\captionof{listing}{Module Topdirs}
We can be more \textit{flexible} without using directives using functions directly.


\subsection{Env}

  \begin{ocamlcode}
    let env = !Toploop.toplevel_env
    (* ... blabbla ...     *)
    Toploop.toplevel_env := env  
  \end{ocamlcode}
  \captionof{listing}{store toplevel env}
  
  \begin{ocamlcode}
    Toploop.initialize_toplevel_env ()  
  \end{ocamlcode}
  \captionof{listing}{Clear toplevel}


\begin{ocamlcode}
let exec_test s =
  let l = Lexing.from_string s in
  let ph = !Toploop.parse_toplevel_phrase l in
  let fmt = Format.make_formatter (fun _ _ _ -> ()) (fun _ -> ()) in
  try
    Toploop.execute_phrase false fmt ph
  with
      _ -> false
in
if not(exec_test "Topfind.reset;;") then (
  Topdirs.dir_load Format.err_formatter "/Users/bob/SourceCode/ML/godi/lib/ocaml/pkg-lib/findlib/findlib.cma";
  Topdirs.dir_load Format.err_formatter "/Users/bob/SourceCode/ML/godi/lib/ocaml/pkg-lib/findlib/findlib_top.cma";
);;
\end{ocamlcode}
\captionof{listing}{Hacking toploop sample from findlib}
    
You can refer \textit{Topfind.ml} for more. You can grep a module like
this, but now, you can also use \textit{otags}

\begin{ocamlcode}
se;;
- : ?ignore_module:bool -> (string -> bool) -> string -> string list =
se ~ignore_module:false (FILTER _*  "char" space* "->" space* "bool") "String";;
\end{ocamlcode}

\begin{ocamlcode}
Hashtbl.add
    Toploop.directive_table
    "require"
    (Toploop.Directive_string
       (fun s ->
	  protect load_deeply (Fl_split.in_words s)
       ))
;;
Hashtbl.add Toploop.directive_table "pwd"
(Toploop.Directive_none (fun _ -> 
  print_endline (Sys.getcwd ())));;
#pwd;;
\end{ocamlcode}

\subsection{directives}
\begin{bashcode}
  #directory ``_build'';;
  #diretory ``+camlp4'';;
  #load ``*.cma'';;
  #trace fib;;
  #labels false;;  # ignore labels in function types
  #print_depth n;;
  #print_length n;;
  #warnings ``warning-list'';;
\end{bashcode}  



%%% Local Variables: 
%%% mode: latex
%%% TeX-master: "master"
%%% End: 
