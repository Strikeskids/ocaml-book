<?xml version="1.0" encoding="iso-8859-1"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
               "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<title>compiler</title>
<meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1"/>
<meta name="title" content="compiler"/>
<meta name="generator" content="Org-mode"/>
<meta name="generated" content="2012-09-06 14:34:40 EDT"/>
<meta name="author" content="Hongbo Zhang"/>
<meta name="description" content=""/>
<meta name="keywords" content=""/>
<style type="text/css">
 <!--/*--><![CDATA[/*><!--*/
  html { font-family: Times, serif; font-size: 12pt; }
  .title  { text-align: center; }
  .todo   { color: red; }
  .done   { color: green; }
  .tag    { background-color: #add8e6; font-weight:normal }
  .target { }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .right  {margin-left:auto; margin-right:0px;  text-align:right;}
  .left   {margin-left:0px;  margin-right:auto; text-align:left;}
  .center {margin-left:auto; margin-right:auto; text-align:center;}
  p.verse { margin-left: 3% }
  pre {
	border: 1pt solid #AEBDCC;
	background-color: #F3F5F7;
	padding: 5pt;
	font-family: courier, monospace;
        font-size: 90%;
        overflow:auto;
  }
  table { border-collapse: collapse; }
  td, th { vertical-align: top;  }
  th.right  { text-align:center;  }
  th.left   { text-align:center;   }
  th.center { text-align:center; }
  td.right  { text-align:right;  }
  td.left   { text-align:left;   }
  td.center { text-align:center; }
  dt { font-weight: bold; }
  div.figure { padding: 0.5em; }
  div.figure p { text-align: center; }
  div.inlinetask {
    padding:10px;
    border:2px solid gray;
    margin:10px;
    background: #ffffcc;
  }
  textarea { overflow-x: auto; }
  .linenr { font-size:smaller }
  .code-highlighted {background-color:#ffff00;}
  .org-info-js_info-navigation { border-style:none; }
  #org-info-js_console-label { font-size:10px; font-weight:bold;
                               white-space:nowrap; }
  .org-info-js_search-highlight {background-color:#ffff00; color:#000000;
                                 font-weight:bold; }
  /*]]>*/-->
</style>
<link rel="stylesheet" type="text/css" href="../css/style.css">
<script type="text/javascript">
<!--/*--><![CDATA[/*><!--*/
 function CodeHighlightOn(elem, id)
 {
   var target = document.getElementById(id);
   if(null != target) {
     elem.cacheClassElem = elem.className;
     elem.cacheClassTarget = target.className;
     target.className = "code-highlighted";
     elem.className   = "code-highlighted";
   }
 }
 function CodeHighlightOff(elem, id)
 {
   var target = document.getElementById(id);
   if(elem.cacheClassElem)
     elem.className = elem.cacheClassElem;
   if(elem.cacheClassTarget)
     target.className = elem.cacheClassTarget;
 }
/*]]>*///-->
</script>

</head>
<body>

<div id="preamble">

</div>

<div id="content">
<h1 class="title">compiler</h1>







<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#sec-1">libraries</a>
<ul>
<li><a href="#sec-1-1">parsing</a>
<ul>
<li><a href="#sec-1-1-1">parsing:parsetree</a></li>
<li><a href="#sec-1-1-2">parsing:parser.mly</a></li>
<li><a href="#sec-1-1-3">parsing:parser</a></li>
<li><a href="#sec-1-1-4">parsing:parse</a></li>
<li><a href="#sec-1-1-5">parsing:printast</a></li>
<li><a href="#sec-1-1-6">parsing:pprint</a></li>
<li><a href="#sec-1-1-7">parsing:longident</a></li>
<li><a href="#sec-1-1-8">parsing:asttypes</a></li>
</ul>
</li>
<li><a href="#sec-1-2">typing</a>
<ul>
<li><a href="#sec-1-2-1">typing:env</a></li>
<li><a href="#sec-1-2-2">typing:ident</a></li>
<li><a href="#sec-1-2-3">typing:path</a></li>
<li><a href="#sec-1-2-4">typing:mtype</a></li>
<li><a href="#sec-1-2-5">typing:btype</a></li>
<li><a href="#sec-1-2-6">typing:typetexp</a></li>
<li><a href="#sec-1-2-7">typing:typecore</a></li>
<li><a href="#sec-1-2-8">typing:includemod</a></li>
<li><a href="#sec-1-2-9">typing:types</a></li>
<li><a href="#sec-1-2-10">typing:typedtree</a></li>
<li><a href="#sec-1-2-11">typing:outcometree</a></li>
<li><a href="#sec-1-2-12">typing:printtyp</a></li>
<li><a href="#sec-1-2-13">typing:cmi_format</a></li>
<li><a href="#sec-1-2-14">typing:ctype</a></li>
<li><a href="#sec-1-2-15">typing:typemod</a></li>
<li><a href="#sec-1-2-16">typing:predef</a></li>
<li><a href="#sec-1-2-17">typing:oprint</a></li>
<li><a href="#sec-1-2-18">typing:cmt_format</a></li>
</ul>
</li>
<li><a href="#sec-1-3">utils</a>
<ul>
<li><a href="#sec-1-3-1">utils:misc</a></li>
<li><a href="#sec-1-3-2">utils:clflags</a></li>
<li><a href="#sec-1-3-3">utils:config</a></li>
<li><a href="#sec-1-3-4">utils:ccomp</a></li>
<li><a href="#sec-1-3-5">utils:consistbl</a></li>
<li><a href="#sec-1-3-6">utils:tbl</a></li>
<li><a href="#sec-1-3-7">utils:terminfo</a></li>
<li><a href="#sec-1-3-8">utils:warnings</a></li>
</ul>
</li>
<li><a href="#sec-1-4">bytecomp</a>
<ul>
<li><a href="#sec-1-4-1">bytecomp:symtable</a></li>
<li><a href="#sec-1-4-2">bytecomp:translmod</a></li>
<li><a href="#sec-1-4-3">bytecomp:simplif</a></li>
<li><a href="#sec-1-4-4">bytecomp:bytegen</a></li>
<li><a href="#sec-1-4-5">bytecomp:emitcode</a></li>
<li><a href="#sec-1-4-6">bytecomp:meta</a></li>
</ul>
</li>
<li><a href="#sec-1-5">driver</a>
<ul>
<li><a href="#sec-1-5-1">driver:main</a></li>
<li><a href="#sec-1-5-2">driver:compile</a></li>
<li><a href="#sec-1-5-3">driver:main_args</a></li>
</ul>
</li>
<li><a href="#sec-1-6">toplevel</a>
<ul>
<li><a href="#sec-1-6-1">toplevel:topmain</a></li>
<li><a href="#sec-1-6-2">toplevel:toploop</a></li>
<li><a href="#sec-1-6-3">toplevel:genprintval</a></li>
</ul>
</li>
<li><a href="#sec-1-7">pipeline</a></li>
</ul>
</li>
</ul>
</div>
</div>

<div id="outline-container-1" class="outline-2">
<h2 id="sec-1">libraries</h2>
<div class="outline-text-2" id="text-1">






<pre class="example">ocamlmktop -custom -o oraml -I +camlp4 dynlink.cma camlp4rf.cma str.cma bigarray.cma unix.cma nums.cma

</pre>








<pre class="example">ocamlobjinfo /Users/bobzhang1988/ocaml/lib/ocaml/unix.cma | grep Unit
Unit name: Unix
Unit name: UnixLabels 
</pre>



<pre class="example">ocamlobjinfo /Users/bobzhang1988/ocaml/lib/ocaml/str.cma | grep Unit
Unit name: Str
</pre>



<pre class="example">camlobjinfo /Users/bobzhang1988/ocaml/lib/ocaml/bigarray.cma | grep Unit
Unit name: Bigarray
</pre>



<pre class="example">ocamlobjinfo /Users/bobzhang1988/ocaml/lib/ocaml/nums.cma | grep Unit
Unit name: Int_misc
Unit name: Nat
Unit name: Big_int
Unit name: Arith_flags
Unit name: Ratio
Unit name: Num
Unit name: Arith_status
</pre>



<pre class="example">ocamlobjinfo /Users/bobzhang1988/ocaml/lib/ocaml/camlp4/camlp4rf.cma | grep Unit 
Unit name: Camlp4_import
Unit name: Camlp4_config
Unit name: Camlp4
Unit name: Camlp4OCamlRevisedParser
Unit name: Camlp4QuotationCommon
Unit name: Camlp4QuotationExpander
Unit name: Camlp4OCamlRevisedParserParser
Unit name: Camlp4GrammarParser
Unit name: Camlp4MacroParser
Unit name: Camlp4ListComprehension
Unit name: Rprint
Unit name: Top
</pre>



</div>

<div id="outline-container-1-1" class="outline-3">
<h3 id="sec-1-1">parsing</h3>
<div class="outline-text-3" id="text-1-1">



</div>

<div id="outline-container-1-1-1" class="outline-4">
<h4 id="sec-1-1-1"><a href="file:///Users/bobzhang1988/ocaml/parsing/parsetree.mli">parsing:parsetree</a></h4>
<div class="outline-text-4" id="text-1-1-1">




<pre class="src src-ocaml"><span style="color: #8cd0d3;">Parse</span>.implementation <span style="color: #eadd83;">(</span><span style="color: #8cd0d3;">Lexing</span>.from_string <span style="color: #cc9393;">"let a =  M.(b + 3) "</span><span style="color: #eadd83;">);;</span>
</pre>

<p>
    <code>Clflags.dump_parsetree</code> in the toplevel can show you the
    parsetree output.
</p>
</div>

</div>

<div id="outline-container-1-1-2" class="outline-4">
<h4 id="sec-1-1-2"><a href="file:///Users/bobzhang1988/ocaml/parsing/parser.mly">parsing:parser.mly</a></h4>
<div class="outline-text-4" id="text-1-1-2">


<p>
    There's some special treatment for option type
</p>



<pre class="src src-ocaml"><span style="color: #ff7f00; font-weight: bold;">let</span> <span style="color: #8cd0d3;">mkoption</span><span style="color: #dfaf8f;"> d </span><span style="color: #eadd83;">=</span>
  <span style="color: #eadd83;">{</span> ptyp_desc <span style="color: #eadd83;">=</span> Ptyp_constr<span style="color: #eadd83;">(</span>mknoloc <span style="color: #eadd83;">(</span>Ldot <span style="color: #eadd83;">(</span>Lident <span style="color: #cc9393;">"*predef*"</span><span style="color: #eadd83;">,</span> <span style="color: #cc9393;">"option"</span><span style="color: #eadd83;">)),</span> <span style="color: #eadd83;">[</span>d<span style="color: #eadd83;">]);</span>
    ptyp_loc <span style="color: #eadd83;">=</span> d.ptyp_loc<span style="color: #eadd83;">}</span>
</pre>






<pre class="src src-ocaml">implementation_of_string <span style="color: #cc9393;">"let a ?(u=3) b  = b + 1"</span> <span style="color: #eadd83;">|&gt;</span> <span style="color: #8cd0d3;">Pprintast</span>.print_structure std_formatter<span style="color: #eadd83;">;;</span>
<span style="color: #ff7f00; font-weight: bold;">let</span> <span style="color: #8cd0d3;">a</span><span style="color: #dfaf8f;"> </span><span style="color: #eadd83;">=</span> <span style="color: #f0dfaf; font-weight: bold;">fun</span><span style="color: #dfaf8f;"> </span><span style="color: #eadd83;">?(</span>u <span style="color: #eadd83;">=</span> 3<span style="color: #eadd83;">)</span> <span style="color: #eadd83;">-&gt;</span> <span style="color: #f0dfaf; font-weight: bold;">fun</span> <span style="color: #dfaf8f;">b </span><span style="color: #eadd83;">-&gt;</span> <span style="color: #eadd83;">(</span>b <span style="color: #eadd83;">+</span> 1<span style="color: #eadd83;">)</span>
<span style="color: #eadd83;">-</span> <span style="color: #eadd83;">:</span> <span style="color: #8cd0d3;">unit </span><span style="color: #eadd83;">=</span> <span style="color: #eadd83;">()</span>
</pre>



<pre class="src src-tuareg">implementation_of_string <span style="color: #cc9393;">"let a ?(u=3) b  = b + 1"</span><span style="color: #eadd83;">;;</span>
<span style="color: #eadd83;">-</span> <span style="color: #eadd83;">:</span> <span style="color: #8cd0d3;">Parsetree.structure </span><span style="color: #eadd83;">=</span>
<span style="color: #eadd83;">[{</span><span style="color: #8cd0d3;">Parsetree</span>.pstr_desc <span style="color: #eadd83;">=</span>
   <span style="color: #8cd0d3;">Parsetree</span>.Pstr_value <span style="color: #eadd83;">(</span><span style="color: #8cd0d3;">Asttypes</span>.Nonrecursive<span style="color: #eadd83;">,</span>
    <span style="color: #eadd83;">[({</span><span style="color: #8cd0d3;">Parsetree</span>.ppat_desc <span style="color: #eadd83;">=</span> <span style="color: #8cd0d3;">Parsetree</span>.Ppat_var <span style="color: #eadd83;">{</span><span style="color: #8cd0d3;">Asttypes</span>.txt <span style="color: #eadd83;">=</span> <span style="color: #cc9393;">"a"</span><span style="color: #eadd83;">;</span> loc <span style="color: #eadd83;">=</span> <span style="color: #eadd83;">};</span>
       ppat_loc <span style="color: #eadd83;">=</span> <span style="color: #eadd83;">},</span>
      <span style="color: #eadd83;">{</span><span style="color: #8cd0d3;">Parsetree</span>.pexp_desc <span style="color: #eadd83;">=</span>
        <span style="color: #8cd0d3;">Parsetree</span>.Pexp_function <span style="color: #eadd83;">(</span><span style="color: #cc9393;">"?u"</span><span style="color: #eadd83;">,</span>
         Some
          <span style="color: #eadd83;">{</span><span style="color: #8cd0d3;">Parsetree</span>.pexp_desc <span style="color: #eadd83;">=</span>
            <span style="color: #8cd0d3;">Parsetree</span>.Pexp_constant <span style="color: #eadd83;">(</span><span style="color: #8cd0d3;">Asttypes</span>.Const_int 3<span style="color: #eadd83;">);</span>
           pexp_loc <span style="color: #eadd83;">=</span> <span style="color: #eadd83;">},</span>
         <span style="color: #eadd83;">[({</span><span style="color: #8cd0d3;">Parsetree</span>.ppat_desc <span style="color: #eadd83;">=</span>
             <span style="color: #8cd0d3;">Parsetree</span>.Ppat_var <span style="color: #eadd83;">{</span><span style="color: #8cd0d3;">Asttypes</span>.txt <span style="color: #eadd83;">=</span> <span style="color: #cc9393;">"u"</span><span style="color: #eadd83;">;</span> loc <span style="color: #eadd83;">=</span> <span style="color: #eadd83;">};</span>
            ppat_loc <span style="color: #eadd83;">=</span> <span style="color: #eadd83;">},</span>
           <span style="color: #eadd83;">{</span><span style="color: #8cd0d3;">Parsetree</span>.pexp_desc <span style="color: #eadd83;">=</span>
             <span style="color: #8cd0d3;">Parsetree</span>.Pexp_function <span style="color: #eadd83;">(</span><span style="color: #cc9393;">""</span><span style="color: #eadd83;">,</span> None<span style="color: #eadd83;">,</span>
              <span style="color: #eadd83;">[({</span><span style="color: #8cd0d3;">Parsetree</span>.ppat_desc <span style="color: #eadd83;">=</span>
                  <span style="color: #8cd0d3;">Parsetree</span>.Ppat_var <span style="color: #eadd83;">{</span><span style="color: #8cd0d3;">Asttypes</span>.txt <span style="color: #eadd83;">=</span> <span style="color: #cc9393;">"b"</span><span style="color: #eadd83;">;</span> loc <span style="color: #eadd83;">=</span> <span style="color: #eadd83;">};</span>
                 ppat_loc <span style="color: #eadd83;">=</span> <span style="color: #eadd83;">},</span>
                <span style="color: #eadd83;">{</span><span style="color: #8cd0d3;">Parsetree</span>.pexp_desc <span style="color: #eadd83;">=</span>
                  <span style="color: #8cd0d3;">Parsetree</span>.Pexp_apply
                   <span style="color: #eadd83;">({</span><span style="color: #8cd0d3;">Parsetree</span>.pexp_desc <span style="color: #eadd83;">=</span>
                      <span style="color: #8cd0d3;">Parsetree</span>.Pexp_ident
                       <span style="color: #eadd83;">{</span><span style="color: #8cd0d3;">Asttypes</span>.txt <span style="color: #eadd83;">=</span> <span style="color: #8cd0d3;">Longident</span>.Lident <span style="color: #cc9393;">"+"</span><span style="color: #eadd83;">;</span> loc <span style="color: #eadd83;">=</span> <span style="color: #eadd83;">};</span>
                     pexp_loc <span style="color: #eadd83;">=</span> <span style="color: #eadd83;">},</span>
                   <span style="color: #eadd83;">[(</span><span style="color: #cc9393;">""</span><span style="color: #eadd83;">,</span>
                     <span style="color: #eadd83;">{</span><span style="color: #8cd0d3;">Parsetree</span>.pexp_desc <span style="color: #eadd83;">=</span>
                       <span style="color: #8cd0d3;">Parsetree</span>.Pexp_ident
                        <span style="color: #eadd83;">{</span><span style="color: #8cd0d3;">Asttypes</span>.txt <span style="color: #eadd83;">=</span> <span style="color: #8cd0d3;">Longident</span>.Lident <span style="color: #cc9393;">"b"</span><span style="color: #eadd83;">;</span> loc <span style="color: #eadd83;">=</span> <span style="color: #eadd83;">};</span>
                      pexp_loc <span style="color: #eadd83;">=</span> <span style="color: #eadd83;">});</span>
                    <span style="color: #eadd83;">(</span><span style="color: #cc9393;">""</span><span style="color: #eadd83;">,</span>
                     <span style="color: #eadd83;">{</span><span style="color: #8cd0d3;">Parsetree</span>.pexp_desc <span style="color: #eadd83;">=</span>
                       <span style="color: #8cd0d3;">Parsetree</span>.Pexp_constant <span style="color: #eadd83;">(</span><span style="color: #8cd0d3;">Asttypes</span>.Const_int 1<span style="color: #eadd83;">);</span>
                      pexp_loc <span style="color: #eadd83;">=</span> <span style="color: #eadd83;">})]);</span>
                 pexp_loc <span style="color: #eadd83;">=</span> <span style="color: #eadd83;">})]);</span>
            pexp_loc <span style="color: #eadd83;">=</span> <span style="color: #eadd83;">})]);</span>
       pexp_loc <span style="color: #eadd83;">=</span> <span style="color: #eadd83;">})]);</span>
  pstr_loc <span style="color: #eadd83;">=</span> <span style="color: #eadd83;">}]</span>
</pre>

</div>

</div>

<div id="outline-container-1-1-3" class="outline-4">
<h4 id="sec-1-1-3"><a href="file:///Users/bobzhang1988/ocaml/parsing/parser.ml">parsing:parser</a></h4>
<div class="outline-text-4" id="text-1-1-3">

</div>

</div>

<div id="outline-container-1-1-4" class="outline-4">
<h4 id="sec-1-1-4"><a href="file:///Users/bobzhang1988/ocaml/parsing/parse.ml">parsing:parse</a></h4>
<div class="outline-text-4" id="text-1-1-4">

<p>    A wrapper of module <code>Parser</code>
</p></div>

</div>

<div id="outline-container-1-1-5" class="outline-4">
<h4 id="sec-1-1-5"><a href="file:///Users/bobzhang1988/ocaml/parsing/printast.ml">parsing:printast</a></h4>
<div class="outline-text-4" id="text-1-1-5">

<p>    Textual dumper for OCaml Parsetree
</p></div>

</div>

<div id="outline-container-1-1-6" class="outline-4">
<h4 id="sec-1-1-6"><a href="file:///Users/bobzhang1988/camlp4/src/Pprintast.ml">parsing:pprint</a></h4>
<div class="outline-text-4" id="text-1-1-6">


<p>    
    Write a pretty printer for the parsetree will help us understand
    parsetree much better.
    Some interesting functions
</p>


<pre class="src src-ocaml"><span style="color: #ff7f00; font-weight: bold;">val</span> <span style="color: #dfaf8f;">fmt_longident </span><span style="color: #eadd83;">:</span> <span style="color: #8cd0d3;">Format.formatter </span><span style="color: #eadd83;">-&gt;</span><span style="color: #8cd0d3;"> Longident.t Location.loc </span><span style="color: #eadd83;">-&gt;</span><span style="color: #8cd0d3;"> unit</span>
</pre>

<ul>
<li id="sec-1-1-6-1">understand each branch<br/>
<ul>
<li id="sec-1-1-6-1-1">signature_item_desc<br/>
<ul>
<li>Psig_value
        <code>Psig_value of string loc * value_description</code>
        In <code>asttypes.ml</code> there's type definition for <code>loc</code>




<pre class="src src-tuareg"><span style="color: #ff7f00; font-weight: bold;">type</span> <span style="color: #eadd83;">'</span><span style="color: #8cd0d3;">a loc </span><span style="color: #eadd83;">=</span> <span style="color: #eadd83;">'</span>a <span style="color: #8cd0d3;">Location</span>.loc <span style="color: #eadd83;">=</span> <span style="color: #eadd83;">{</span>
  <span style="color: #dfaf8f;">txt</span> <span style="color: #eadd83;">:</span> <span style="color: #eadd83;">'</span><span style="color: #8cd0d3;">a</span><span style="color: #eadd83;">;</span>
  <span style="color: #dfaf8f;">loc</span> <span style="color: #eadd83;">:</span> <span style="color: #8cd0d3;">Location.t</span><span style="color: #eadd83;">;</span>
<span style="color: #eadd83;">}</span>
</pre>


<p>
        So, it is pretty easy to understand the first field, we have a
        simple example here:
</p>



<pre class="src src-tuareg">interface_of_string <span style="color: #cc9393;">"val m: int "</span> <span style="color: #eadd83;">;;</span>
<span style="color: #eadd83;">-</span> <span style="color: #eadd83;">:</span> <span style="color: #8cd0d3;">Parsetree.signature </span><span style="color: #eadd83;">=</span>
<span style="color: #eadd83;">[{</span><span style="color: #8cd0d3;">Parsetree</span>.psig_desc <span style="color: #eadd83;">=</span>
   <span style="color: #8cd0d3;">Parsetree</span>.Psig_value <span style="color: #eadd83;">({</span><span style="color: #8cd0d3;">Asttypes</span>.txt <span style="color: #eadd83;">=</span> <span style="color: #cc9393;">"m"</span><span style="color: #eadd83;">;</span> loc <span style="color: #eadd83;">=</span> <span style="color: #eadd83;">},</span>
    <span style="color: #eadd83;">{</span><span style="color: #8cd0d3;">Parsetree</span>.pval_type <span style="color: #eadd83;">=</span>
      <span style="color: #eadd83;">{</span><span style="color: #8cd0d3;">Parsetree</span>.ptyp_desc <span style="color: #eadd83;">=</span>
        <span style="color: #8cd0d3;">Parsetree</span>.Ptyp_constr
         <span style="color: #eadd83;">({</span><span style="color: #8cd0d3;">Asttypes</span>.txt <span style="color: #eadd83;">=</span> <span style="color: #8cd0d3;">Longident</span>.Lident <span style="color: #cc9393;">"int"</span><span style="color: #eadd83;">;</span> loc <span style="color: #eadd83;">=</span> <span style="color: #eadd83;">},</span> <span style="color: #eadd83;">[]);</span>
       ptyp_loc <span style="color: #eadd83;">=</span> <span style="color: #eadd83;">};</span>
     pval_prim <span style="color: #eadd83;">=</span> <span style="color: #eadd83;">[];</span> pval_loc <span style="color: #eadd83;">=</span> <span style="color: #eadd83;">});</span>
  psig_loc <span style="color: #eadd83;">=</span> <span style="color: #eadd83;">}]</span>
</pre>


<p>        
        The printer is defined this way:
</p>



<pre class="src src-tuareg"><span class="linenr"> 1:  </span><span style="color: #eadd83;">|</span> Psig_value <span style="color: #eadd83;">(</span>s<span style="color: #eadd83;">,</span> vd<span style="color: #eadd83;">)</span> <span style="color: #eadd83;">-&gt;</span>
<span class="linenr"> 2:  </span>  <span style="color: #ff7f00; font-weight: bold;">let</span> <span style="color: #dfaf8f;">intro </span><span style="color: #eadd83;">=</span> <span style="color: #f0dfaf; font-weight: bold;">if</span> vd.pval_prim <span style="color: #eadd83;">=</span> <span style="color: #eadd83;">[]</span> <span style="color: #f0dfaf; font-weight: bold;">then</span> <span style="color: #cc9393;">"val"</span> <span style="color: #f0dfaf; font-weight: bold;">else</span> <span style="color: #cc9393;">"external"</span> <span style="color: #ff7f00; font-weight: bold;">in</span>
<span class="linenr"> 3:  </span>  pp_open_hovbox ppf indent <span style="color: #eadd83;">;</span>
<span class="linenr"> 4:  </span>  <span style="color: #f0dfaf; font-weight: bold;">if</span> <span style="color: #eadd83;">(</span>is_infix <span style="color: #eadd83;">(</span>fixity_of_string s.txt<span style="color: #eadd83;">))</span>
<span class="linenr"> 5:  </span>    <span style="color: #eadd83;">||</span> <span style="color: #8cd0d3;">List</span>.mem s.txt.<span style="color: #eadd83;">[</span>0<span style="color: #eadd83;">]</span> prefix_symbols <span style="color: #f0dfaf; font-weight: bold;">then</span>
<span class="linenr"> 6:  </span>    fprintf ppf <span style="color: #cc9393;">"%s ( %s ) :@ "</span>
<span class="linenr"> 7:  </span>      intro s.txt                <span style="color: #7f9f7f;">(* </span><span style="color: #7f9f7f; font-style: italic;">OXX done </span><span style="color: #7f9f7f;">*)</span>
<span class="linenr"> 8:  </span>  <span style="color: #f0dfaf; font-weight: bold;">else</span>
<span class="linenr"> 9:  </span>    fprintf ppf <span style="color: #cc9393;">"%s %s :@ "</span> intro s.txt<span style="color: #eadd83;">;</span>
<span class="linenr">10:  </span>  value_description ppf vd<span style="color: #eadd83;">;</span>
<span class="linenr">11:  </span>  pp_close_box ppf <span style="color: #eadd83;">()</span> <span style="color: #eadd83;">;</span>
</pre>

</li>
</ul>


</li>
</ul>
<ul>
<li id="sec-1-1-6-1-2">value_description<br/>





<pre class="src src-tuareg"><span style="color: #ff7f00; font-weight: bold;">and</span> <span style="color: #dfaf8f;">value_description </span><span style="color: #eadd83;">=</span> <span style="color: #eadd83;">{</span>
  <span style="color: #dfaf8f;">pval_type</span><span style="color: #eadd83;">:</span> <span style="color: #8cd0d3;">core_type</span><span style="color: #eadd83;">;</span>
  <span style="color: #dfaf8f;">pval_prim</span><span style="color: #eadd83;">:</span> <span style="color: #8cd0d3;">string list</span><span style="color: #eadd83;">;</span>
  <span style="color: #dfaf8f;">pval_loc</span> <span style="color: #eadd83;">:</span> <span style="color: #8cd0d3;">Location.t</span>
<span style="color: #eadd83;">}</span>
</pre>


<p>
      <code>pval_prim</code> describes whether it's external c-bindings or not. 
</p>

</li>
</ul>
<ul>
<li id="sec-1-1-6-1-3">core_type<br/>




<pre class="src src-tuareg"><span class="linenr">1:  </span><span style="color: #ff7f00; font-weight: bold;">type</span> <span style="color: #8cd0d3;">core_type </span><span style="color: #eadd83;">=</span>
<span class="linenr">2:  </span>  <span style="color: #eadd83;">{</span> <span style="color: #dfaf8f;">ptyp_desc</span><span style="color: #eadd83;">:</span> <span style="color: #8cd0d3;">core_type_desc</span><span style="color: #eadd83;">;</span>
<span class="linenr">3:  </span>    <span style="color: #dfaf8f;">ptyp_loc</span><span style="color: #eadd83;">:</span> <span style="color: #8cd0d3;">Location.t </span><span style="color: #eadd83;">}</span>     
</pre>

</li>
</ul>
<ul>
<li id="sec-1-1-6-1-4">core_type_desc<br/>




<pre class="src src-tuareg"><span class="linenr"> 1:  </span><span style="color: #ff7f00; font-weight: bold;">and</span> <span style="color: #dfaf8f;">core_type_desc </span><span style="color: #eadd83;">=</span>
<span class="linenr"> 2:  </span>  Ptyp_any
<span class="linenr"> 3:  </span><span style="color: #eadd83;">|</span> Ptyp_var <span style="color: #f0dfaf; font-weight: bold;">of</span> string
<span class="linenr"> 4:  </span><span style="color: #eadd83;">|</span> Ptyp_arrow <span style="color: #f0dfaf; font-weight: bold;">of</span> label <span style="color: #eadd83;">*</span> core_type <span style="color: #eadd83;">*</span> core_type
<span class="linenr"> 5:  </span><span style="color: #eadd83;">|</span> Ptyp_tuple <span style="color: #f0dfaf; font-weight: bold;">of</span> core_type list
<span class="linenr"> 6:  </span><span style="color: #eadd83;">|</span> Ptyp_constr <span style="color: #f0dfaf; font-weight: bold;">of</span> <span style="color: #8cd0d3;">Longident</span>.t loc <span style="color: #eadd83;">*</span> core_type list
<span class="linenr"> 7:  </span><span style="color: #eadd83;">|</span> Ptyp_object <span style="color: #f0dfaf; font-weight: bold;">of</span> core_field_type list
<span class="linenr"> 8:  </span><span style="color: #eadd83;">|</span> Ptyp_class <span style="color: #f0dfaf; font-weight: bold;">of</span> <span style="color: #8cd0d3;">Longident</span>.t loc <span style="color: #eadd83;">*</span> core_type list <span style="color: #eadd83;">*</span> label list
<span class="linenr"> 9:  </span><span style="color: #eadd83;">|</span> Ptyp_alias <span style="color: #f0dfaf; font-weight: bold;">of</span> core_type <span style="color: #eadd83;">*</span> string
<span class="linenr">10:  </span><span style="color: #eadd83;">|</span> Ptyp_variant <span style="color: #f0dfaf; font-weight: bold;">of</span> row_field list <span style="color: #eadd83;">*</span> bool <span style="color: #eadd83;">*</span> label list option
<span class="linenr">11:  </span><span style="color: #eadd83;">|</span> Ptyp_poly <span style="color: #f0dfaf; font-weight: bold;">of</span> string list <span style="color: #eadd83;">*</span> core_type
<span class="linenr">12:  </span><span style="color: #eadd83;">|</span> Ptyp_package <span style="color: #f0dfaf; font-weight: bold;">of</span> package_type
</pre>


<ul>
<li>Ptyp_constr
</li>
<li>Ptyp_var 




<pre class="src src-tuareg"><span style="color: #eadd83;">{</span>ptyp_desc <span style="color: #eadd83;">=</span>
    Ptyp_constr
      <span style="color: #eadd83;">({</span><span style="color: #8cd0d3;">Asttypes</span>.txt <span style="color: #eadd83;">=</span>
          <span style="color: #8cd0d3;">Longident</span>.Ldot <span style="color: #eadd83;">(</span><span style="color: #8cd0d3;">Longident</span>.Lident <span style="color: #cc9393;">"M"</span><span style="color: #eadd83;">,</span> <span style="color: #cc9393;">"option"</span><span style="color: #eadd83;">);</span>
        loc <span style="color: #eadd83;">=</span> <span style="color: #eadd83;">},</span>
       <span style="color: #eadd83;">[{</span>ptyp_desc <span style="color: #eadd83;">=</span> Ptyp_var <span style="color: #cc9393;">"a"</span><span style="color: #eadd83;">;</span> ptyp_loc <span style="color: #eadd83;">=</span> <span style="color: #eadd83;">}]);</span>
 ptyp_loc <span style="color: #eadd83;">=</span> <span style="color: #eadd83;">}</span>       
</pre>

</li>
</ul>


</li>
</ul>
<ul>
<li id="sec-1-1-6-1-5">structure<br/>



<pre class="src src-tuareg"><span style="color: #ff7f00; font-weight: bold;">and</span> <span style="color: #dfaf8f;">structure </span><span style="color: #eadd83;">=</span> structure_item list
</pre>


</li>
</ul>
<ul>
<li id="sec-1-1-6-1-6">structure_item<br/>





<pre class="src src-tuareg"><span style="color: #ff7f00; font-weight: bold;">and</span> <span style="color: #dfaf8f;">structure_item </span><span style="color: #eadd83;">={</span>
         <span style="color: #dfaf8f;">pstr_desc</span><span style="color: #eadd83;">:</span> <span style="color: #8cd0d3;">structure_item_desc</span><span style="color: #eadd83;">;</span>
         <span style="color: #dfaf8f;">pstr_loc</span><span style="color: #eadd83;">:</span> <span style="color: #8cd0d3;">Location.t</span>
       <span style="color: #eadd83;">}</span>
</pre>


</li>
</ul>
<ul>
<li id="sec-1-1-6-1-7">structure_item_desc<br/>



<pre class="src src-tuareg"><span style="color: #ff7f00; font-weight: bold;">and</span> <span style="color: #dfaf8f;">structure_item_desc </span><span style="color: #eadd83;">=</span>
    Pstr_eval <span style="color: #f0dfaf; font-weight: bold;">of</span> expression
  <span style="color: #eadd83;">|</span> Pstr_value <span style="color: #f0dfaf; font-weight: bold;">of</span> rec_flag <span style="color: #eadd83;">*</span> <span style="color: #eadd83;">(</span>pattern <span style="color: #eadd83;">*</span> expression<span style="color: #eadd83;">)</span> list
  <span style="color: #eadd83;">|</span> Pstr_primitive <span style="color: #f0dfaf; font-weight: bold;">of</span> string loc <span style="color: #eadd83;">*</span> value_description
  <span style="color: #eadd83;">|</span> Pstr_type <span style="color: #f0dfaf; font-weight: bold;">of</span> <span style="color: #eadd83;">(</span>string loc <span style="color: #eadd83;">*</span> type_declaration<span style="color: #eadd83;">)</span> list
  <span style="color: #eadd83;">|</span> Pstr_exception <span style="color: #f0dfaf; font-weight: bold;">of</span> string loc <span style="color: #eadd83;">*</span> exception_declaration
  <span style="color: #eadd83;">|</span> Pstr_exn_rebind <span style="color: #f0dfaf; font-weight: bold;">of</span> string loc <span style="color: #eadd83;">*</span> <span style="color: #8cd0d3;">Longident</span>.t loc
  <span style="color: #eadd83;">|</span> Pstr_module <span style="color: #f0dfaf; font-weight: bold;">of</span> string loc <span style="color: #eadd83;">*</span> module_expr
  <span style="color: #eadd83;">|</span> Pstr_recmodule <span style="color: #f0dfaf; font-weight: bold;">of</span> <span style="color: #eadd83;">(</span>string loc <span style="color: #eadd83;">*</span> module_type <span style="color: #eadd83;">*</span> module_expr<span style="color: #eadd83;">)</span> list
  <span style="color: #eadd83;">|</span> Pstr_modtype <span style="color: #f0dfaf; font-weight: bold;">of</span> string loc <span style="color: #eadd83;">*</span> module_type
  <span style="color: #eadd83;">|</span> Pstr_open <span style="color: #f0dfaf; font-weight: bold;">of</span> <span style="color: #8cd0d3;">Longident</span>.t loc
  <span style="color: #eadd83;">|</span> Pstr_class <span style="color: #f0dfaf; font-weight: bold;">of</span> class_declaration list
  <span style="color: #eadd83;">|</span> Pstr_class_type <span style="color: #f0dfaf; font-weight: bold;">of</span> class_type_declaration list
  <span style="color: #eadd83;">|</span> Pstr_include <span style="color: #f0dfaf; font-weight: bold;">of</span> module_expr
</pre>

<ul>
<li>Pstr_module of string loc * module_expr



<pre class="src src-tuareg"><span style="color: #ff7f00; font-weight: bold;">module</span> <span style="color: #8cd0d3;">C </span><span style="color: #eadd83;">=</span> <span style="color: #eadd83;">...</span>
</pre>

</li>
<li>Pstr_modtype of string loc * module_type 



<pre class="src src-tuareg"><span style="color: #ff7f00; font-weight: bold;">module</span> <span style="color: #ff7f00; font-weight: bold;">type</span> <span style="color: #8cd0d3;">S </span><span style="color: #eadd83;">=</span> <span style="color: #ff7f00; font-weight: bold;">sig</span>
<span style="color: #ff7f00; font-weight: bold;">end</span>
</pre>

</li>
<li>Pstr_class of class_declaration list 
</li>
</ul>



</li>
</ul>
<ul>
<li id="sec-1-1-6-1-8">class_declaration<br/>



<pre class="src src-tuareg"><span style="color: #ff7f00; font-weight: bold;">and</span> <span style="color: #dfaf8f;">class_declaration </span><span style="color: #eadd83;">=</span> class_expr class_infos     
</pre>


</li>
</ul>
<ul>
<li id="sec-1-1-6-1-9">class_expr<br/>



<pre class="src src-tuareg"><span style="color: #ff7f00; font-weight: bold;">and</span> <span style="color: #dfaf8f;">class_expr </span><span style="color: #eadd83;">=</span>
  <span style="color: #eadd83;">{</span> <span style="color: #dfaf8f;">pcl_desc</span><span style="color: #eadd83;">:</span> <span style="color: #8cd0d3;">class_expr_desc</span><span style="color: #eadd83;">;</span>
    <span style="color: #dfaf8f;">pcl_loc</span><span style="color: #eadd83;">:</span> <span style="color: #8cd0d3;">Location.t </span><span style="color: #eadd83;">}</span>
</pre>

</li>
</ul>
<ul>
<li id="sec-1-1-6-1-10">module_expr<br/>



<pre class="src src-tuareg"><span style="color: #ff7f00; font-weight: bold;">and</span> <span style="color: #dfaf8f;">module_expr </span><span style="color: #eadd83;">=</span>
  <span style="color: #eadd83;">{</span> <span style="color: #dfaf8f;">pmod_desc</span><span style="color: #eadd83;">:</span> <span style="color: #8cd0d3;">module_expr_desc</span><span style="color: #eadd83;">;</span>
    <span style="color: #dfaf8f;">pmod_loc</span><span style="color: #eadd83;">:</span> <span style="color: #8cd0d3;">Location.t </span><span style="color: #eadd83;">}</span>
</pre>


</li>
</ul>
<ul>
<li id="sec-1-1-6-1-11">module_expr_desc<br/>



<pre class="src src-tuareg"><span style="color: #ff7f00; font-weight: bold;">and</span> <span style="color: #dfaf8f;">module_expr_desc </span><span style="color: #eadd83;">=</span>
    Pmod_ident <span style="color: #f0dfaf; font-weight: bold;">of</span> <span style="color: #8cd0d3;">Longident</span>.t loc
  <span style="color: #eadd83;">|</span> Pmod_structure <span style="color: #f0dfaf; font-weight: bold;">of</span> structure
  <span style="color: #eadd83;">|</span> Pmod_functor <span style="color: #f0dfaf; font-weight: bold;">of</span> string loc <span style="color: #eadd83;">*</span> module_type <span style="color: #eadd83;">*</span> module_expr
  <span style="color: #eadd83;">|</span> Pmod_apply <span style="color: #f0dfaf; font-weight: bold;">of</span> module_expr <span style="color: #eadd83;">*</span> module_expr
  <span style="color: #eadd83;">|</span> Pmod_constraint <span style="color: #f0dfaf; font-weight: bold;">of</span> module_expr <span style="color: #eadd83;">*</span> module_type
  <span style="color: #eadd83;">|</span> Pmod_unpack <span style="color: #f0dfaf; font-weight: bold;">of</span> expression
</pre>


<ul>
<li>Pmod_constraint of module_expr * module_type 

<p>        
        One example 
</p>



<pre class="src src-tuareg"><span style="color: #cc9393;">"module  C : A with type 'a option = 'a M.option = U"</span> <span style="color: #eadd83;">|&gt;</span> implementation_of_string <span style="color: #eadd83;">;;</span>
<span style="color: #eadd83;">-</span> <span style="color: #eadd83;">:</span> <span style="color: #8cd0d3;">Parsetree.structure </span><span style="color: #eadd83;">=</span>
<span style="color: #eadd83;">[{</span>pstr_desc <span style="color: #eadd83;">=</span>
   Pstr_module <span style="color: #eadd83;">({</span><span style="color: #8cd0d3;">Asttypes</span>.txt <span style="color: #eadd83;">=</span> <span style="color: #cc9393;">"C"</span><span style="color: #eadd83;">;</span> loc <span style="color: #eadd83;">=</span> <span style="color: #eadd83;">},</span>
    <span style="color: #eadd83;">{</span>pmod_desc <span style="color: #eadd83;">=</span>
      Pmod_constraint
       <span style="color: #eadd83;">({</span>pmod_desc <span style="color: #eadd83;">=</span> Pmod_ident <span style="color: #eadd83;">{</span><span style="color: #8cd0d3;">Asttypes</span>.txt <span style="color: #eadd83;">=</span> <span style="color: #8cd0d3;">Longident</span>.Lident <span style="color: #cc9393;">"U"</span><span style="color: #eadd83;">;</span> loc <span style="color: #eadd83;">=</span> <span style="color: #eadd83;">};</span>
         pmod_loc <span style="color: #eadd83;">=</span> <span style="color: #eadd83;">},</span>
       <span style="color: #eadd83;">{</span>pmty_desc <span style="color: #eadd83;">=</span>
         Pmty_with
          <span style="color: #eadd83;">({</span>pmty_desc <span style="color: #eadd83;">=</span>
             Pmty_ident <span style="color: #eadd83;">{</span><span style="color: #8cd0d3;">Asttypes</span>.txt <span style="color: #eadd83;">=</span> <span style="color: #8cd0d3;">Longident</span>.Lident <span style="color: #cc9393;">"A"</span><span style="color: #eadd83;">;</span> loc <span style="color: #eadd83;">=</span> <span style="color: #eadd83;">};</span>
            pmty_loc <span style="color: #eadd83;">=</span> <span style="color: #eadd83;">},</span>
          <span style="color: #eadd83;">[({</span><span style="color: #8cd0d3;">Asttypes</span>.txt <span style="color: #eadd83;">=</span> <span style="color: #8cd0d3;">Longident</span>.Lident <span style="color: #cc9393;">"option"</span><span style="color: #eadd83;">;</span> loc <span style="color: #eadd83;">=</span> <span style="color: #eadd83;">},</span>
            Pwith_type
             <span style="color: #eadd83;">{</span>ptype_params <span style="color: #eadd83;">=</span> <span style="color: #eadd83;">[</span>Some <span style="color: #eadd83;">{</span><span style="color: #8cd0d3;">Asttypes</span>.txt <span style="color: #eadd83;">=</span> <span style="color: #cc9393;">"a"</span><span style="color: #eadd83;">;</span> loc <span style="color: #eadd83;">=</span> <span style="color: #eadd83;">}];</span>
              ptype_cstrs <span style="color: #eadd83;">=</span> <span style="color: #eadd83;">[];</span> ptype_kind <span style="color: #eadd83;">=</span> Ptype_abstract<span style="color: #eadd83;">;</span>
              ptype_private <span style="color: #eadd83;">=</span> Public<span style="color: #eadd83;">;</span>
              ptype_manifest <span style="color: #eadd83;">=</span>
               Some
                <span style="color: #eadd83;">{</span>ptyp_desc <span style="color: #eadd83;">=</span>
                  Ptyp_constr
                   <span style="color: #eadd83;">({</span><span style="color: #8cd0d3;">Asttypes</span>.txt <span style="color: #eadd83;">=</span>
                      <span style="color: #8cd0d3;">Longident</span>.Ldot <span style="color: #eadd83;">(</span><span style="color: #8cd0d3;">Longident</span>.Lident <span style="color: #cc9393;">"M"</span><span style="color: #eadd83;">,</span> <span style="color: #cc9393;">"option"</span><span style="color: #eadd83;">);</span>
                     loc <span style="color: #eadd83;">=</span> <span style="color: #eadd83;">},</span>
                   <span style="color: #eadd83;">[{</span>ptyp_desc <span style="color: #eadd83;">=</span> Ptyp_var <span style="color: #cc9393;">"a"</span><span style="color: #eadd83;">;</span> ptyp_loc <span style="color: #eadd83;">=</span> <span style="color: #eadd83;">}]);</span>
                 ptyp_loc <span style="color: #eadd83;">=</span> <span style="color: #eadd83;">};</span>
              ptype_variance <span style="color: #eadd83;">=</span> <span style="color: #eadd83;">[(</span><span style="color: #bfebbf;">false</span><span style="color: #eadd83;">,</span> <span style="color: #bfebbf;">false</span><span style="color: #eadd83;">)];</span> ptype_loc <span style="color: #eadd83;">=</span> <span style="color: #eadd83;">})]);</span>
        pmty_loc <span style="color: #eadd83;">=</span> <span style="color: #eadd83;">});</span>
     pmod_loc <span style="color: #eadd83;">=</span> <span style="color: #eadd83;">});</span>
  pstr_loc <span style="color: #eadd83;">=</span> <span style="color: #eadd83;">}]</span>
</pre>

</li>
</ul>



</li>
</ul>
<ul>
<li id="sec-1-1-6-1-12">module_type<br/>




<pre class="src src-tuareg"><span style="color: #ff7f00; font-weight: bold;">and</span> <span style="color: #dfaf8f;">module_type </span><span style="color: #eadd83;">=</span>
  <span style="color: #eadd83;">{</span> <span style="color: #dfaf8f;">pmty_desc</span><span style="color: #eadd83;">:</span> <span style="color: #8cd0d3;">module_type_desc</span><span style="color: #eadd83;">;</span>
    <span style="color: #dfaf8f;">pmty_loc</span><span style="color: #eadd83;">:</span> <span style="color: #8cd0d3;">Location.t </span><span style="color: #eadd83;">}</span>
</pre>


</li>
</ul>
<ul>
<li id="sec-1-1-6-1-13">module_type_desc<br/>




<pre class="src src-tuareg"><span style="color: #ff7f00; font-weight: bold;">and</span> <span style="color: #dfaf8f;">module_type_desc </span><span style="color: #eadd83;">=</span>
    Pmty_ident <span style="color: #f0dfaf; font-weight: bold;">of</span> <span style="color: #8cd0d3;">Longident</span>.t loc
  <span style="color: #eadd83;">|</span> Pmty_signature <span style="color: #f0dfaf; font-weight: bold;">of</span> signature
  <span style="color: #eadd83;">|</span> Pmty_functor <span style="color: #f0dfaf; font-weight: bold;">of</span> string loc <span style="color: #eadd83;">*</span> module_type <span style="color: #eadd83;">*</span> module_type
  <span style="color: #eadd83;">|</span> Pmty_with <span style="color: #f0dfaf; font-weight: bold;">of</span> module_type <span style="color: #eadd83;">*</span> <span style="color: #eadd83;">(</span><span style="color: #8cd0d3;">Longident</span>.t loc <span style="color: #eadd83;">*</span> with_constraint<span style="color: #eadd83;">)</span> list
  <span style="color: #eadd83;">|</span> Pmty_typeof <span style="color: #f0dfaf; font-weight: bold;">of</span> module_expr
</pre>


<ul>
<li>Pmty_with of module_type * (Longident.t loc * with_constraint) list
        list

</li>
<li>Pmty_idnet 



<pre class="src src-tuareg"><span style="color: #eadd83;">{</span>pmty_desc <span style="color: #eadd83;">=</span>
      Pmty_ident <span style="color: #eadd83;">{</span><span style="color: #8cd0d3;">Asttypes</span>.txt <span style="color: #eadd83;">=</span> <span style="color: #8cd0d3;">Longident</span>.Lident <span style="color: #cc9393;">"A"</span><span style="color: #eadd83;">;</span> loc <span style="color: #eadd83;">=</span> <span style="color: #eadd83;">};</span>
     pmty_loc <span style="color: #eadd83;">=</span> <span style="color: #eadd83;">}</span>
</pre>


</li>
<li>Pmty_signature of signature
</li>
</ul>


</li>
</ul>
<ul>
<li id="sec-1-1-6-1-14">with_constraint<br/>




<pre class="src src-tuareg"><span style="color: #ff7f00; font-weight: bold;">and</span> <span style="color: #dfaf8f;">with_constraint </span><span style="color: #eadd83;">=</span>
    Pwith_type <span style="color: #f0dfaf; font-weight: bold;">of</span> type_declaration
  <span style="color: #eadd83;">|</span> Pwith_module <span style="color: #f0dfaf; font-weight: bold;">of</span> <span style="color: #8cd0d3;">Longident</span>.t loc
  <span style="color: #eadd83;">|</span> Pwith_typesubst <span style="color: #f0dfaf; font-weight: bold;">of</span> type_declaration
  <span style="color: #eadd83;">|</span> Pwith_modsubst <span style="color: #f0dfaf; font-weight: bold;">of</span> <span style="color: #8cd0d3;">Longident</span>.t loc
</pre>


<ul>
<li>Pwith_type
</li>
</ul>


</li>
</ul>
<ul>
<li id="sec-1-1-6-1-15">type_declaration<br/>




<pre class="src src-tuareg"><span style="color: #ff7f00; font-weight: bold;">and</span> <span style="color: #dfaf8f;">type_declaration </span><span style="color: #eadd83;">=</span>
  <span style="color: #eadd83;">{</span> <span style="color: #dfaf8f;">ptype_params</span><span style="color: #eadd83;">:</span> <span style="color: #8cd0d3;">string loc option list</span><span style="color: #eadd83;">;</span>
    <span style="color: #dfaf8f;">ptype_cstrs</span><span style="color: #eadd83;">:</span> <span style="color: #eadd83;">(</span><span style="color: #8cd0d3;">core_type </span><span style="color: #eadd83;">*</span><span style="color: #8cd0d3;"> core_type </span><span style="color: #eadd83;">*</span><span style="color: #8cd0d3;"> Location.t</span><span style="color: #eadd83;">)</span><span style="color: #8cd0d3;"> list</span><span style="color: #eadd83;">;</span>
    <span style="color: #dfaf8f;">ptype_kind</span><span style="color: #eadd83;">:</span> <span style="color: #8cd0d3;">type_kind</span><span style="color: #eadd83;">;</span>
    <span style="color: #dfaf8f;">ptype_private</span><span style="color: #eadd83;">:</span> <span style="color: #8cd0d3;">private_flag</span><span style="color: #eadd83;">;</span>
    <span style="color: #dfaf8f;">ptype_manifest</span><span style="color: #eadd83;">:</span> <span style="color: #8cd0d3;">core_type option</span><span style="color: #eadd83;">;</span>
    <span style="color: #dfaf8f;">ptype_variance</span><span style="color: #eadd83;">:</span> <span style="color: #eadd83;">(</span><span style="color: #8cd0d3;">bool </span><span style="color: #eadd83;">*</span><span style="color: #8cd0d3;"> bool</span><span style="color: #eadd83;">)</span><span style="color: #8cd0d3;"> list</span><span style="color: #eadd83;">;</span>
    <span style="color: #dfaf8f;">ptype_loc</span><span style="color: #eadd83;">:</span> <span style="color: #8cd0d3;">Location.t </span><span style="color: #eadd83;">}</span>
</pre>




</li>
</ul>
<ul>
<li id="sec-1-1-6-1-16">signature<br/>



<pre class="src src-tuareg"><span style="color: #ff7f00; font-weight: bold;">and</span> <span style="color: #dfaf8f;">signature </span><span style="color: #eadd83;">=</span> signature_item list
</pre>


</li>
</ul>
<ul>
<li id="sec-1-1-6-1-17">signature_item<br/>



<pre class="src src-tuareg"><span style="color: #ff7f00; font-weight: bold;">and</span> <span style="color: #dfaf8f;">signature_item </span><span style="color: #eadd83;">=</span>
  <span style="color: #eadd83;">{</span> <span style="color: #dfaf8f;">psig_desc</span><span style="color: #eadd83;">:</span> <span style="color: #8cd0d3;">signature_item_desc</span><span style="color: #eadd83;">;</span>
    <span style="color: #dfaf8f;">psig_loc</span><span style="color: #eadd83;">:</span> <span style="color: #8cd0d3;">Location.t </span><span style="color: #eadd83;">}</span>
</pre>


</li>
</ul>
<ul>
<li id="sec-1-1-6-1-18">signature_item_desc<br/>



<pre class="src src-tuareg"><span style="color: #ff7f00; font-weight: bold;">and</span> <span style="color: #dfaf8f;">signature_item_desc </span><span style="color: #eadd83;">=</span>
    Psig_value <span style="color: #f0dfaf; font-weight: bold;">of</span> string loc <span style="color: #eadd83;">*</span> value_description
  <span style="color: #eadd83;">|</span> Psig_type <span style="color: #f0dfaf; font-weight: bold;">of</span> <span style="color: #eadd83;">(</span>string loc <span style="color: #eadd83;">*</span> type_declaration<span style="color: #eadd83;">)</span> list
  <span style="color: #eadd83;">|</span> Psig_exception <span style="color: #f0dfaf; font-weight: bold;">of</span> string loc <span style="color: #eadd83;">*</span> exception_declaration
  <span style="color: #eadd83;">|</span> Psig_module <span style="color: #f0dfaf; font-weight: bold;">of</span> string loc <span style="color: #eadd83;">*</span> module_type
  <span style="color: #eadd83;">|</span> Psig_recmodule <span style="color: #f0dfaf; font-weight: bold;">of</span> <span style="color: #eadd83;">(</span>string loc <span style="color: #eadd83;">*</span> module_type<span style="color: #eadd83;">)</span> list
  <span style="color: #eadd83;">|</span> Psig_modtype <span style="color: #f0dfaf; font-weight: bold;">of</span> string loc <span style="color: #eadd83;">*</span> modtype_declaration
  <span style="color: #eadd83;">|</span> Psig_open <span style="color: #f0dfaf; font-weight: bold;">of</span> <span style="color: #8cd0d3;">Longident</span>.t loc
  <span style="color: #eadd83;">|</span> Psig_include <span style="color: #f0dfaf; font-weight: bold;">of</span> module_type
  <span style="color: #eadd83;">|</span> Psig_class <span style="color: #f0dfaf; font-weight: bold;">of</span> class_description list
  <span style="color: #eadd83;">|</span> Psig_class_type <span style="color: #f0dfaf; font-weight: bold;">of</span> class_type_declaration list
</pre>


<ul>
<li>Psig_class of class_description list
</li>
</ul>



</li>
</ul>
<ul>
<li id="sec-1-1-6-1-19">class_description<br/>



<pre class="src src-tuareg"><span style="color: #ff7f00; font-weight: bold;">and</span> <span style="color: #dfaf8f;">class_description </span><span style="color: #eadd83;">=</span> class_type class_infos     
</pre>

</li>
</ul>
<ul>
<li id="sec-1-1-6-1-20">class_type<br/>



<pre class="src src-tuareg"><span style="color: #ff7f00; font-weight: bold;">and</span> <span style="color: #dfaf8f;">class_type </span><span style="color: #eadd83;">=</span>
  <span style="color: #eadd83;">{</span> <span style="color: #dfaf8f;">pcty_desc</span><span style="color: #eadd83;">:</span> <span style="color: #8cd0d3;">class_type_desc</span><span style="color: #eadd83;">;</span>
    <span style="color: #dfaf8f;">pcty_loc</span><span style="color: #eadd83;">:</span> <span style="color: #8cd0d3;">Location.t </span><span style="color: #eadd83;">}</span>
</pre>



</li>
</ul>
<ul>
<li id="sec-1-1-6-1-21">class_type_desc<br/>



<pre class="src src-tuareg"><span style="color: #ff7f00; font-weight: bold;">and</span> <span style="color: #dfaf8f;">class_type_desc </span><span style="color: #eadd83;">=</span>
    Pcty_constr <span style="color: #f0dfaf; font-weight: bold;">of</span> <span style="color: #8cd0d3;">Longident</span>.t loc <span style="color: #eadd83;">*</span> core_type list
  <span style="color: #eadd83;">|</span> Pcty_signature <span style="color: #f0dfaf; font-weight: bold;">of</span> class_signature
  <span style="color: #eadd83;">|</span> Pcty_fun <span style="color: #f0dfaf; font-weight: bold;">of</span> label <span style="color: #eadd83;">*</span> core_type <span style="color: #eadd83;">*</span> class_type
</pre>


<ul>
<li>Pcty_fun of label * core_type * class_type
</li>
</ul>

</li>
</ul>
<ul>
<li id="sec-1-1-6-1-22">class_expr_desc<br/>



<pre class="src src-tuareg"><span style="color: #ff7f00; font-weight: bold;">and</span> <span style="color: #dfaf8f;">class_expr_desc </span><span style="color: #eadd83;">=</span>
    Pcl_constr <span style="color: #f0dfaf; font-weight: bold;">of</span> <span style="color: #8cd0d3;">Longident</span>.t loc <span style="color: #eadd83;">*</span> core_type list
  <span style="color: #eadd83;">|</span> Pcl_structure <span style="color: #f0dfaf; font-weight: bold;">of</span> class_structure
  <span style="color: #eadd83;">|</span> Pcl_fun <span style="color: #f0dfaf; font-weight: bold;">of</span> label <span style="color: #eadd83;">*</span> expression option <span style="color: #eadd83;">*</span> pattern <span style="color: #eadd83;">*</span> class_expr
  <span style="color: #eadd83;">|</span> Pcl_apply <span style="color: #f0dfaf; font-weight: bold;">of</span> class_expr <span style="color: #eadd83;">*</span> <span style="color: #eadd83;">(</span>label <span style="color: #eadd83;">*</span> expression<span style="color: #eadd83;">)</span> list
  <span style="color: #eadd83;">|</span> Pcl_let <span style="color: #f0dfaf; font-weight: bold;">of</span> rec_flag <span style="color: #eadd83;">*</span> <span style="color: #eadd83;">(</span>pattern <span style="color: #eadd83;">*</span> expression<span style="color: #eadd83;">)</span> list <span style="color: #eadd83;">*</span> class_expr
  <span style="color: #eadd83;">|</span> Pcl_constraint <span style="color: #f0dfaf; font-weight: bold;">of</span> class_expr <span style="color: #eadd83;">*</span> class_type
</pre>

<ul>
<li>Pcl_fun of label * expression option * pattern * class_expr 
</li>
</ul>


</li>
</ul>
<ul>
<li id="sec-1-1-6-1-23">class_infos<br/>



<pre class="src src-tuareg"><span style="color: #ff7f00; font-weight: bold;">type</span> <span style="color: #eadd83;">'</span><span style="color: #8cd0d3;">a class_infos </span><span style="color: #eadd83;">=</span>
  <span style="color: #eadd83;">{</span> <span style="color: #dfaf8f;">pci_virt</span><span style="color: #eadd83;">:</span> <span style="color: #8cd0d3;">virtual_flag</span><span style="color: #eadd83;">;</span>
    <span style="color: #dfaf8f;">pci_params</span><span style="color: #eadd83;">:</span> <span style="color: #8cd0d3;">string loc list </span><span style="color: #eadd83;">*</span><span style="color: #8cd0d3;"> Location.t</span><span style="color: #eadd83;">;</span>
    <span style="color: #dfaf8f;">pci_name</span><span style="color: #eadd83;">:</span> <span style="color: #8cd0d3;">string loc</span><span style="color: #eadd83;">;</span>
    <span style="color: #dfaf8f;">pci_expr</span><span style="color: #eadd83;">:</span> <span style="color: #eadd83;">'</span><span style="color: #8cd0d3;">a</span><span style="color: #eadd83;">;</span>
    <span style="color: #dfaf8f;">pci_variance</span><span style="color: #eadd83;">:</span> <span style="color: #eadd83;">(</span><span style="color: #8cd0d3;">bool </span><span style="color: #eadd83;">*</span><span style="color: #8cd0d3;"> bool</span><span style="color: #eadd83;">)</span><span style="color: #8cd0d3;"> list</span><span style="color: #eadd83;">;</span>
    <span style="color: #dfaf8f;">pci_loc</span><span style="color: #eadd83;">:</span> <span style="color: #8cd0d3;">Location.t </span><span style="color: #eadd83;">}</span>
</pre>










</li>
</ul>
</li>
</ul>
</div>

</div>

<div id="outline-container-1-1-7" class="outline-4">
<h4 id="sec-1-1-7"><a href="file:///Users/bobzhang1988/ocaml/parsing/longident.ml">parsing:longident</a></h4>
<div class="outline-text-4" id="text-1-1-7">




<pre class="src src-ocaml"><span style="color: #ff7f00; font-weight: bold;">type</span> <span style="color: #8cd0d3;">t </span><span style="color: #eadd83;">=</span>
    Lident <span style="color: #f0dfaf; font-weight: bold;">of</span> string
  <span style="color: #eadd83;">|</span> Ldot <span style="color: #f0dfaf; font-weight: bold;">of</span> t <span style="color: #eadd83;">*</span> string
  <span style="color: #eadd83;">|</span> Lapply <span style="color: #f0dfaf; font-weight: bold;">of</span> t <span style="color: #eadd83;">*</span> t
</pre>

</div>

</div>

<div id="outline-container-1-1-8" class="outline-4">
<h4 id="sec-1-1-8"><a href="file:///Users/bobzhang1988/ocaml/parsing/asttypes.mli">parsing:asttypes</a></h4>
<div class="outline-text-4" id="text-1-1-8">

<p>    It's interesting to note that
</p>



<pre class="src src-ocaml"><span style="color: #ff7f00; font-weight: bold;">type</span> <span style="color: #eadd83;">'</span><span style="color: #8cd0d3;">a loc </span><span style="color: #eadd83;">=</span> <span style="color: #eadd83;">'</span>a <span style="color: #8cd0d3;">Location</span>.loc <span style="color: #eadd83;">=</span> <span style="color: #eadd83;">{</span>
  <span style="color: #dfaf8f;">txt</span> <span style="color: #eadd83;">:</span> <span style="color: #eadd83;">'</span><span style="color: #8cd0d3;">a</span><span style="color: #eadd83;">;</span>
  <span style="color: #dfaf8f;">loc</span> <span style="color: #eadd83;">:</span> <span style="color: #8cd0d3;">Location.t</span><span style="color: #eadd83;">;</span>
<span style="color: #eadd83;">}</span>
</pre>

</div>
</div>

</div>

<div id="outline-container-1-2" class="outline-3">
<h3 id="sec-1-2">typing</h3>
<div class="outline-text-3" id="text-1-2">

<p>   A function of <code>Typedtree.structure -&gt; Typedtree.structure</code>, but we
   are only interested in the uses of identifiers whose definitions
   are by primitives <code>OVERLOADED</code>.
</p>



<pre class="src src-ocaml"><span style="color: #7f9f7f;">(* </span><span style="color: #7f9f7f; font-style: italic;">See overload/mod.ml </span><span style="color: #7f9f7f;">*)</span>
<span style="color: #ff7f00; font-weight: bold;">let</span> <span style="color: #8cd0d3;">resolve_overloading</span><span style="color: #dfaf8f;"> e lidloc path </span><span style="color: #eadd83;">=</span> <span style="color: #eadd83;">...</span>

<span style="color: #ff7f00; font-weight: bold;">class</span> <span style="color: #dfaf8f;">map </span><span style="color: #eadd83;">=</span> <span style="color: #ff7f00; font-weight: bold;">object</span> <span style="color: #eadd83;">(</span>self<span style="color: #eadd83;">)</span>
  <span style="color: #ff7f00; font-weight: bold;">inherit</span> <span style="color: #8cd0d3;">Ttmap.map </span><span style="color: #f0dfaf; font-weight: bold;">as</span><span style="color: #8cd0d3;"> super</span>

  <span style="color: #ff7f00; font-weight: bold;">method</span><span style="color: #eadd83;">!</span> expression <span style="color: #eadd83;">=</span> <span style="color: #f0dfaf; font-weight: bold;">function</span>
   <span style="color: #dfaf8f;"> </span><span style="color: #eadd83;">|</span> <span style="color: #eadd83;">({</span> exp_desc<span style="color: #eadd83;">=</span> Texp_ident <span style="color: #eadd83;">(</span>path<span style="color: #eadd83;">,</span> lidloc<span style="color: #eadd83;">,</span> vdesc<span style="color: #eadd83;">)</span> <span style="color: #eadd83;">}</span> <span style="color: #f0dfaf; font-weight: bold;">as</span> e<span style="color: #eadd83;">)-&gt;</span>
        <span style="color: #ff7f00; font-weight: bold;">begin</span> <span style="color: #f0dfaf; font-weight: bold;">match</span> vdesc.val_kind <span style="color: #f0dfaf; font-weight: bold;">with</span>
        <span style="color: #eadd83;">|</span> Val_prim <span style="color: #eadd83;">{</span> <span style="color: #8cd0d3;">Primitive</span>.prim_name <span style="color: #eadd83;">=</span> <span style="color: #cc9393;">"OVERLOADED"</span> <span style="color: #eadd83;">}</span> <span style="color: #eadd83;">-&gt;</span>
            self<span style="color: #eadd83;">,</span> resolve_overloading e lidloc path
        <span style="color: #eadd83;">|</span> _ <span style="color: #eadd83;">-&gt;</span> super<span style="color: #eadd83;">#</span>expression e
        <span style="color: #ff7f00; font-weight: bold;">end</span>
    <span style="color: #eadd83;">|</span> e <span style="color: #eadd83;">-&gt;</span> super<span style="color: #eadd83;">#</span>expression e
<span style="color: #ff7f00; font-weight: bold;">end</span>   
</pre>


<p>
   The big picture is: traverse the module which defines the primitive
   to find the values with the same name, then filter out those which
   do not match the context type. If there is none left, error. If
   there are more than one matches, error (ambiguous). If there is
   only one candidate, replace the primitive use by the candidate
   variable.
</p>
</div>

<div id="outline-container-1-2-1" class="outline-4">
<h4 id="sec-1-2-1"><a href="file:///Users/bobzhang1988/ocaml/typing/env.ml">typing:env</a></h4>
<div class="outline-text-4" id="text-1-2-1">





<pre class="src src-ocaml"><span style="color: #ff7f00; font-weight: bold;">val</span> <span style="color: #dfaf8f;">find_value</span><span style="color: #eadd83;">:</span> <span style="color: #8cd0d3;">Path.t </span><span style="color: #eadd83;">-&gt;</span><span style="color: #8cd0d3;"> t </span><span style="color: #eadd83;">-&gt;</span><span style="color: #8cd0d3;"> value_description</span>
<span style="color: #ff7f00; font-weight: bold;">val</span> <span style="color: #dfaf8f;">find_annot</span><span style="color: #eadd83;">:</span> <span style="color: #8cd0d3;">Path.t </span><span style="color: #eadd83;">-&gt;</span><span style="color: #8cd0d3;"> t </span><span style="color: #eadd83;">-&gt;</span><span style="color: #8cd0d3;"> Annot.ident</span>
<span style="color: #ff7f00; font-weight: bold;">val</span> <span style="color: #dfaf8f;">find_type</span><span style="color: #eadd83;">:</span> <span style="color: #8cd0d3;">Path.t </span><span style="color: #eadd83;">-&gt;</span><span style="color: #8cd0d3;"> t </span><span style="color: #eadd83;">-&gt;</span><span style="color: #8cd0d3;"> type_declaration</span>
<span style="color: #ff7f00; font-weight: bold;">val</span> <span style="color: #dfaf8f;">find_constructors</span><span style="color: #eadd83;">:</span> <span style="color: #8cd0d3;">Path.t </span><span style="color: #eadd83;">-&gt;</span><span style="color: #8cd0d3;"> t </span><span style="color: #eadd83;">-&gt;</span><span style="color: #8cd0d3;"> constructor_description list</span>
<span style="color: #ff7f00; font-weight: bold;">val</span> <span style="color: #dfaf8f;">find_module</span><span style="color: #eadd83;">:</span> <span style="color: #8cd0d3;">Path.t </span><span style="color: #eadd83;">-&gt;</span><span style="color: #8cd0d3;"> t </span><span style="color: #eadd83;">-&gt;</span><span style="color: #8cd0d3;"> module_type</span>
<span style="color: #ff7f00; font-weight: bold;">val</span> <span style="color: #dfaf8f;">find_modtype</span><span style="color: #eadd83;">:</span> <span style="color: #8cd0d3;">Path.t </span><span style="color: #eadd83;">-&gt;</span><span style="color: #8cd0d3;"> t </span><span style="color: #eadd83;">-&gt;</span><span style="color: #8cd0d3;"> modtype_declaration</span>
<span style="color: #ff7f00; font-weight: bold;">val</span> <span style="color: #dfaf8f;">find_class</span><span style="color: #eadd83;">:</span> <span style="color: #8cd0d3;">Path.t </span><span style="color: #eadd83;">-&gt;</span><span style="color: #8cd0d3;"> t </span><span style="color: #eadd83;">-&gt;</span><span style="color: #8cd0d3;"> class_declaration</span>
<span style="color: #ff7f00; font-weight: bold;">val</span> <span style="color: #dfaf8f;">find_cltype</span><span style="color: #eadd83;">:</span> <span style="color: #8cd0d3;">Path.t </span><span style="color: #eadd83;">-&gt;</span><span style="color: #8cd0d3;"> t </span><span style="color: #eadd83;">-&gt;</span><span style="color: #8cd0d3;"> class_type_declaration</span>
</pre>


<pre class="src src-ocaml"><span style="color: #ff7f00; font-weight: bold;">val</span> <span style="color: #dfaf8f;">lookup_value</span><span style="color: #eadd83;">:</span> <span style="color: #8cd0d3;">Longident.t </span><span style="color: #eadd83;">-&gt;</span><span style="color: #8cd0d3;"> t </span><span style="color: #eadd83;">-&gt;</span><span style="color: #8cd0d3;"> Path.t </span><span style="color: #eadd83;">*</span><span style="color: #8cd0d3;"> value_description</span>
</pre>


<p>
    Here is an example:
</p>


<pre class="src src-ocaml"><span style="color: #ff7f00; font-weight: bold;">let</span> <span style="color: #dfaf8f;">a </span><span style="color: #eadd83;">=</span> <span style="color: #cc9393;">"aa"</span>  <span style="color: #eadd83;">;;</span>
<span style="color: #ff7f00; font-weight: bold;">val</span> <span style="color: #dfaf8f;">a </span><span style="color: #eadd83;">:</span> <span style="color: #8cd0d3;">string </span><span style="color: #eadd83;">=</span> <span style="color: #cc9393;">"aa"</span>
<span style="color: #8cd0d3;">Env</span>.lookup_value <span style="color: #eadd83;">(</span><span style="color: #8cd0d3;">Longident</span>.Lident <span style="color: #cc9393;">"a"</span><span style="color: #eadd83;">)</span> <span style="color: #eadd83;">!</span><span style="color: #8cd0d3;">Toploop</span>.toplevel_env<span style="color: #eadd83;">;;</span>
<span style="color: #eadd83;">-</span> <span style="color: #eadd83;">:</span> <span style="color: #8cd0d3;">Path.t </span><span style="color: #eadd83;">*</span><span style="color: #8cd0d3;"> Types.value_description </span><span style="color: #eadd83;">=</span>
<span style="color: #eadd83;">(</span><span style="color: #8cd0d3;">Path</span>.Pident <span style="color: #eadd83;">{</span><span style="color: #8cd0d3;">Ident</span>.stamp <span style="color: #eadd83;">=</span> 3491<span style="color: #eadd83;">;</span> name <span style="color: #eadd83;">=</span> <span style="color: #cc9393;">"a"</span><span style="color: #eadd83;">;</span> flags <span style="color: #eadd83;">=</span> 0<span style="color: #eadd83;">},</span>
 <span style="color: #eadd83;">{</span><span style="color: #8cd0d3;">Types</span>.val_type <span style="color: #eadd83;">=</span>
   <span style="color: #eadd83;">{</span><span style="color: #8cd0d3;">Types</span>.desc <span style="color: #eadd83;">=</span>
     <span style="color: #8cd0d3;">Types</span>.Tlink
      <span style="color: #eadd83;">{</span><span style="color: #8cd0d3;">Types</span>.desc <span style="color: #eadd83;">=</span>
        <span style="color: #8cd0d3;">Types</span>.Tconstr
         <span style="color: #eadd83;">(</span><span style="color: #8cd0d3;">Path</span>.Pident <span style="color: #eadd83;">{</span><span style="color: #8cd0d3;">Ident</span>.stamp <span style="color: #eadd83;">=</span> 3<span style="color: #eadd83;">;</span> name <span style="color: #eadd83;">=</span> <span style="color: #cc9393;">"string"</span><span style="color: #eadd83;">;</span> flags <span style="color: #eadd83;">=</span> 0<span style="color: #eadd83;">},</span> 
         <span style="color: #eadd83;">[],</span> <span style="color: #eadd83;">{</span>contents <span style="color: #eadd83;">=</span> <span style="color: #8cd0d3;">Types</span>.Mnil<span style="color: #eadd83;">});</span>
       level <span style="color: #eadd83;">=</span> 100000000<span style="color: #eadd83;">;</span> id <span style="color: #eadd83;">=</span> 45060<span style="color: #eadd83;">};</span>
    level <span style="color: #eadd83;">=</span> 3491<span style="color: #eadd83;">;</span> id <span style="color: #eadd83;">=</span> 45059<span style="color: #eadd83;">};</span>
  val_kind <span style="color: #eadd83;">=</span> <span style="color: #8cd0d3;">Types</span>.Val_reg<span style="color: #eadd83;">;</span> val_loc <span style="color: #eadd83;">=</span> <span style="color: #eadd83;">})</span>
</pre>



<pre class="src src-ocaml"><span style="color: #f0dfaf; font-weight: bold;">match</span> <span style="color: #eadd83;">(</span><span style="color: #8cd0d3;">Env</span>.lookup_value <span style="color: #eadd83;">(</span><span style="color: #8cd0d3;">Longident</span>.Lident <span style="color: #cc9393;">"a"</span><span style="color: #eadd83;">)</span> <span style="color: #eadd83;">!</span><span style="color: #8cd0d3;">Toploop</span>.toplevel_env<span style="color: #eadd83;">)</span> <span style="color: #f0dfaf; font-weight: bold;">with</span>
 <span style="color: #eadd83;">(</span>_<span style="color: #eadd83;">,{</span><span style="color: #8cd0d3;">Types</span>.val_type<span style="color: #eadd83;">})</span>  <span style="color: #eadd83;">-&gt;</span> <span style="color: #8cd0d3;">Printtyp</span>.type_expr std_formatter val_type <span style="color: #eadd83;">;;</span>
string    
</pre>

<p>
    <code>fold</code> is pretty useful when scanning the environment.
</p>



<pre class="src src-ocaml"><span style="color: #8cd0d3;">Env</span>.fold_values <span style="color: #eadd83;">(</span><span style="color: #f0dfaf; font-weight: bold;">fun</span> <span style="color: #dfaf8f;">s _ _ _ </span><span style="color: #eadd83;">-&gt;</span> prerr_endline s <span style="color: #eadd83;">)</span> None <span style="color: #eadd83;">!</span><span style="color: #8cd0d3;">Toploop</span>.toplevel_env <span style="color: #eadd83;">()</span> <span style="color: #eadd83;">;;</span>    
</pre>

</div>

</div>

<div id="outline-container-1-2-2" class="outline-4">
<h4 id="sec-1-2-2"><a href="file:///Users/bobzhang1988/ocaml/typing/ident.ml">typing:ident</a></h4>
<div class="outline-text-4" id="text-1-2-2">




<pre class="src src-ocaml"><span style="color: #ff7f00; font-weight: bold;">type</span> <span style="color: #8cd0d3;">t </span><span style="color: #eadd83;">=</span> <span style="color: #eadd83;">{</span> <span style="color: #dfaf8f;">stamp</span><span style="color: #eadd83;">:</span> <span style="color: #8cd0d3;">int</span><span style="color: #eadd83;">;</span> <span style="color: #dfaf8f;">name</span><span style="color: #eadd83;">:</span> <span style="color: #8cd0d3;">string</span><span style="color: #eadd83;">;</span> <span style="color: #f0dfaf; font-weight: bold;">mutable</span> <span style="color: #dfaf8f;">flags</span><span style="color: #eadd83;">:</span> <span style="color: #8cd0d3;">int </span><span style="color: #eadd83;">}</span>    
</pre>

</div>

</div>

<div id="outline-container-1-2-3" class="outline-4">
<h4 id="sec-1-2-3"><a href="file:///Users/bobzhang1988/ocaml/typing/path.ml">typing:path</a></h4>
<div class="outline-text-4" id="text-1-2-3">





<pre class="src src-ocaml"><span style="color: #ff7f00; font-weight: bold;">type</span> <span style="color: #8cd0d3;">t </span><span style="color: #eadd83;">=</span>
    Pident <span style="color: #f0dfaf; font-weight: bold;">of</span> <span style="color: #8cd0d3;">Ident</span>.t
  <span style="color: #eadd83;">|</span> Pdot <span style="color: #f0dfaf; font-weight: bold;">of</span> t <span style="color: #eadd83;">*</span> string <span style="color: #eadd83;">*</span> int
  <span style="color: #eadd83;">|</span> Papply <span style="color: #f0dfaf; font-weight: bold;">of</span> t <span style="color: #eadd83;">*</span> t
</pre>

</div>

</div>

<div id="outline-container-1-2-4" class="outline-4">
<h4 id="sec-1-2-4"><a href="file:///Users/bobzhang1988/ocaml/typing/mtype.ml">typing:mtype</a></h4>
<div class="outline-text-4" id="text-1-2-4">





<pre class="src src-tuareg"><span style="color: #ff7f00; font-weight: bold;">val</span> <span style="color: #dfaf8f;">scrape</span><span style="color: #eadd83;">:</span> <span style="color: #8cd0d3;">Env.t </span><span style="color: #eadd83;">-&gt;</span><span style="color: #8cd0d3;"> module_type </span><span style="color: #eadd83;">-&gt;</span><span style="color: #8cd0d3;"> module_type</span>
        <span style="color: #7f9f7f;">(* </span><span style="color: #7f9f7f; font-style: italic;">Expand toplevel module type abbreviations</span>
<span style="color: #7f9f7f; font-style: italic;">           till hitting a "hard" module type (signature, functor,</span>
<span style="color: #7f9f7f; font-style: italic;">           or abstract module type ident. </span><span style="color: #7f9f7f;">*)</span>
</pre>


<p>
    A example of resolve overloading
</p>



<pre class="src src-tuareg"><span style="color: #ff7f00; font-weight: bold;">let</span> <span style="color: #8cd0d3;">resolve_overloading</span><span style="color: #dfaf8f;"> exp lidloc path </span><span style="color: #eadd83;">=</span> 
  <span style="color: #ff7f00; font-weight: bold;">let</span> <span style="color: #dfaf8f;">env </span><span style="color: #eadd83;">=</span> exp.exp_env <span style="color: #ff7f00; font-weight: bold;">in</span>

  <span style="color: #ff7f00; font-weight: bold;">let</span> <span style="color: #dfaf8f;">name </span><span style="color: #eadd83;">=</span> get_name path <span style="color: #ff7f00; font-weight: bold;">in</span>

  <span style="color: #ff7f00; font-weight: bold;">let</span> <span style="color: #ff7f00; font-weight: bold;">rec</span> <span style="color: #8cd0d3;">find_candidates</span><span style="color: #dfaf8f;"> </span><span style="color: #eadd83;">(</span><span style="color: #dfaf8f;">path</span> <span style="color: #eadd83;">:</span> <span style="color: #8cd0d3;">Path.t</span><span style="color: #eadd83;">)</span> mty <span style="color: #eadd83;">=</span>
    <span style="color: #7f9f7f;">(* </span><span style="color: #7f9f7f; font-style: italic;">Format.eprintf "Find_candidates %a@." print_path path; </span><span style="color: #7f9f7f;">*)</span>

    <span style="color: #ff7f00; font-weight: bold;">let</span> <span style="color: #dfaf8f;">sg </span><span style="color: #eadd83;">=</span> <span style="color: #f0dfaf; font-weight: bold;">match</span> <span style="color: #8cd0d3;">Mtype</span>.scrape env mty <span style="color: #f0dfaf; font-weight: bold;">with</span>
      <span style="color: #eadd83;">|</span> Mty_signature sg <span style="color: #eadd83;">-&gt;</span> sg
      <span style="color: #eadd83;">|</span> _ <span style="color: #eadd83;">-&gt;</span> <span style="color: #f0dfaf; font-weight: bold;">assert</span> <span style="color: #bfebbf;">false</span>
    <span style="color: #ff7f00; font-weight: bold;">in</span>
    <span style="color: #8cd0d3;">List</span>.fold_right <span style="color: #eadd83;">(</span><span style="color: #f0dfaf; font-weight: bold;">fun</span> <span style="color: #dfaf8f;">sitem st </span><span style="color: #eadd83;">-&gt;</span> <span style="color: #f0dfaf; font-weight: bold;">match</span> sitem <span style="color: #f0dfaf; font-weight: bold;">with</span>
    <span style="color: #eadd83;">|</span> Sig_value <span style="color: #eadd83;">(</span>id<span style="color: #eadd83;">,</span> _vdesc<span style="color: #eadd83;">)</span> <span style="color: #f0dfaf; font-weight: bold;">when</span> <span style="color: #8cd0d3;">Ident</span>.name id <span style="color: #eadd83;">=</span> name <span style="color: #eadd83;">-&gt;</span> 
        <span style="color: #ff7f00; font-weight: bold;">let</span> <span style="color: #dfaf8f;">lident </span><span style="color: #eadd83;">=</span> <span style="color: #8cd0d3;">Longident</span>.Ldot <span style="color: #eadd83;">(</span><span style="color: #8cd0d3;">Untypeast</span>.lident_of_path path<span style="color: #eadd83;">,</span> <span style="color: #8cd0d3;">Ident</span>.name id<span style="color: #eadd83;">)</span> <span style="color: #ff7f00; font-weight: bold;">in</span>
        <span style="color: #ff7f00; font-weight: bold;">let</span> <span style="color: #dfaf8f;">path</span><span style="color: #eadd83;">,</span><span style="color: #dfaf8f;"> vdesc </span><span style="color: #eadd83;">=</span> <span style="color: #8cd0d3;">Env</span>.lookup_value lident env  <span style="color: #ff7f00; font-weight: bold;">in</span>
        <span style="color: #f0dfaf; font-weight: bold;">if</span> test env exp.exp_type vdesc <span style="color: #f0dfaf; font-weight: bold;">then</span> <span style="color: #eadd83;">(</span>path<span style="color: #eadd83;">,</span> vdesc<span style="color: #eadd83;">)</span> <span style="color: #eadd83;">::</span> st <span style="color: #f0dfaf; font-weight: bold;">else</span> st
    <span style="color: #eadd83;">|</span> Sig_module <span style="color: #eadd83;">(</span>id<span style="color: #eadd83;">,</span> _mty<span style="color: #eadd83;">,</span> _<span style="color: #eadd83;">)</span> <span style="color: #eadd83;">-&gt;</span> 
        <span style="color: #ff7f00; font-weight: bold;">let</span> <span style="color: #dfaf8f;">lident </span><span style="color: #eadd83;">=</span> <span style="color: #8cd0d3;">Longident</span>.Ldot <span style="color: #eadd83;">(</span><span style="color: #8cd0d3;">Untypeast</span>.lident_of_path path<span style="color: #eadd83;">,</span> <span style="color: #8cd0d3;">Ident</span>.name id<span style="color: #eadd83;">)</span> <span style="color: #ff7f00; font-weight: bold;">in</span>
        <span style="color: #ff7f00; font-weight: bold;">let</span> <span style="color: #dfaf8f;">path</span><span style="color: #eadd83;">,</span><span style="color: #dfaf8f;"> mty </span><span style="color: #eadd83;">=</span> <span style="color: #8cd0d3;">Env</span>.lookup_module lident env  <span style="color: #ff7f00; font-weight: bold;">in</span>
        find_candidates path mty <span style="color: #eadd83;">@</span> st
    <span style="color: #eadd83;">|</span> _ <span style="color: #eadd83;">-&gt;</span> st<span style="color: #eadd83;">)</span> sg <span style="color: #eadd83;">[]</span>
  <span style="color: #ff7f00; font-weight: bold;">in</span>

  <span style="color: #ff7f00; font-weight: bold;">let</span> <span style="color: #dfaf8f;">lid_opt </span><span style="color: #eadd83;">=</span> <span style="color: #f0dfaf; font-weight: bold;">match</span> path <span style="color: #f0dfaf; font-weight: bold;">with</span>
    <span style="color: #eadd83;">|</span> <span style="color: #8cd0d3;">Path</span>.Pident _ <span style="color: #eadd83;">-&gt;</span> None
    <span style="color: #eadd83;">|</span> <span style="color: #8cd0d3;">Path</span>.Pdot <span style="color: #eadd83;">(</span>p<span style="color: #eadd83;">,</span> _<span style="color: #eadd83;">,</span> _<span style="color: #eadd83;">)</span> <span style="color: #eadd83;">-&gt;</span> Some <span style="color: #eadd83;">(</span><span style="color: #8cd0d3;">Untypeast</span>.lident_of_path p<span style="color: #eadd83;">)</span>
    <span style="color: #eadd83;">|</span> <span style="color: #8cd0d3;">Path</span>.Papply _ <span style="color: #eadd83;">-&gt;</span> <span style="color: #f0dfaf; font-weight: bold;">assert</span> <span style="color: #bfebbf;">false</span>
  <span style="color: #ff7f00; font-weight: bold;">in</span>

  <span style="color: #f0dfaf; font-weight: bold;">match</span> 
    <span style="color: #8cd0d3;">Env</span>.fold_modules <span style="color: #eadd83;">(</span><span style="color: #f0dfaf; font-weight: bold;">fun</span> <span style="color: #dfaf8f;">_name path mty st </span><span style="color: #eadd83;">-&gt;</span> 
      find_candidates path mty <span style="color: #eadd83;">@</span> st<span style="color: #eadd83;">)</span> lid_opt env <span style="color: #eadd83;">[]</span>
  <span style="color: #f0dfaf; font-weight: bold;">with</span>
  <span style="color: #eadd83;">|</span> <span style="color: #eadd83;">[]</span> <span style="color: #eadd83;">-&gt;</span> <span style="color: #f0dfaf; font-weight: bold;">failwith</span> <span style="color: #cc9393;">"overload resolution failed: no match"</span> 
  <span style="color: #eadd83;">|</span> <span style="color: #eadd83;">[</span>path<span style="color: #eadd83;">,</span> vdesc<span style="color: #eadd83;">]</span> <span style="color: #eadd83;">-&gt;</span> 
      <span style="color: #8cd0d3;">Format</span>.eprintf <span style="color: #cc9393;">"RESOLVED: %a@."</span> print_path path<span style="color: #eadd83;">;</span>
      <span style="color: #ff7f00; font-weight: bold;">let</span> <span style="color: #dfaf8f;">ity </span><span style="color: #eadd83;">=</span> <span style="color: #8cd0d3;">Ctype</span>.instance env vdesc.val_type <span style="color: #ff7f00; font-weight: bold;">in</span>
      <span style="color: #8cd0d3;">Ctype</span>.unify env exp.exp_type ity<span style="color: #eadd83;">;</span> <span style="color: #7f9f7f;">(* </span><span style="color: #7f9f7f; font-style: italic;">should succeed </span><span style="color: #7f9f7f;">*)</span>
      <span style="color: #eadd83;">{</span> exp <span style="color: #f0dfaf; font-weight: bold;">with</span> 
        exp_desc <span style="color: #eadd83;">=</span> Texp_ident <span style="color: #eadd83;">(</span>path<span style="color: #eadd83;">,</span> <span style="color: #eadd83;">{</span>lidloc <span style="color: #f0dfaf; font-weight: bold;">with</span> <span style="color: #8cd0d3;">Asttypes</span>.txt <span style="color: #eadd83;">=</span> <span style="color: #8cd0d3;">Untypeast</span>.lident_of_path path<span style="color: #eadd83;">},</span> vdesc<span style="color: #eadd83;">);</span>
        exp_type <span style="color: #eadd83;">=</span> exp.exp_type <span style="color: #eadd83;">}</span>
  <span style="color: #eadd83;">|</span> _ <span style="color: #eadd83;">-&gt;</span> <span style="color: #f0dfaf; font-weight: bold;">failwith</span> <span style="color: #cc9393;">"overload resolution failed: too ambiguous"</span> 
</pre>

</div>

</div>

<div id="outline-container-1-2-5" class="outline-4">
<h4 id="sec-1-2-5"><a href="file:///Users/bobzhang1988/ocaml/typing/btype.ml">typing:btype</a></h4>
<div class="outline-text-4" id="text-1-2-5">

<p>    Utilities on core types in module <code>Types</code>
</p></div>

</div>

<div id="outline-container-1-2-6" class="outline-4">
<h4 id="sec-1-2-6"><a href="file:///Users/bobzhang1988/ocaml/typing/typetexp.ml">typing:typetexp</a></h4>
<div class="outline-text-4" id="text-1-2-6">

<p>    A module which did type checking for the  core language.
</p></div>

</div>

<div id="outline-container-1-2-7" class="outline-4">
<h4 id="sec-1-2-7"><a href="file:///Users/bobzhang1988/ocaml/typing/typecore.ml">typing:typecore</a></h4>
<div class="outline-text-4" id="text-1-2-7">

<p>    A module which did type inference for the core language.
</p>



<pre class="src src-ocaml"><span style="color: #ff7f00; font-weight: bold;">let</span> <span style="color: #8cd0d3;">reset_delayed_checks</span><span style="color: #dfaf8f;"> </span><span style="color: #eadd83;">()</span><span style="color: #dfaf8f;"> </span><span style="color: #eadd83;">=</span> delayed_checks <span style="color: #eadd83;">:=</span> <span style="color: #eadd83;">[]</span>
</pre>


</div>

</div>

<div id="outline-container-1-2-8" class="outline-4">
<h4 id="sec-1-2-8"><a href="file:///Users/bobzhang1988/ocaml/typing/includemod.ml">typing:includemod</a></h4>
<div class="outline-text-4" id="text-1-2-8">

<p>    A module which do inlcusion checks for the module langauge.
</p>


<pre class="src src-ocaml"><span style="color: #ff7f00; font-weight: bold;">val</span> <span style="color: #dfaf8f;">modtypes</span><span style="color: #eadd83;">:</span> <span style="color: #8cd0d3;">Env.t </span><span style="color: #eadd83;">-&gt;</span><span style="color: #8cd0d3;"> module_type </span><span style="color: #eadd83;">-&gt;</span><span style="color: #8cd0d3;"> module_type </span><span style="color: #eadd83;">-&gt;</span><span style="color: #8cd0d3;"> module_coercion</span>
<span style="color: #ff7f00; font-weight: bold;">val</span> <span style="color: #dfaf8f;">signatures</span><span style="color: #eadd83;">:</span> <span style="color: #8cd0d3;">Env.t </span><span style="color: #eadd83;">-&gt;</span><span style="color: #8cd0d3;"> signature </span><span style="color: #eadd83;">-&gt;</span><span style="color: #8cd0d3;"> signature </span><span style="color: #eadd83;">-&gt;</span><span style="color: #8cd0d3;"> module_coercion</span>
<span style="color: #ff7f00; font-weight: bold;">val</span> <span style="color: #dfaf8f;">compunit</span><span style="color: #eadd83;">:</span> <span style="color: #8cd0d3;">string </span><span style="color: #eadd83;">-&gt;</span><span style="color: #8cd0d3;"> signature </span><span style="color: #eadd83;">-&gt;</span><span style="color: #8cd0d3;"> string </span><span style="color: #eadd83;">-&gt;</span><span style="color: #8cd0d3;"> signature </span><span style="color: #eadd83;">-&gt;</span><span style="color: #8cd0d3;"> module_coercion</span>
<span style="color: #ff7f00; font-weight: bold;">val</span> <span style="color: #dfaf8f;">type_declarations</span><span style="color: #eadd83;">:</span>
      <span style="color: #8cd0d3;">Env.t </span><span style="color: #eadd83;">-&gt;</span><span style="color: #8cd0d3;"> Ident.t </span><span style="color: #eadd83;">-&gt;</span><span style="color: #8cd0d3;"> type_declaration </span><span style="color: #eadd83;">-&gt;</span><span style="color: #8cd0d3;"> type_declaration </span><span style="color: #eadd83;">-&gt;</span><span style="color: #8cd0d3;"> unit</span>
</pre>


</div>

</div>

<div id="outline-container-1-2-9" class="outline-4">
<h4 id="sec-1-2-9"><a href="file:///Users/bobzhang1988/ocaml/typing/types.ml">typing:types</a></h4>
<div class="outline-text-4" id="text-1-2-9">




<pre class="src src-ocaml"><span style="color: #ff7f00; font-weight: bold;">type</span> <span style="color: #8cd0d3;">value_description </span><span style="color: #eadd83;">=</span>
  <span style="color: #eadd83;">{</span> <span style="color: #dfaf8f;">val_type</span><span style="color: #eadd83;">:</span> <span style="color: #8cd0d3;">type_expr</span><span style="color: #eadd83;">;</span>                <span style="color: #7f9f7f;">(* </span><span style="color: #7f9f7f; font-style: italic;">Type of the value </span><span style="color: #7f9f7f;">*)</span>
    <span style="color: #dfaf8f;">val_kind</span><span style="color: #eadd83;">:</span> <span style="color: #8cd0d3;">value_kind</span><span style="color: #eadd83;">;</span>
    <span style="color: #dfaf8f;">val_loc</span><span style="color: #eadd83;">:</span> <span style="color: #8cd0d3;">Location.t</span><span style="color: #eadd83;">;</span>
   <span style="color: #eadd83;">}</span>    
</pre>


<p>
    Notice that <code>Typedtree</code> decorate <code>Types.value_description</code> again.
</p>
</div>

</div>

<div id="outline-container-1-2-10" class="outline-4">
<h4 id="sec-1-2-10"><a href="file:///Users/bobzhang1988/ocaml/typing/typedtree.ml">typing:typedtree</a></h4>
<div class="outline-text-4" id="text-1-2-10">

<p>    This module defines Abstract syntax after typing.  As the code
    demonstrated below, it decorate type definitions in module <code>Types</code>
</p>



<pre class="src src-ocaml"><span style="color: #ff7f00; font-weight: bold;">and</span> <span style="color: #dfaf8f;">module_type </span><span style="color: #eadd83;">=</span>
  <span style="color: #eadd83;">{</span> <span style="color: #dfaf8f;">mty_desc</span><span style="color: #eadd83;">:</span> <span style="color: #8cd0d3;">module_type_desc</span><span style="color: #eadd83;">;</span>
    <span style="color: #dfaf8f;">mty_type</span> <span style="color: #eadd83;">:</span> <span style="color: #8cd0d3;">Types.module_type</span><span style="color: #eadd83;">;</span>
    <span style="color: #dfaf8f;">mty_env</span> <span style="color: #eadd83;">:</span> <span style="color: #8cd0d3;">Env.t</span><span style="color: #eadd83;">;</span> <span style="color: #7f9f7f;">(* </span><span style="color: #7f9f7f; font-style: italic;">BINANNOT ADDED </span><span style="color: #7f9f7f;">*)</span>
    <span style="color: #dfaf8f;">mty_loc</span><span style="color: #eadd83;">:</span> <span style="color: #8cd0d3;">Location.t </span><span style="color: #eadd83;">}</span>
</pre>

</div>

</div>

<div id="outline-container-1-2-11" class="outline-4">
<h4 id="sec-1-2-11"><a href="file:///Users/bobzhang1988/ocaml/typing/outcometree.mli">typing:outcometree</a></h4>
<div class="outline-text-4" id="text-1-2-11">

<p>    This module defines results displayed by the toplevel These types
    represent messages that the toplevel displays as normal results or
    errors. The real displaying is customisable using the hooks:
</p>
<p>
    You can check the type of <code>Toploop.print_out_value</code>
</p>



<pre class="src src-ocaml"><span style="color: #8cd0d3;">Toploop</span>.print_out_value<span style="color: #eadd83;">;;</span>
<span style="color: #eadd83;">-</span> <span style="color: #eadd83;">:</span> <span style="color: #eadd83;">(</span><span style="color: #8cd0d3;">Format.formatter </span><span style="color: #eadd83;">-&gt;</span><span style="color: #8cd0d3;"> Outcometree.out_value </span><span style="color: #eadd83;">-&gt;</span><span style="color: #8cd0d3;"> unit</span><span style="color: #eadd83;">)</span><span style="color: #8cd0d3;"> </span><span style="color: #eadd83;">ref</span><span style="color: #8cd0d3;"> </span><span style="color: #eadd83;">=</span>
<span style="color: #eadd83;">{</span>contents <span style="color: #eadd83;">=</span> <span style="color: #eadd83;">&lt;</span><span style="color: #f0dfaf; font-weight: bold;">fun</span><span style="color: #eadd83;">&gt;}</span>
</pre>

<p>
    The module <code>genprintval</code> in toplevel, maps the <code>Types.type_expr</code>
    to <code>Outcometree.out_value</code>
</p>



<pre class="src src-ocaml"><span style="color: #ff7f00; font-weight: bold;">val</span> <span style="color: #dfaf8f;">outval_of_value </span><span style="color: #eadd83;">:</span>
  <span style="color: #8cd0d3;">int </span><span style="color: #eadd83;">-&gt;</span><span style="color: #8cd0d3;"> int </span><span style="color: #eadd83;">-&gt;</span>
  <span style="color: #eadd83;">(</span>int <span style="color: #eadd83;">-&gt;</span> t <span style="color: #eadd83;">-&gt;</span> <span style="color: #8cd0d3;">Types</span>.type_expr <span style="color: #eadd83;">-&gt;</span> <span style="color: #8cd0d3;">Outcometree</span>.out_value option<span style="color: #eadd83;">)</span> <span style="color: #eadd83;">-&gt;</span>
  <span style="color: #8cd0d3;">Env</span>.t <span style="color: #eadd83;">-&gt;</span> t <span style="color: #eadd83;">-&gt;</span> type_expr <span style="color: #eadd83;">-&gt;</span> <span style="color: #8cd0d3;">Outcometree</span>.out_value
</pre>

</div>

</div>

<div id="outline-container-1-2-12" class="outline-4">
<h4 id="sec-1-2-12"><a href="file:///Users/bobzhang1988/ocaml/typing/printtyp.ml">typing:printtyp</a></h4>
<div class="outline-text-4" id="text-1-2-12">

<p>    This module mainly export some printting functions for ocaml typed
    ast. The printed output seems to re-parseable again.
</p>


<pre class="src src-ocaml"><span style="color: #ff7f00; font-weight: bold;">val</span> <span style="color: #dfaf8f;">longident</span><span style="color: #eadd83;">:</span> <span style="color: #8cd0d3;">formatter </span><span style="color: #eadd83;">-&gt;</span><span style="color: #8cd0d3;"> Longident.t </span><span style="color: #eadd83;">-&gt;</span><span style="color: #8cd0d3;"> unit</span>
<span style="color: #ff7f00; font-weight: bold;">val</span> <span style="color: #dfaf8f;">ident</span><span style="color: #eadd83;">:</span> <span style="color: #8cd0d3;">formatter </span><span style="color: #eadd83;">-&gt;</span><span style="color: #8cd0d3;"> Ident.t </span><span style="color: #eadd83;">-&gt;</span><span style="color: #8cd0d3;"> unit</span>
<span style="color: #ff7f00; font-weight: bold;">val</span> <span style="color: #dfaf8f;">tree_of_path</span><span style="color: #eadd83;">:</span> <span style="color: #8cd0d3;">Path.t </span><span style="color: #eadd83;">-&gt;</span><span style="color: #8cd0d3;"> out_ident</span>
<span style="color: #ff7f00; font-weight: bold;">val</span> <span style="color: #dfaf8f;">path</span><span style="color: #eadd83;">:</span> <span style="color: #8cd0d3;">formatter </span><span style="color: #eadd83;">-&gt;</span><span style="color: #8cd0d3;"> Path.t </span><span style="color: #eadd83;">-&gt;</span><span style="color: #8cd0d3;"> unit</span>
<span style="color: #ff7f00; font-weight: bold;">val</span> <span style="color: #dfaf8f;">raw_type_expr</span><span style="color: #eadd83;">:</span> <span style="color: #8cd0d3;">formatter </span><span style="color: #eadd83;">-&gt;</span><span style="color: #8cd0d3;"> type_expr </span><span style="color: #eadd83;">-&gt;</span><span style="color: #8cd0d3;"> unit</span>
<span style="color: #ff7f00; font-weight: bold;">val</span> <span style="color: #dfaf8f;">reset</span><span style="color: #eadd83;">:</span> <span style="color: #8cd0d3;">unit </span><span style="color: #eadd83;">-&gt;</span><span style="color: #8cd0d3;"> unit</span>
<span style="color: #ff7f00; font-weight: bold;">val</span> <span style="color: #dfaf8f;">mark_loops</span><span style="color: #eadd83;">:</span> <span style="color: #8cd0d3;">type_expr </span><span style="color: #eadd83;">-&gt;</span><span style="color: #8cd0d3;"> unit</span>
<span style="color: #ff7f00; font-weight: bold;">val</span> <span style="color: #dfaf8f;">reset_and_mark_loops</span><span style="color: #eadd83;">:</span> <span style="color: #8cd0d3;">type_expr </span><span style="color: #eadd83;">-&gt;</span><span style="color: #8cd0d3;"> unit</span>
<span style="color: #ff7f00; font-weight: bold;">val</span> <span style="color: #dfaf8f;">reset_and_mark_loops_list</span><span style="color: #eadd83;">:</span> <span style="color: #8cd0d3;">type_expr list </span><span style="color: #eadd83;">-&gt;</span><span style="color: #8cd0d3;"> unit</span>
<span style="color: #ff7f00; font-weight: bold;">val</span> <span style="color: #dfaf8f;">type_expr</span><span style="color: #eadd83;">:</span> <span style="color: #8cd0d3;">formatter </span><span style="color: #eadd83;">-&gt;</span><span style="color: #8cd0d3;"> type_expr </span><span style="color: #eadd83;">-&gt;</span><span style="color: #8cd0d3;"> unit</span>
<span style="color: #ff7f00; font-weight: bold;">val</span> <span style="color: #dfaf8f;">tree_of_type_scheme</span><span style="color: #eadd83;">:</span> <span style="color: #8cd0d3;">type_expr </span><span style="color: #eadd83;">-&gt;</span><span style="color: #8cd0d3;"> out_type</span>
<span style="color: #ff7f00; font-weight: bold;">val</span> <span style="color: #dfaf8f;">type_sch </span><span style="color: #eadd83;">:</span> <span style="color: #8cd0d3;">formatter </span><span style="color: #eadd83;">-&gt;</span><span style="color: #8cd0d3;"> type_expr </span><span style="color: #eadd83;">-&gt;</span><span style="color: #8cd0d3;"> unit</span>
<span style="color: #ff7f00; font-weight: bold;">val</span> <span style="color: #dfaf8f;">type_scheme</span><span style="color: #eadd83;">:</span> <span style="color: #8cd0d3;">formatter </span><span style="color: #eadd83;">-&gt;</span><span style="color: #8cd0d3;"> type_expr </span><span style="color: #eadd83;">-&gt;</span><span style="color: #8cd0d3;"> unit</span>
</pre>

<p>
    You can use this module to process <i>cmi</i> files like this:
</p>



<pre class="src src-ocaml"><span style="color: #ff7f00; font-weight: bold;">let</span> <span style="color: #dfaf8f;">ic </span><span style="color: #eadd83;">=</span> open_in_bin filename <span style="color: #ff7f00; font-weight: bold;">in</span>
<span style="color: #ff7f00; font-weight: bold;">let</span> <span style="color: #dfaf8f;">magic_len </span><span style="color: #eadd83;">=</span> <span style="color: #8cd0d3;">String</span>.length <span style="color: #eadd83;">(</span><span style="color: #8cd0d3;">Config</span>.cmi_magic_number<span style="color: #eadd83;">)</span> <span style="color: #ff7f00; font-weight: bold;">in</span>
<span style="color: #ff7f00; font-weight: bold;">let</span> <span style="color: #dfaf8f;">buffer </span><span style="color: #eadd83;">=</span> <span style="color: #8cd0d3;">String</span>.create magic_len <span style="color: #ff7f00; font-weight: bold;">in</span>
really_input ic buffer 0 magic_len <span style="color: #eadd83;">;</span>
<span style="color: #ff7f00; font-weight: bold;">let</span><span style="color: #dfaf8f;"> </span><span style="color: #eadd83;">(</span>name<span style="color: #eadd83;">,</span> <span style="color: #eadd83;">(</span><span style="color: #dfaf8f;">sign</span><span style="color: #eadd83;">:</span><span style="color: #8cd0d3;">Types.signature</span><span style="color: #eadd83;">))</span> <span style="color: #eadd83;">=</span> input_value ic <span style="color: #ff7f00; font-weight: bold;">in</span>
<span style="color: #ff7f00; font-weight: bold;">let</span><span style="color: #dfaf8f;"> </span><span style="color: #eadd83;">(</span><span style="color: #dfaf8f;">crcs</span> <span style="color: #eadd83;">:</span> <span style="color: #eadd83;">(</span><span style="color: #8cd0d3;">string </span><span style="color: #eadd83;">*</span><span style="color: #8cd0d3;"> Digest.t</span><span style="color: #eadd83;">)</span><span style="color: #8cd0d3;"> list</span><span style="color: #eadd83;">)</span> <span style="color: #eadd83;">=</span> input_value ic <span style="color: #ff7f00; font-weight: bold;">in</span>
<span style="color: #ff7f00; font-weight: bold;">let</span><span style="color: #dfaf8f;"> </span><span style="color: #eadd83;">(</span><span style="color: #dfaf8f;">flags</span> <span style="color: #eadd83;">:</span> <span style="color: #8cd0d3;">flags list</span><span style="color: #eadd83;">)</span> <span style="color: #eadd83;">=</span> input_value ic <span style="color: #ff7f00; font-weight: bold;">in</span>
close_in ic <span style="color: #eadd83;">;</span>
</pre>

<p>
    But there is module <code>cmi_format</code> which handles this for you. 
</p></div>

</div>

<div id="outline-container-1-2-13" class="outline-4">
<h4 id="sec-1-2-13"><a href="file:///Users/bobzhang1988/ocaml/typing/cmi_format.ml">typing:cmi_format</a></h4>
<div class="outline-text-4" id="text-1-2-13">




<pre class="src src-ocaml"><span style="color: #ff7f00; font-weight: bold;">val</span> <span style="color: #dfaf8f;">output_cmi </span><span style="color: #eadd83;">:</span> <span style="color: #8cd0d3;">string </span><span style="color: #eadd83;">-&gt;</span><span style="color: #8cd0d3;"> out_channel </span><span style="color: #eadd83;">-&gt;</span><span style="color: #8cd0d3;"> cmi_infos </span><span style="color: #eadd83;">-&gt;</span><span style="color: #8cd0d3;"> Digest.t</span>
<span style="color: #ff7f00; font-weight: bold;">val</span> <span style="color: #dfaf8f;">input_cmi </span><span style="color: #eadd83;">:</span> <span style="color: #8cd0d3;">in_channel </span><span style="color: #eadd83;">-&gt;</span><span style="color: #8cd0d3;"> cmi_infos</span>
<span style="color: #ff7f00; font-weight: bold;">val</span> <span style="color: #dfaf8f;">read_cmi </span><span style="color: #eadd83;">:</span> <span style="color: #8cd0d3;">string </span><span style="color: #eadd83;">-&gt;</span><span style="color: #8cd0d3;"> cmi_infos</span>
</pre>


</div>

</div>

<div id="outline-container-1-2-14" class="outline-4">
<h4 id="sec-1-2-14"><a href="file:///Users/bobzhang1988/ocaml/typing/ctype.ml">typing:ctype</a></h4>
<div class="outline-text-4" id="text-1-2-14">

<p>    Type manipulation after type inference
</p>
<p>       
    If one wants to manipulate a type after type inference (for
    instance, during code generation or in the debugger), one must
    first make sure that the <b>type levels are correct</b>, using the
    function <code>correct_levels</code>. Then, this type can be correctely
    manipulated by <code>apply</code>, <code>expand_head</code> and <code>moregeneral</code>.
</p>
<ul>
<li>As much sharing as possible should be kept : it makes types
         smaller and better abbreviated. When necessary, some sharing
         can be lost. Types will still be printed correctly (+++ TO
         DO&hellip;), and abbreviations defined by a class do not depend on
         sharing thanks to constrained abbreviations. (Of course, even
         if some sharing is lost, typing will still be correct.)

</li>
<li>All nodes of a type have a level : that way, one know whether
        a node need to be duplicated or not when instantiating a type.
</li>
<li>Levels of a type are decreasing (generic level being
        considered as greatest).
</li>
<li>The level of a type constructor is superior to the binding
        time of its path.
</li>
<li>Recursive types without limitation should be handled (even if
        there is still an occur check). This avoid treating specially
        the case for objects, for instance. Furthermore, the occur
        check policy can then be easily changed.
</li>
</ul>


</div>

</div>

<div id="outline-container-1-2-15" class="outline-4">
<h4 id="sec-1-2-15"><a href="file:///Users/bobzhang1988/ocaml/typing/typemod.ml">typing:typemod</a></h4>
<div class="outline-text-4" id="text-1-2-15">

<p>    A module consists of type checking for ocaml Ast.
</p>



<pre class="src src-ocaml"><span style="color: #ff7f00; font-weight: bold;">val</span> <span style="color: #dfaf8f;">type_module</span><span style="color: #eadd83;">:</span>
        <span style="color: #8cd0d3;">Env.t </span><span style="color: #eadd83;">-&gt;</span><span style="color: #8cd0d3;"> Parsetree.module_expr </span><span style="color: #eadd83;">-&gt;</span><span style="color: #8cd0d3;"> Typedtree.module_expr</span>
<span style="color: #ff7f00; font-weight: bold;">val</span> <span style="color: #dfaf8f;">type_structure</span><span style="color: #eadd83;">:</span>
        <span style="color: #8cd0d3;">Env.t </span><span style="color: #eadd83;">-&gt;</span><span style="color: #8cd0d3;"> Parsetree.structure </span><span style="color: #eadd83;">-&gt;</span><span style="color: #8cd0d3;"> Location.t </span><span style="color: #eadd83;">-&gt;</span>
         <span style="color: #8cd0d3;">Typedtree</span>.structure <span style="color: #eadd83;">*</span> <span style="color: #8cd0d3;">Types</span>.signature <span style="color: #eadd83;">*</span> <span style="color: #8cd0d3;">Env</span>.t
<span style="color: #ff7f00; font-weight: bold;">val</span> <span style="color: #dfaf8f;">type_toplevel_phrase</span><span style="color: #eadd83;">:</span>
        <span style="color: #8cd0d3;">Env.t </span><span style="color: #eadd83;">-&gt;</span><span style="color: #8cd0d3;"> Parsetree.structure </span><span style="color: #eadd83;">-&gt;</span>
         <span style="color: #8cd0d3;">Typedtree</span>.structure <span style="color: #eadd83;">*</span> <span style="color: #8cd0d3;">Types</span>.signature <span style="color: #eadd83;">*</span> <span style="color: #8cd0d3;">Env</span>.t
<span style="color: #ff7f00; font-weight: bold;">val</span> <span style="color: #dfaf8f;">type_implementation</span><span style="color: #eadd83;">:</span>
  <span style="color: #8cd0d3;">string </span><span style="color: #eadd83;">-&gt;</span><span style="color: #8cd0d3;"> string </span><span style="color: #eadd83;">-&gt;</span><span style="color: #8cd0d3;"> string </span><span style="color: #eadd83;">-&gt;</span><span style="color: #8cd0d3;"> Env.t </span><span style="color: #eadd83;">-&gt;</span><span style="color: #8cd0d3;"> Parsetree.structure </span><span style="color: #eadd83;">-&gt;</span>
  <span style="color: #8cd0d3;">Typedtree</span>.structure <span style="color: #eadd83;">*</span> <span style="color: #8cd0d3;">Typedtree</span>.module_coercion
</pre>


<p>
    Here is an example to typing
</p>



<pre class="src src-ocaml"><span style="color: #ff7f00; font-weight: bold;">let</span> <span style="color: #dfaf8f;">str </span><span style="color: #eadd83;">=</span> s2s <span style="color: #eadd83;">&lt;:</span><span style="color: #8cd0d3;">str_item</span><span style="color: #eadd83;">&lt;</span> value f x <span style="color: #eadd83;">=</span> x  <span style="color: #eadd83;">&gt;&gt;</span> <span style="color: #ff7f00; font-weight: bold;">in</span>
<span style="color: #ff7f00; font-weight: bold;">let</span><span style="color: #dfaf8f;"> </span><span style="color: #eadd83;">(</span><span style="color: #dfaf8f;">a</span><span style="color: #eadd83;">,</span><span style="color: #dfaf8f;">b</span><span style="color: #eadd83;">,</span><span style="color: #dfaf8f;">c</span><span style="color: #eadd83;">)</span><span style="color: #dfaf8f;"> </span><span style="color: #eadd83;">=</span> <span style="color: #8cd0d3;">Typemod</span>.type_toplevel_phrase <span style="color: #8cd0d3;">Env</span>.empty <span style="color: #eadd83;">(</span><span style="color: #8cd0d3;">Obj</span>.magic str<span style="color: #eadd83;">)</span> <span style="color: #ff7f00; font-weight: bold;">in</span> b <span style="color: #eadd83;">|&gt;</span> <span style="color: #8cd0d3;">Typemod</span>.simplify_signature <span style="color: #eadd83;">;</span>
<span style="color: #eadd83;">-</span> <span style="color: #eadd83;">:</span> <span style="color: #8cd0d3;">Types.signature </span><span style="color: #eadd83;">=</span>
<span style="color: #eadd83;">[</span><span style="color: #8cd0d3;">Types</span>.Sig_value <span style="color: #eadd83;">{</span><span style="color: #8cd0d3;">Ident</span>.stamp<span style="color: #eadd83;">=</span>15317<span style="color: #eadd83;">;</span> name<span style="color: #eadd83;">=</span><span style="color: #cc9393;">"f"</span><span style="color: #eadd83;">;</span> flags<span style="color: #eadd83;">=</span>0<span style="color: #eadd83;">}</span>
  <span style="color: #eadd83;">{</span><span style="color: #8cd0d3;">Types</span>.val_type<span style="color: #eadd83;">=</span>
    <span style="color: #eadd83;">{</span><span style="color: #8cd0d3;">Types</span>.desc<span style="color: #eadd83;">=</span>
      <span style="color: #8cd0d3;">Types</span>.Tlink
       <span style="color: #eadd83;">{</span><span style="color: #8cd0d3;">Types</span>.desc<span style="color: #eadd83;">=</span>
         <span style="color: #8cd0d3;">Types</span>.Tarrow <span style="color: #cc9393;">""</span>
          <span style="color: #eadd83;">{</span><span style="color: #8cd0d3;">Types</span>.desc<span style="color: #eadd83;">=</span>
            <span style="color: #8cd0d3;">Types</span>.Tlink
             <span style="color: #eadd83;">{</span><span style="color: #8cd0d3;">Types</span>.desc<span style="color: #eadd83;">=</span>
               <span style="color: #8cd0d3;">Types</span>.Tlink
                <span style="color: #eadd83;">{</span><span style="color: #8cd0d3;">Types</span>.desc<span style="color: #eadd83;">=</span>
                  <span style="color: #8cd0d3;">Types</span>.Tlink
                   <span style="color: #eadd83;">{</span><span style="color: #8cd0d3;">Types</span>.desc<span style="color: #eadd83;">=</span><span style="color: #8cd0d3;">Types</span>.Tvar None<span style="color: #eadd83;">;</span> level<span style="color: #eadd83;">=</span>100000000<span style="color: #eadd83;">;</span> id<span style="color: #eadd83;">=</span>307558<span style="color: #eadd83;">};</span>
                 level<span style="color: #eadd83;">=</span>15317<span style="color: #eadd83;">;</span> id<span style="color: #eadd83;">=</span>307561<span style="color: #eadd83;">};</span>
              level<span style="color: #eadd83;">=</span>15317<span style="color: #eadd83;">;</span> id<span style="color: #eadd83;">=</span>307560<span style="color: #eadd83;">};</span>
           level<span style="color: #eadd83;">=</span>15317<span style="color: #eadd83;">;</span> id<span style="color: #eadd83;">=</span>307557<span style="color: #eadd83;">}</span>
          <span style="color: #eadd83;">{</span><span style="color: #8cd0d3;">Types</span>.desc<span style="color: #eadd83;">=</span><span style="color: #8cd0d3;">Types</span>.Tvar None<span style="color: #eadd83;">;</span> level<span style="color: #eadd83;">=</span>100000000<span style="color: #eadd83;">;</span> id<span style="color: #eadd83;">=</span>307558<span style="color: #eadd83;">}</span> <span style="color: #8cd0d3;">Types</span>.Cok<span style="color: #eadd83;">;</span>
        level<span style="color: #eadd83;">=</span>100000000<span style="color: #eadd83;">;</span> id<span style="color: #eadd83;">=</span>307559<span style="color: #eadd83;">};</span>
     level<span style="color: #eadd83;">=</span>15317<span style="color: #eadd83;">;</span> id<span style="color: #eadd83;">=</span>307556<span style="color: #eadd83;">};</span>
   val_kind<span style="color: #eadd83;">=</span><span style="color: #8cd0d3;">Types</span>.Val_reg<span style="color: #eadd83;">;</span>
   val_loc<span style="color: #eadd83;">=</span>
    <span style="color: #eadd83;">{</span><span style="color: #8cd0d3;">Location</span>.loc_start<span style="color: #eadd83;">=</span>
      <span style="color: #eadd83;">{</span><span style="color: #8cd0d3;">Lexing</span>.pos_fname<span style="color: #eadd83;">=</span><span style="color: #cc9393;">"ghost-location"</span><span style="color: #eadd83;">;</span> pos_lnum<span style="color: #eadd83;">=</span>1<span style="color: #eadd83;">;</span> pos_bol<span style="color: #eadd83;">=</span>0<span style="color: #eadd83;">;</span> pos_cnum<span style="color: #eadd83;">=</span>0<span style="color: #eadd83;">};</span>
     loc_end<span style="color: #eadd83;">=</span>
      <span style="color: #eadd83;">{</span><span style="color: #8cd0d3;">Lexing</span>.pos_fname<span style="color: #eadd83;">=</span><span style="color: #cc9393;">"ghost-location"</span><span style="color: #eadd83;">;</span> pos_lnum<span style="color: #eadd83;">=</span>1<span style="color: #eadd83;">;</span> pos_bol<span style="color: #eadd83;">=</span>0<span style="color: #eadd83;">;</span> pos_cnum<span style="color: #eadd83;">=</span>0<span style="color: #eadd83;">};</span>
     loc_ghost<span style="color: #eadd83;">=</span>True<span style="color: #eadd83;">}}]</span>

</pre>


<p>
    You can also print it.
</p>



<pre class="src src-ocaml"><span style="color: #ff7f00; font-weight: bold;">let</span><span style="color: #dfaf8f;"> </span><span style="color: #eadd83;">(</span><span style="color: #dfaf8f;">a</span><span style="color: #eadd83;">,</span><span style="color: #dfaf8f;">b</span><span style="color: #eadd83;">,</span><span style="color: #dfaf8f;">c</span><span style="color: #eadd83;">)</span><span style="color: #dfaf8f;"> </span><span style="color: #eadd83;">=</span> <span style="color: #8cd0d3;">Typemod</span>.type_toplevel_phrase <span style="color: #8cd0d3;">Env</span>.empty <span style="color: #eadd83;">(</span><span style="color: #8cd0d3;">Obj</span>.magic str<span style="color: #eadd83;">)</span> <span style="color: #ff7f00; font-weight: bold;">in</span>
b <span style="color: #eadd83;">|&gt;</span> <span style="color: #8cd0d3;">Typemod</span>.simplify_signature <span style="color: #eadd83;">|&gt;</span> <span style="color: #8cd0d3;">Printtyp</span>.signature std_formatter<span style="color: #eadd83;">;</span>
value <span style="color: #dfaf8f;">f</span> <span style="color: #eadd83;">:</span> <span style="color: #eadd83;">'</span><span style="color: #8cd0d3;">a </span><span style="color: #eadd83;">-&gt;</span><span style="color: #8cd0d3;"> </span><span style="color: #eadd83;">'</span><span style="color: #8cd0d3;">a</span><span style="color: #eadd83;">;</span>    
</pre>



</div>

</div>

<div id="outline-container-1-2-16" class="outline-4">
<h4 id="sec-1-2-16"><a href="file:///Users/bobzhang1988/ocaml/typing/predef.ml">typing:predef</a></h4>
<div class="outline-text-4" id="text-1-2-16">

<p>    A module consists of predefined type constructors with special
    typing rules in typecore.
</p></div>

</div>

<div id="outline-container-1-2-17" class="outline-4">
<h4 id="sec-1-2-17"><a href="file:///Users/bobzhang1988/ocaml/typing/oprint.ml">typing:oprint</a></h4>
<div class="outline-text-4" id="text-1-2-17">

<p>    printer for type definitions in <code>Outcometree</code>
</p>


<pre class="src src-ocaml"><span style="color: #ff7f00; font-weight: bold;">val</span> <span style="color: #dfaf8f;">out_value </span><span style="color: #eadd83;">:</span> <span style="color: #eadd83;">(</span><span style="color: #8cd0d3;">formatter </span><span style="color: #eadd83;">-&gt;</span><span style="color: #8cd0d3;"> out_value </span><span style="color: #eadd83;">-&gt;</span><span style="color: #8cd0d3;"> unit</span><span style="color: #eadd83;">)</span><span style="color: #8cd0d3;"> </span><span style="color: #eadd83;">ref</span>
<span style="color: #ff7f00; font-weight: bold;">val</span> <span style="color: #dfaf8f;">out_type </span><span style="color: #eadd83;">:</span> <span style="color: #eadd83;">(</span><span style="color: #8cd0d3;">formatter </span><span style="color: #eadd83;">-&gt;</span><span style="color: #8cd0d3;"> out_type </span><span style="color: #eadd83;">-&gt;</span><span style="color: #8cd0d3;"> unit</span><span style="color: #eadd83;">)</span><span style="color: #8cd0d3;"> </span><span style="color: #eadd83;">ref</span>
<span style="color: #ff7f00; font-weight: bold;">val</span> <span style="color: #dfaf8f;">out_class_type </span><span style="color: #eadd83;">:</span> <span style="color: #eadd83;">(</span><span style="color: #8cd0d3;">formatter </span><span style="color: #eadd83;">-&gt;</span><span style="color: #8cd0d3;"> out_class_type </span><span style="color: #eadd83;">-&gt;</span><span style="color: #8cd0d3;"> unit</span><span style="color: #eadd83;">)</span><span style="color: #8cd0d3;"> </span><span style="color: #eadd83;">ref</span>
<span style="color: #ff7f00; font-weight: bold;">val</span> <span style="color: #dfaf8f;">out_module_type </span><span style="color: #eadd83;">:</span> <span style="color: #eadd83;">(</span><span style="color: #8cd0d3;">formatter </span><span style="color: #eadd83;">-&gt;</span><span style="color: #8cd0d3;"> out_module_type </span><span style="color: #eadd83;">-&gt;</span><span style="color: #8cd0d3;"> unit</span><span style="color: #eadd83;">)</span><span style="color: #8cd0d3;"> </span><span style="color: #eadd83;">ref</span>
<span style="color: #ff7f00; font-weight: bold;">val</span> <span style="color: #dfaf8f;">out_sig_item </span><span style="color: #eadd83;">:</span> <span style="color: #eadd83;">(</span><span style="color: #8cd0d3;">formatter </span><span style="color: #eadd83;">-&gt;</span><span style="color: #8cd0d3;"> out_sig_item </span><span style="color: #eadd83;">-&gt;</span><span style="color: #8cd0d3;"> unit</span><span style="color: #eadd83;">)</span><span style="color: #8cd0d3;"> </span><span style="color: #eadd83;">ref</span>
<span style="color: #ff7f00; font-weight: bold;">val</span> <span style="color: #dfaf8f;">out_signature </span><span style="color: #eadd83;">:</span> <span style="color: #eadd83;">(</span><span style="color: #8cd0d3;">formatter </span><span style="color: #eadd83;">-&gt;</span><span style="color: #8cd0d3;"> out_sig_item list </span><span style="color: #eadd83;">-&gt;</span><span style="color: #8cd0d3;"> unit</span><span style="color: #eadd83;">)</span><span style="color: #8cd0d3;"> </span><span style="color: #eadd83;">ref</span>
<span style="color: #ff7f00; font-weight: bold;">val</span> <span style="color: #dfaf8f;">out_phrase </span><span style="color: #eadd83;">:</span> <span style="color: #eadd83;">(</span><span style="color: #8cd0d3;">formatter </span><span style="color: #eadd83;">-&gt;</span><span style="color: #8cd0d3;"> out_phrase </span><span style="color: #eadd83;">-&gt;</span><span style="color: #8cd0d3;"> unit</span><span style="color: #eadd83;">)</span><span style="color: #8cd0d3;"> </span><span style="color: #eadd83;">ref</span>

<span style="color: #ff7f00; font-weight: bold;">val</span> <span style="color: #dfaf8f;">parenthesized_ident </span><span style="color: #eadd83;">:</span> <span style="color: #8cd0d3;">string </span><span style="color: #eadd83;">-&gt;</span><span style="color: #8cd0d3;"> bool</span>

</pre>

</div>

</div>

<div id="outline-container-1-2-18" class="outline-4">
<h4 id="sec-1-2-18"><a href="file:///Users/bobzhang1988/ocaml/typing/cmt_format.ml">typing:cmt_format</a></h4>
<div class="outline-text-4" id="text-1-2-18">


</div>
</div>

</div>

<div id="outline-container-1-3" class="outline-3">
<h3 id="sec-1-3">utils</h3>
<div class="outline-text-3" id="text-1-3">


</div>

<div id="outline-container-1-3-1" class="outline-4">
<h4 id="sec-1-3-1"><a href="file:///Users/bobzhang1988/ocaml/utils/misc.ml">utils:misc</a></h4>
<div class="outline-text-4" id="text-1-3-1">


</div>

</div>

<div id="outline-container-1-3-2" class="outline-4">
<h4 id="sec-1-3-2"><a href="file:///Users/bobzhang1988/ocaml/utils/clflags.ml">utils:clflags</a></h4>
<div class="outline-text-4" id="text-1-3-2">

<p>    There are a lot of custmoized flags here, which <code>toplevel</code>
    respect.  Suppose you turn on
</p>



<pre class="src src-ocaml"><span style="color: #8cd0d3;">Clflags</span>.dump_rawlambda <span style="color: #eadd83;">:=</span> <span style="color: #bfebbf;">true</span><span style="color: #eadd83;">;;</span>
</pre>

</div>

</div>

<div id="outline-container-1-3-3" class="outline-4">
<h4 id="sec-1-3-3"><a href="file:///Users/bobzhang1988/ocaml/utils/config.ml">utils:config</a></h4>
<div class="outline-text-4" id="text-1-3-3">

<p>    It's another module which has a lot of configurations. It's generated
    by <code>config.mlbuild</code>
</p></div>

</div>

<div id="outline-container-1-3-4" class="outline-4">
<h4 id="sec-1-3-4"><a href="file:///Users/bobzhang1988/ocaml/utils/ccomp.ml">utils:ccomp</a></h4>
<div class="outline-text-4" id="text-1-3-4">

<p>    A module compiling C files and building c libraries. It's mainly
    involved in calling external commands.
</p></div>

</div>

<div id="outline-container-1-3-5" class="outline-4">
<h4 id="sec-1-3-5"><a href="file:///Users/bobzhang1988/ocaml/utils/consistbl.ml">utils:consistbl</a></h4>
<div class="outline-text-4" id="text-1-3-5">

<p>    It's a module for checking consistency of module CRCs.
</p>
</div>

</div>

<div id="outline-container-1-3-6" class="outline-4">
<h4 id="sec-1-3-6"><a href="file:///Users/bobzhang1988/ocaml/utils/tbl.ml">utils:tbl</a></h4>
<div class="outline-text-4" id="text-1-3-6">

<p>    A map data structure.(Since the bootstrapping for the ocamlc does
    not rely on stdlib)
</p>

</div>

</div>

<div id="outline-container-1-3-7" class="outline-4">
<h4 id="sec-1-3-7"><a href="file:///Users/bobzhang1988/ocaml/utils/terminfo.ml">utils:terminfo</a></h4>
<div class="outline-text-4" id="text-1-3-7">


</div>

</div>

<div id="outline-container-1-3-8" class="outline-4">
<h4 id="sec-1-3-8"><a href="file:///Users/bobzhang1988/ocaml/utils/warnings.ml">utils:warnings</a></h4>
<div class="outline-text-4" id="text-1-3-8">

<p>    A module defining different warnings.
</p></div>
</div>

</div>

<div id="outline-container-1-4" class="outline-3">
<h3 id="sec-1-4">bytecomp</h3>
<div class="outline-text-3" id="text-1-4">

<p>   When we get <code>typedtree</code> output, we will compile it to byte code.
   module <code>Lambda</code> defines the intermediate language. module <code>Typeopt</code>
   introduced some type-based optimizations.  module <code>Bytegen</code> defines
   generation of bytecode from lambda terms. module <code>Emitcode</code> defined
   generation of bytecode for <code>cmo</code> files.
</p>

</div>

<div id="outline-container-1-4-1" class="outline-4">
<h4 id="sec-1-4-1"><a href="file:///Users/bobzhang1988/ocaml/bytecomp/symtable.ml">bytecomp:symtable</a></h4>
<div class="outline-text-4" id="text-1-4-1">




<pre class="src src-ocaml"><span style="color: #ff7f00; font-weight: bold;">val</span> <span style="color: #dfaf8f;">get_global_value </span><span style="color: #eadd83;">:</span> <span style="color: #8cd0d3;">Ident.t </span><span style="color: #eadd83;">-&gt;</span><span style="color: #8cd0d3;"> Obj.t    </span>
</pre>

</div>

</div>

<div id="outline-container-1-4-2" class="outline-4">
<h4 id="sec-1-4-2"><a href="file:///Users/bobzhang1988/ocaml/bytecomp/translmod.ml">bytecomp:translmod</a></h4>
<div class="outline-text-4" id="text-1-4-2">

<p>    A module which translate typedtree to lamda terms
</p>



<pre class="src src-ocaml"><span style="color: #ff7f00; font-weight: bold;">val</span> <span style="color: #dfaf8f;">transl_toplevel_definition</span><span style="color: #eadd83;">:</span> <span style="color: #8cd0d3;">structure </span><span style="color: #eadd83;">-&gt;</span><span style="color: #8cd0d3;"> lambda    </span>
</pre>


</div>

</div>

<div id="outline-container-1-4-3" class="outline-4">
<h4 id="sec-1-4-3"><a href="file:///Users/bobzhang1988/ocaml/bytecomp/simplif.ml">bytecomp:simplif</a></h4>
<div class="outline-text-4" id="text-1-4-3">

<p>    A module eliminate useless Alias bindings.
</p>


<pre class="src src-ocaml"><span style="color: #ff7f00; font-weight: bold;">val</span> <span style="color: #dfaf8f;">simplify_lambda </span><span style="color: #eadd83;">:</span> <span style="color: #8cd0d3;">Lambda.lambda </span><span style="color: #eadd83;">-&gt;</span><span style="color: #8cd0d3;"> Lambda.lambda</span>
<span style="color: #ff7f00; font-weight: bold;">val</span> <span style="color: #dfaf8f;">is_tail_native_heuristic </span><span style="color: #eadd83;">:</span> <span style="color: #eadd83;">ref</span><span style="color: #8cd0d3;"> </span><span style="color: #eadd83;">(</span><span style="color: #8cd0d3;">int </span><span style="color: #eadd83;">-&gt;</span><span style="color: #8cd0d3;"> bool</span><span style="color: #eadd83;">)</span>
</pre>


</div>

</div>

<div id="outline-container-1-4-4" class="outline-4">
<h4 id="sec-1-4-4"><a href="file:///Users/bobzhang1988/ocaml/bytecomp/bytegen.ml">bytecomp:bytegen</a></h4>
<div class="outline-text-4" id="text-1-4-4">

<p>    A module translate lambda terms to lists of instructions
</p>


<pre class="src src-ocaml"><span style="color: #ff7f00; font-weight: bold;">val</span> <span style="color: #dfaf8f;">compile_implementation</span><span style="color: #eadd83;">:</span> <span style="color: #8cd0d3;">string </span><span style="color: #eadd83;">-&gt;</span><span style="color: #8cd0d3;"> lambda </span><span style="color: #eadd83;">-&gt;</span><span style="color: #8cd0d3;"> instruction list</span>
<span style="color: #7f9f7f;">(* </span><span style="color: #7f9f7f; font-style: italic;">the first argument is a module name </span><span style="color: #7f9f7f;">*)</span>

<span style="color: #ff7f00; font-weight: bold;">val</span> <span style="color: #dfaf8f;">compile_phrase</span><span style="color: #eadd83;">:</span> <span style="color: #8cd0d3;">lambda </span><span style="color: #eadd83;">-&gt;</span><span style="color: #8cd0d3;"> instruction list </span><span style="color: #eadd83;">*</span><span style="color: #8cd0d3;"> instruction list</span>
<span style="color: #7f9f7f;">(* </span><span style="color: #7f9f7f; font-style: italic;">return (init_code,fun_code0 as a tuple </span><span style="color: #7f9f7f;">*)</span>
</pre>


</div>

</div>

<div id="outline-container-1-4-5" class="outline-4">
<h4 id="sec-1-4-5"><a href="file:///Users/bobzhang1988/ocaml/bytecomp/emitcode.ml">bytecomp:emitcode</a></h4>
<div class="outline-text-4" id="text-1-4-5">





<pre class="src src-ocaml"><span style="color: #ff7f00; font-weight: bold;">val</span> <span style="color: #dfaf8f;">to_memory</span><span style="color: #eadd83;">:</span> <span style="color: #8cd0d3;">instruction list </span><span style="color: #eadd83;">-&gt;</span><span style="color: #8cd0d3;"> instruction list </span><span style="color: #eadd83;">-&gt;</span>
                    string <span style="color: #eadd83;">*</span> int <span style="color: #eadd83;">*</span> <span style="color: #eadd83;">(</span>reloc_info <span style="color: #eadd83;">*</span> int<span style="color: #eadd83;">)</span> list
        <span style="color: #7f9f7f;">(* </span><span style="color: #7f9f7f; font-style: italic;">Arguments:</span>
<span style="color: #7f9f7f; font-style: italic;">             initialization code (terminated by STOP)</span>
<span style="color: #7f9f7f; font-style: italic;">             function code</span>
<span style="color: #7f9f7f; font-style: italic;">           Results:</span>
<span style="color: #7f9f7f; font-style: italic;">             block of relocatable bytecode</span>
<span style="color: #7f9f7f; font-style: italic;">             size of this block</span>
<span style="color: #7f9f7f; font-style: italic;">             relocation information </span><span style="color: #7f9f7f;">*)</span>
</pre>


</div>

</div>

<div id="outline-container-1-4-6" class="outline-4">
<h4 id="sec-1-4-6"><a href="file:///Users/bobzhang1988/ocaml/bytecomp/meta.ml">bytecomp:meta</a></h4>
<div class="outline-text-4" id="text-1-4-6">


<p>
    A module to control the runtime system and bytecode interpreter.
    It was written in C language.
</p>
</div>
</div>

</div>

<div id="outline-container-1-5" class="outline-3">
<h3 id="sec-1-5">driver</h3>
<div class="outline-text-3" id="text-1-5">


</div>

<div id="outline-container-1-5-1" class="outline-4">
<h4 id="sec-1-5-1"><a href="file:///Users/bobzhang1988/ocaml/driver/main.ml">driver:main</a></h4>
<div class="outline-text-4" id="text-1-5-1">




<pre class="src src-shell-script">cp ../ocaml/driver/main.ml main.ml
ocamlc -I +compiler-libs -I +unix -c main.ml
ocamlc -o vanilla -I +compiler-libs ocamlcommon.cma ocamlbytecomp.cma main.cmo
cp ../ocaml/driver/optmain.ml optmain.ml
ocamlc -I +compiler-libs -I +unix -c optmain.ml
ocamlc -o vanillaopt -I +compiler-libs ocamlcommon.cma ocamloptcomp.cma optmain.cmo     
</pre>


<p>
    To build a <code>vanilla ocamlc</code>, we need the original main.ml and link
    it with <code>ocamlcommon.cma</code> and <code>ocamlbytecomp.cma</code>. <code>main.ml</code> must
    be copied from the original source tree, since it is not included
    in the compiler-libs.
</p>
<p>
    For the native code compiler, instead of <code>main.ml</code> and
    <code>ocamlbytecomp.cma</code>, we use <code>optmain.ml</code> and <code>ocamloptcompo.cma</code>.
</p>
<p>
    Now you have two executables vanilla and vanillaopt, which are
    actually clones of ocamlc and ocamlopt. Try using them to compile
    some simple modules to see they are really working.
</p></div>

</div>

<div id="outline-container-1-5-2" class="outline-4">
<h4 id="sec-1-5-2"><a href="file:///Users/bobzhang1988/ocaml/driver/compile.ml">driver:compile</a></h4>
<div class="outline-text-4" id="text-1-5-2">


<p>
    Compile workflow(form <i>.ml</i> file):
</p>

<p>
    <a name="Compiler-FLOW" class="target">Compiler FLOW</a> 
</p>


<pre class="src src-ocaml"><span style="color: #8cd0d3;">Pparse</span>.file ppf inputfile <span style="color: #8cd0d3;">Parse</span>.implementation ast_impl_magic_number
<span style="color: #eadd83;">++</span> print_if ppf <span style="color: #8cd0d3;">Clflags</span>.dump_parsetree <span style="color: #8cd0d3;">Printast</span>.implementation
<span style="color: #eadd83;">++</span> <span style="color: #8cd0d3;">Typemod</span>.type_implementation sourcefile outputprefix modulename env
<span style="color: #eadd83;">++</span> <span style="color: #8cd0d3;">Translmod</span>.transl_implementation modulename
<span style="color: #eadd83;">++</span> print_if ppf <span style="color: #8cd0d3;">Clflags</span>.dump_rawlambda <span style="color: #8cd0d3;">Printlambda</span>.lambda
<span style="color: #eadd83;">++</span> <span style="color: #8cd0d3;">Simplif</span>.simplify_lambda
<span style="color: #eadd83;">++</span> print_if ppf <span style="color: #8cd0d3;">Clflags</span>.dump_lambda <span style="color: #8cd0d3;">Printlambda</span>.lambda
<span style="color: #eadd83;">++</span> <span style="color: #8cd0d3;">Bytegen</span>.compile_implementation modulename
<span style="color: #eadd83;">++</span> print_if ppf <span style="color: #8cd0d3;">Clflags</span>.dump_instr <span style="color: #8cd0d3;">Printinstr</span>.instrlist
<span style="color: #eadd83;">++</span> <span style="color: #8cd0d3;">Emitcode</span>.to_file oc modulename<span style="color: #eadd83;">;</span>
</pre>


</div>

</div>

<div id="outline-container-1-5-3" class="outline-4">
<h4 id="sec-1-5-3"><a href="file:///Users/bobzhang1988/ocaml/driver/main_args.ml">driver:main_args</a></h4>
<div class="outline-text-4" id="text-1-5-3">



</div>
</div>

</div>

<div id="outline-container-1-6" class="outline-3">
<h3 id="sec-1-6">toplevel</h3>
<div class="outline-text-3" id="text-1-6">


</div>

<div id="outline-container-1-6-1" class="outline-4">
<h4 id="sec-1-6-1"><a href="file:///Users/bobzhang1988/ocaml/toplevel/topmain.ml">toplevel:topmain</a></h4>
<div class="outline-text-4" id="text-1-6-1">

</div>

</div>

<div id="outline-container-1-6-2" class="outline-4">
<h4 id="sec-1-6-2"><a href="file:///Users/bobzhang1988/ocaml/toplevel/toploop.ml">toplevel:toploop</a></h4>
<div class="outline-text-4" id="text-1-6-2">

<p>    There are two kinds of environment, one is for <code>obj</code>:
    <code>Toploop.toplevel_value_bindings</code>, the other is for <code>typing</code>,
    <code>Toploop.toplevel_env</code>.
</p>



<pre class="src src-ocaml"><span style="color: #7f9f7f;">(* </span><span style="color: #7f9f7f; font-style: italic;">The table of toplevel value bindings and its accessors </span><span style="color: #7f9f7f;">*)</span>

<span style="color: #ff7f00; font-weight: bold;">let</span> <span style="color: #dfaf8f;">toplevel_value_bindings </span><span style="color: #eadd83;">=</span>
  <span style="color: #eadd83;">(</span><span style="color: #8cd0d3;">Hashtbl</span>.create 37 <span style="color: #eadd83;">:</span> <span style="color: #eadd83;">(</span><span style="color: #8cd0d3;">string</span><span style="color: #eadd83;">,</span><span style="color: #8cd0d3;"> Obj.t</span><span style="color: #eadd83;">)</span><span style="color: #8cd0d3;"> Hashtbl.t</span><span style="color: #eadd83;">)</span>

<span style="color: #ff7f00; font-weight: bold;">let</span> <span style="color: #8cd0d3;">getvalue</span><span style="color: #dfaf8f;"> name </span><span style="color: #eadd83;">=</span>
  <span style="color: #f0dfaf; font-weight: bold;">try</span>
    <span style="color: #8cd0d3;">Hashtbl</span>.find toplevel_value_bindings name
  <span style="color: #f0dfaf; font-weight: bold;">with</span> Not_found <span style="color: #eadd83;">-&gt;</span>
    fatal_error <span style="color: #eadd83;">(</span>name <span style="color: #eadd83;">^</span> <span style="color: #cc9393;">" unbound at toplevel"</span><span style="color: #eadd83;">)</span>

<span style="color: #ff7f00; font-weight: bold;">let</span> <span style="color: #8cd0d3;">setvalue</span><span style="color: #dfaf8f;"> name v </span><span style="color: #eadd83;">=</span>
  <span style="color: #8cd0d3;">Hashtbl</span>.replace toplevel_value_bindings name v
</pre>

<p>
    <code>Toploop.eval_path</code> has type <code>Path.t -&gt; Obj.t</code> which will consult
    the environment to get the object.
</p>



<pre class="src src-ocaml"><span style="color: #ff7f00; font-weight: bold;">let</span> <span style="color: #ff7f00; font-weight: bold;">rec</span> <span style="color: #8cd0d3;">eval_path</span><span style="color: #dfaf8f;"> </span><span style="color: #eadd83;">=</span> <span style="color: #f0dfaf; font-weight: bold;">function</span>
 <span style="color: #dfaf8f;"> </span><span style="color: #eadd83;">|</span> Pident id <span style="color: #eadd83;">-&gt;</span>
      <span style="color: #f0dfaf; font-weight: bold;">if</span> <span style="color: #8cd0d3;">Ident</span>.persistent id <span style="color: #eadd83;">||</span> <span style="color: #8cd0d3;">Ident</span>.global id <span style="color: #f0dfaf; font-weight: bold;">then</span>
        <span style="color: #8cd0d3;">Symtable</span>.get_global_value id
      <span style="color: #f0dfaf; font-weight: bold;">else</span> <span style="color: #ff7f00; font-weight: bold;">begin</span>
        <span style="color: #ff7f00; font-weight: bold;">let</span> <span style="color: #dfaf8f;">name </span><span style="color: #eadd83;">=</span> <span style="color: #8cd0d3;">Translmod</span>.toplevel_name id <span style="color: #ff7f00; font-weight: bold;">in</span>
        <span style="color: #f0dfaf; font-weight: bold;">try</span>
          <span style="color: #8cd0d3;">Hashtbl</span>.find toplevel_value_bindings name
        <span style="color: #f0dfaf; font-weight: bold;">with</span> Not_found <span style="color: #eadd83;">-&gt;</span>
          <span style="color: #f0dfaf; font-weight: bold;">raise</span> <span style="color: #eadd83;">(</span><span style="color: #8cd0d3;">Symtable</span>.Error<span style="color: #eadd83;">(</span><span style="color: #8cd0d3;">Symtable</span>.Undefined_global name<span style="color: #eadd83;">))</span>
      <span style="color: #ff7f00; font-weight: bold;">end</span>
  <span style="color: #eadd83;">|</span> Pdot<span style="color: #eadd83;">(</span>p<span style="color: #eadd83;">,</span> s<span style="color: #eadd83;">,</span> pos<span style="color: #eadd83;">)</span> <span style="color: #eadd83;">-&gt;</span>
      <span style="color: #8cd0d3;">Obj</span>.field <span style="color: #eadd83;">(</span>eval_path p<span style="color: #eadd83;">)</span> pos
  <span style="color: #eadd83;">|</span> Papply<span style="color: #eadd83;">(</span>p1<span style="color: #eadd83;">,</span> p2<span style="color: #eadd83;">)</span> <span style="color: #eadd83;">-&gt;</span>
      fatal_error <span style="color: #cc9393;">"Toploop.eval_path"</span>
</pre>



<pre class="src src-ocaml"><span style="color: #ff7f00; font-weight: bold;">let</span> <span style="color: #8cd0d3;">set_paths</span><span style="color: #dfaf8f;"> </span><span style="color: #eadd83;">()</span><span style="color: #dfaf8f;"> </span><span style="color: #eadd83;">=</span>
  <span style="color: #7f9f7f;">(* </span><span style="color: #7f9f7f; font-style: italic;">Add whatever -I options have been specified on the command line,</span>
<span style="color: #7f9f7f; font-style: italic;">     but keep the directories that user code linked in with ocamlmktop</span>
<span style="color: #7f9f7f; font-style: italic;">     may have added to load_path. </span><span style="color: #7f9f7f;">*)</span>
  load_path <span style="color: #eadd83;">:=</span> <span style="color: #eadd83;">!</span>load_path <span style="color: #eadd83;">@</span> <span style="color: #eadd83;">[</span><span style="color: #8cd0d3;">Filename</span>.concat <span style="color: #8cd0d3;">Config</span>.standard_library <span style="color: #cc9393;">"camlp4"</span><span style="color: #eadd83;">];</span>
  load_path <span style="color: #eadd83;">:=</span> <span style="color: #cc9393;">""</span> <span style="color: #eadd83;">::</span> <span style="color: #eadd83;">(</span><span style="color: #8cd0d3;">List</span>.rev <span style="color: #eadd83;">!</span><span style="color: #8cd0d3;">Clflags</span>.include_dirs <span style="color: #eadd83;">@</span> <span style="color: #eadd83;">!</span>load_path<span style="color: #eadd83;">);</span>
  <span style="color: #8cd0d3;">Dll</span>.add_path <span style="color: #eadd83;">!</span>load_path
</pre>


<p>
    There's a <code>directive_table</code> to config the toplevel
</p>


<pre class="src src-ocaml"><span style="color: #eadd83;">|</span> Ptop_dir<span style="color: #eadd83;">(</span>dir_name<span style="color: #eadd83;">,</span> dir_arg<span style="color: #eadd83;">)</span> <span style="color: #eadd83;">-&gt;</span>
    <span style="color: #f0dfaf; font-weight: bold;">try</span>
      <span style="color: #f0dfaf; font-weight: bold;">match</span> <span style="color: #eadd83;">(</span><span style="color: #8cd0d3;">Hashtbl</span>.find directive_table dir_name<span style="color: #eadd83;">,</span> dir_arg<span style="color: #eadd83;">)</span> <span style="color: #f0dfaf; font-weight: bold;">with</span>
      <span style="color: #eadd83;">|</span> <span style="color: #eadd83;">(</span>Directive_none f<span style="color: #eadd83;">,</span> Pdir_none<span style="color: #eadd83;">)</span> <span style="color: #eadd83;">-&gt;</span> f <span style="color: #eadd83;">();</span> <span style="color: #bfebbf;">true</span>
      <span style="color: #eadd83;">|</span> <span style="color: #eadd83;">(</span>Directive_string f<span style="color: #eadd83;">,</span> Pdir_string s<span style="color: #eadd83;">)</span> <span style="color: #eadd83;">-&gt;</span> f s<span style="color: #eadd83;">;</span> <span style="color: #bfebbf;">true</span>
      <span style="color: #eadd83;">|</span> <span style="color: #eadd83;">(</span>Directive_int f<span style="color: #eadd83;">,</span> Pdir_int n<span style="color: #eadd83;">)</span> <span style="color: #eadd83;">-&gt;</span> f n<span style="color: #eadd83;">;</span> <span style="color: #bfebbf;">true</span>
      <span style="color: #eadd83;">|</span> <span style="color: #eadd83;">(</span>Directive_ident f<span style="color: #eadd83;">,</span> Pdir_ident lid<span style="color: #eadd83;">)</span> <span style="color: #eadd83;">-&gt;</span> f lid<span style="color: #eadd83;">;</span> <span style="color: #bfebbf;">true</span>
      <span style="color: #eadd83;">|</span> <span style="color: #eadd83;">(</span>Directive_bool f<span style="color: #eadd83;">,</span> Pdir_bool b<span style="color: #eadd83;">)</span> <span style="color: #eadd83;">-&gt;</span> f b<span style="color: #eadd83;">;</span> <span style="color: #bfebbf;">true</span>
      <span style="color: #eadd83;">|</span> <span style="color: #eadd83;">(</span>_<span style="color: #eadd83;">,</span> _<span style="color: #eadd83;">)</span> <span style="color: #eadd83;">-&gt;</span>
          fprintf ppf <span style="color: #cc9393;">"Wrong type of argument for directive `%s'.@."</span> dir_name<span style="color: #eadd83;">;</span>
          <span style="color: #bfebbf;">false</span>
</pre>

</div>

</div>

<div id="outline-container-1-6-3" class="outline-4">
<h4 id="sec-1-6-3"><a href="file:///Users/bobzhang1988/ocaml/toplevel/genprintval.ml">toplevel:genprintval</a></h4>
<div class="outline-text-4" id="text-1-6-3">


</div>
</div>

</div>

<div id="outline-container-1-7" class="outline-3">
<h3 id="sec-1-7">pipeline</h3>
<div class="outline-text-3" id="text-1-7">

<ul>
<li>parsing



<pre class="src src-ocaml"><span style="color: #ff7f00; font-weight: bold;">let</span>
<span style="color: #eadd83;">[{</span><span style="color: #8cd0d3;">Parsetree</span>.pstr_desc <span style="color: #eadd83;">=</span> <span style="color: #8cd0d3;">Parsetree</span>.Pstr_value <span style="color: #eadd83;">(</span>_<span style="color: #eadd83;">,[</span>_<span style="color: #eadd83;">,</span>e<span style="color: #eadd83;">])}]</span>
<span style="color: #eadd83;">=</span> <span style="color: #8cd0d3;">Parse</span>.implementation
    <span style="color: #eadd83;">(</span><span style="color: #8cd0d3;">Lexing</span>.from_string
       <span style="color: #cc9393;">"let a = for i = 1 to 10 do print_int i done ;;"</span><span style="color: #eadd83;">);;</span>

Characters 4<span style="color: #eadd83;">-</span>60<span style="color: #eadd83;">:</span>
  <span style="color: #eadd83;">[{</span><span style="color: #8cd0d3;">Parsetree</span>.pstr_desc <span style="color: #eadd83;">=</span> <span style="color: #8cd0d3;">Parsetree</span>.Pstr_value <span style="color: #eadd83;">(</span>_<span style="color: #eadd83;">,[</span>_<span style="color: #eadd83;">,</span>e<span style="color: #eadd83;">])}]</span>
  <span style="color: #eadd83;">^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^</span>
Warning 8<span style="color: #eadd83;">:</span> <span style="color: #8cd0d3;">this pattern</span><span style="color: #eadd83;">-</span><span style="color: #8cd0d3;">matching is </span><span style="color: #eadd83;">not</span><span style="color: #8cd0d3;"> exhaustive.</span>
Here is an example <span style="color: #f0dfaf; font-weight: bold;">of</span> a value that is <span style="color: #eadd83;">not</span> <span style="color: #dfaf8f;">matched</span><span style="color: #eadd83;">:</span>
<span style="color: #eadd83;">[]</span>
<span style="color: #ff7f00; font-weight: bold;">val</span> <span style="color: #dfaf8f;">e </span><span style="color: #eadd83;">:</span> <span style="color: #8cd0d3;">Parsetree.expression </span><span style="color: #eadd83;">=</span>
  <span style="color: #eadd83;">{</span>pexp_desc <span style="color: #eadd83;">=</span>
    Pexp_for <span style="color: #eadd83;">({</span><span style="color: #8cd0d3;">Asttypes</span>.txt <span style="color: #eadd83;">=</span> <span style="color: #cc9393;">"i"</span><span style="color: #eadd83;">;</span> loc <span style="color: #eadd83;">=</span> <span style="color: #eadd83;">},</span>
     <span style="color: #eadd83;">{</span>pexp_desc <span style="color: #eadd83;">=</span> Pexp_constant <span style="color: #eadd83;">(</span>Const_int 1<span style="color: #eadd83;">);</span> pexp_loc <span style="color: #eadd83;">=</span> <span style="color: #eadd83;">},</span>
     <span style="color: #eadd83;">{</span>pexp_desc <span style="color: #eadd83;">=</span> Pexp_constant <span style="color: #eadd83;">(</span>Const_int 10<span style="color: #eadd83;">);</span> pexp_loc <span style="color: #eadd83;">=</span> <span style="color: #eadd83;">},</span> Upto<span style="color: #eadd83;">,</span>
     <span style="color: #eadd83;">{</span>pexp_desc <span style="color: #eadd83;">=</span>
       Pexp_apply
        <span style="color: #eadd83;">({</span>pexp_desc <span style="color: #eadd83;">=</span>
           Pexp_ident <span style="color: #eadd83;">{</span><span style="color: #8cd0d3;">Asttypes</span>.txt <span style="color: #eadd83;">=</span> <span style="color: #8cd0d3;">Longident</span>.Lident <span style="color: #cc9393;">"print_int"</span><span style="color: #eadd83;">;</span> loc <span style="color: #eadd83;">=</span> <span style="color: #eadd83;">};</span>
          pexp_loc <span style="color: #eadd83;">=</span> <span style="color: #eadd83;">},</span>
        <span style="color: #eadd83;">[(</span><span style="color: #cc9393;">""</span><span style="color: #eadd83;">,</span>
          <span style="color: #eadd83;">{</span>pexp_desc <span style="color: #eadd83;">=</span>
            Pexp_ident <span style="color: #eadd83;">{</span><span style="color: #8cd0d3;">Asttypes</span>.txt <span style="color: #eadd83;">=</span> <span style="color: #8cd0d3;">Longident</span>.Lident <span style="color: #cc9393;">"i"</span><span style="color: #eadd83;">;</span> loc <span style="color: #eadd83;">=</span> <span style="color: #eadd83;">};</span>
           pexp_loc <span style="color: #eadd83;">=</span> <span style="color: #eadd83;">})]);</span>
      pexp_loc <span style="color: #eadd83;">=</span> <span style="color: #eadd83;">});</span>
   pexp_loc <span style="color: #eadd83;">=</span> <span style="color: #eadd83;">}</span>
</pre>

</li>
<li>typing



<pre class="src src-ocaml"><span style="color: #ff7f00; font-weight: bold;">let</span> <span style="color: #dfaf8f;">b </span><span style="color: #eadd83;">=</span> <span style="color: #8cd0d3;">Typecore</span>.type_expression <span style="color: #eadd83;">!</span><span style="color: #8cd0d3;">Toploop</span>.toplevel_env e<span style="color: #eadd83;">;;</span>

<span style="color: #ff7f00; font-weight: bold;">val</span> <span style="color: #dfaf8f;">b </span><span style="color: #eadd83;">:</span> <span style="color: #8cd0d3;">Typedtree.expression </span><span style="color: #eadd83;">=</span>
  <span style="color: #eadd83;">{</span><span style="color: #8cd0d3;">Typedtree</span>.exp_desc <span style="color: #eadd83;">=</span>
    <span style="color: #8cd0d3;">Typedtree</span>.Texp_for <span style="color: #eadd83;">({</span><span style="color: #8cd0d3;">Ident</span>.stamp <span style="color: #eadd83;">=</span> 3515<span style="color: #eadd83;">;</span> name <span style="color: #eadd83;">=</span> <span style="color: #cc9393;">"i"</span><span style="color: #eadd83;">;</span> flags <span style="color: #eadd83;">=</span> 0<span style="color: #eadd83;">},</span>
     <span style="color: #eadd83;">{</span><span style="color: #8cd0d3;">Asttypes</span>.txt <span style="color: #eadd83;">=</span> <span style="color: #cc9393;">"i"</span><span style="color: #eadd83;">;</span> loc <span style="color: #eadd83;">=</span> <span style="color: #eadd83;">},</span>
     <span style="color: #eadd83;">{</span><span style="color: #8cd0d3;">Typedtree</span>.exp_desc <span style="color: #eadd83;">=</span> <span style="color: #8cd0d3;">Typedtree</span>.Texp_constant <span style="color: #eadd83;">(</span>Const_int 1<span style="color: #eadd83;">);</span> exp_loc <span style="color: #eadd83;">=</span> <span style="color: #eadd83;">;</span>
      exp_extra <span style="color: #eadd83;">=</span> <span style="color: #eadd83;">[];</span>
      exp_type <span style="color: #eadd83;">=</span>
       <span style="color: #eadd83;">{</span><span style="color: #8cd0d3;">Types</span>.desc <span style="color: #eadd83;">=</span>
         <span style="color: #8cd0d3;">Types</span>.Tlink
          <span style="color: #eadd83;">{</span><span style="color: #8cd0d3;">Types</span>.desc <span style="color: #eadd83;">=</span>
            <span style="color: #8cd0d3;">Types</span>.Tconstr
             <span style="color: #eadd83;">(</span><span style="color: #8cd0d3;">Path</span>.Pident <span style="color: #eadd83;">{</span><span style="color: #8cd0d3;">Ident</span>.stamp <span style="color: #eadd83;">=</span> 1<span style="color: #eadd83;">;</span> name <span style="color: #eadd83;">=</span> <span style="color: #cc9393;">"int"</span><span style="color: #eadd83;">;</span> flags <span style="color: #eadd83;">=</span> 0<span style="color: #eadd83;">},</span> 
             <span style="color: #eadd83;">[],</span> <span style="color: #eadd83;">{</span>contents <span style="color: #eadd83;">=</span> <span style="color: #8cd0d3;">Types</span>.Mnil<span style="color: #eadd83;">});</span>
           level <span style="color: #eadd83;">=</span> 3515<span style="color: #eadd83;">;</span> id <span style="color: #eadd83;">=</span> 45681<span style="color: #eadd83;">};</span>
        level <span style="color: #eadd83;">=</span> 3515<span style="color: #eadd83;">;</span> id <span style="color: #eadd83;">=</span> 45680<span style="color: #eadd83;">};</span>
      exp_env <span style="color: #eadd83;">=</span> <span style="color: #eadd83;">&lt;</span>abstr<span style="color: #eadd83;">&gt;},</span>
     <span style="color: #eadd83;">{</span><span style="color: #8cd0d3;">Typedtree</span>.exp_desc <span style="color: #eadd83;">=</span> <span style="color: #8cd0d3;">Typedtree</span>.Texp_constant <span style="color: #eadd83;">(</span>Const_int 10<span style="color: #eadd83;">);</span>
      exp_loc <span style="color: #eadd83;">=</span> <span style="color: #eadd83;">;</span> exp_extra <span style="color: #eadd83;">=</span> <span style="color: #eadd83;">[];</span>
      exp_type <span style="color: #eadd83;">=</span>
       <span style="color: #eadd83;">{</span><span style="color: #8cd0d3;">Types</span>.desc <span style="color: #eadd83;">=</span>
         <span style="color: #8cd0d3;">Types</span>.Tlink
          <span style="color: #eadd83;">{</span><span style="color: #8cd0d3;">Types</span>.desc <span style="color: #eadd83;">=</span>
            <span style="color: #8cd0d3;">Types</span>.Tconstr
             <span style="color: #eadd83;">(</span><span style="color: #8cd0d3;">Path</span>.Pident <span style="color: #eadd83;">{</span><span style="color: #8cd0d3;">Ident</span>.stamp <span style="color: #eadd83;">=</span> 1<span style="color: #eadd83;">;</span> name <span style="color: #eadd83;">=</span> <span style="color: #cc9393;">"int"</span><span style="color: #eadd83;">;</span> flags <span style="color: #eadd83;">=</span> 0<span style="color: #eadd83;">},</span> 
             <span style="color: #eadd83;">[],</span> <span style="color: #eadd83;">{</span>contents <span style="color: #eadd83;">=</span> <span style="color: #8cd0d3;">Types</span>.Mnil<span style="color: #eadd83;">});</span>
           level <span style="color: #eadd83;">=</span> 3515<span style="color: #eadd83;">;</span> id <span style="color: #eadd83;">=</span> 45683<span style="color: #eadd83;">};</span>
        level <span style="color: #eadd83;">=</span> 3515<span style="color: #eadd83;">;</span> id <span style="color: #eadd83;">=</span> 45682<span style="color: #eadd83;">};</span>
      exp_env <span style="color: #eadd83;">=</span> <span style="color: #eadd83;">&lt;</span>abstr<span style="color: #eadd83;">&gt;},</span>
     Upto<span style="color: #eadd83;">,</span>
     <span style="color: #eadd83;">{</span><span style="color: #8cd0d3;">Typedtree</span>.exp_desc <span style="color: #eadd83;">=</span>
       <span style="color: #8cd0d3;">Typedtree</span>.Texp_apply
        <span style="color: #eadd83;">({</span><span style="color: #8cd0d3;">Typedtree</span>.exp_desc <span style="color: #eadd83;">=</span>
           <span style="color: #8cd0d3;">Typedtree</span>.Texp_ident
            <span style="color: #eadd83;">(</span><span style="color: #8cd0d3;">Path</span>.Pdot
              <span style="color: #eadd83;">(</span><span style="color: #8cd0d3;">Path</span>.Pident <span style="color: #eadd83;">{</span><span style="color: #8cd0d3;">Ident</span>.stamp <span style="color: #eadd83;">=</span> 0<span style="color: #eadd83;">;</span> name <span style="color: #eadd83;">=</span> <span style="color: #cc9393;">"Format"</span><span style="color: #eadd83;">;</span> flags <span style="color: #eadd83;">=</span> 1<span style="color: #eadd83;">},</span>
              <span style="color: #cc9393;">"print_int"</span><span style="color: #eadd83;">,</span> 4<span style="color: #eadd83;">),</span>
            <span style="color: #eadd83;">{</span><span style="color: #8cd0d3;">Asttypes</span>.txt <span style="color: #eadd83;">=</span> <span style="color: #8cd0d3;">Longident</span>.Lident <span style="color: #cc9393;">"print_int"</span><span style="color: #eadd83;">;</span> loc <span style="color: #eadd83;">=</span> <span style="color: #eadd83;">},</span>
            <span style="color: #eadd83;">{</span><span style="color: #8cd0d3;">Types</span>.val_type <span style="color: #eadd83;">=</span>
              <span style="color: #eadd83;">{</span><span style="color: #8cd0d3;">Types</span>.desc <span style="color: #eadd83;">=</span>
                <span style="color: #8cd0d3;">Types</span>.Tarrow <span style="color: #eadd83;">(</span><span style="color: #cc9393;">""</span><span style="color: #eadd83;">,</span>
                 <span style="color: #eadd83;">{</span><span style="color: #8cd0d3;">Types</span>.desc <span style="color: #eadd83;">=</span>
                   <span style="color: #8cd0d3;">Types</span>.Tconstr
                    <span style="color: #eadd83;">(</span><span style="color: #8cd0d3;">Path</span>.Pident <span style="color: #eadd83;">{</span><span style="color: #8cd0d3;">Ident</span>.stamp <span style="color: #eadd83;">=</span> 1<span style="color: #eadd83;">;</span> name <span style="color: #eadd83;">=</span> <span style="color: #cc9393;">"int"</span><span style="color: #eadd83;">;</span> flags <span style="color: #eadd83;">=</span> 0<span style="color: #eadd83;">},</span>
                    <span style="color: #eadd83;">[],</span> <span style="color: #eadd83;">{</span>contents <span style="color: #eadd83;">=</span> <span style="color: #8cd0d3;">Types</span>.Mnil<span style="color: #eadd83;">});</span>
                  level <span style="color: #eadd83;">=</span> 100000000<span style="color: #eadd83;">;</span> id <span style="color: #eadd83;">=</span> 3906<span style="color: #eadd83;">},</span>
                 <span style="color: #eadd83;">{</span><span style="color: #8cd0d3;">Types</span>.desc <span style="color: #eadd83;">=</span>
                   <span style="color: #8cd0d3;">Types</span>.Tconstr
                    <span style="color: #eadd83;">(</span><span style="color: #8cd0d3;">Path</span>.Pident <span style="color: #eadd83;">{</span><span style="color: #8cd0d3;">Ident</span>.stamp <span style="color: #eadd83;">=</span> 6<span style="color: #eadd83;">;</span> name <span style="color: #eadd83;">=</span> <span style="color: #cc9393;">"unit"</span><span style="color: #eadd83;">;</span> flags <span style="color: #eadd83;">=</span> 0<span style="color: #eadd83;">},</span>
                    <span style="color: #eadd83;">[],</span> <span style="color: #eadd83;">{</span>contents <span style="color: #eadd83;">=</span> <span style="color: #8cd0d3;">Types</span>.Mnil<span style="color: #eadd83;">});</span>
                  level <span style="color: #eadd83;">=</span> 100000000<span style="color: #eadd83;">;</span> id <span style="color: #eadd83;">=</span> 3905<span style="color: #eadd83;">},</span>
                 <span style="color: #8cd0d3;">Types</span>.Cok<span style="color: #eadd83;">);</span>
               level <span style="color: #eadd83;">=</span> 100000000<span style="color: #eadd83;">;</span> id <span style="color: #eadd83;">=</span> 3904<span style="color: #eadd83;">};</span>
             val_kind <span style="color: #eadd83;">=</span> <span style="color: #8cd0d3;">Types</span>.Val_reg<span style="color: #eadd83;">;</span> val_loc <span style="color: #eadd83;">=</span> <span style="color: #eadd83;">});</span>
          exp_loc <span style="color: #eadd83;">=</span> <span style="color: #eadd83;">;</span> exp_extra <span style="color: #eadd83;">=</span> <span style="color: #eadd83;">[];</span>
          exp_type <span style="color: #eadd83;">=</span>
           <span style="color: #eadd83;">{</span><span style="color: #8cd0d3;">Types</span>.desc <span style="color: #eadd83;">=</span>
             <span style="color: #8cd0d3;">Types</span>.Tarrow <span style="color: #eadd83;">(</span><span style="color: #cc9393;">""</span><span style="color: #eadd83;">,</span>
              <span style="color: #eadd83;">{</span><span style="color: #8cd0d3;">Types</span>.desc <span style="color: #eadd83;">=</span>
                <span style="color: #8cd0d3;">Types</span>.Tconstr
                 <span style="color: #eadd83;">(</span><span style="color: #8cd0d3;">Path</span>.Pident <span style="color: #eadd83;">{</span><span style="color: #8cd0d3;">Ident</span>.stamp <span style="color: #eadd83;">=</span> 1<span style="color: #eadd83;">;</span> name <span style="color: #eadd83;">=</span> <span style="color: #cc9393;">"int"</span><span style="color: #eadd83;">;</span> flags <span style="color: #eadd83;">=</span> 0<span style="color: #eadd83;">},</span> 
                 <span style="color: #eadd83;">[],</span> <span style="color: #eadd83;">{</span>contents <span style="color: #eadd83;">=</span> <span style="color: #8cd0d3;">Types</span>.Mnil<span style="color: #eadd83;">});</span>
               level <span style="color: #eadd83;">=</span> 3515<span style="color: #eadd83;">;</span> id <span style="color: #eadd83;">=</span> 45689<span style="color: #eadd83;">},</span>
              <span style="color: #eadd83;">{</span><span style="color: #8cd0d3;">Types</span>.desc <span style="color: #eadd83;">=</span>
                <span style="color: #8cd0d3;">Types</span>.Tconstr
                 <span style="color: #eadd83;">(</span><span style="color: #8cd0d3;">Path</span>.Pident <span style="color: #eadd83;">{</span><span style="color: #8cd0d3;">Ident</span>.stamp <span style="color: #eadd83;">=</span> 6<span style="color: #eadd83;">;</span> name <span style="color: #eadd83;">=</span> <span style="color: #cc9393;">"unit"</span><span style="color: #eadd83;">;</span> flags <span style="color: #eadd83;">=</span> 0<span style="color: #eadd83;">},</span>
                 <span style="color: #eadd83;">[],</span> <span style="color: #eadd83;">{</span>contents <span style="color: #eadd83;">=</span> <span style="color: #8cd0d3;">Types</span>.Mnil<span style="color: #eadd83;">});</span>
               level <span style="color: #eadd83;">=</span> 3515<span style="color: #eadd83;">;</span> id <span style="color: #eadd83;">=</span> 45688<span style="color: #eadd83;">},</span>
              <span style="color: #8cd0d3;">Types</span>.Cok<span style="color: #eadd83;">);</span>
            level <span style="color: #eadd83;">=</span> 3516<span style="color: #eadd83;">;</span> id <span style="color: #eadd83;">=</span> 45687<span style="color: #eadd83;">};</span>
          exp_env <span style="color: #eadd83;">=</span> <span style="color: #eadd83;">&lt;</span>abstr<span style="color: #eadd83;">&gt;},</span>
        <span style="color: #eadd83;">[(</span><span style="color: #cc9393;">""</span><span style="color: #eadd83;">,</span>
          Some
           <span style="color: #eadd83;">{</span><span style="color: #8cd0d3;">Typedtree</span>.exp_desc <span style="color: #eadd83;">=</span>
             <span style="color: #8cd0d3;">Typedtree</span>.Texp_ident
              <span style="color: #eadd83;">(</span><span style="color: #8cd0d3;">Path</span>.Pident <span style="color: #eadd83;">{</span><span style="color: #8cd0d3;">Ident</span>.stamp <span style="color: #eadd83;">=</span> 3515<span style="color: #eadd83;">;</span> name <span style="color: #eadd83;">=</span> <span style="color: #cc9393;">"i"</span><span style="color: #eadd83;">;</span> flags <span style="color: #eadd83;">=</span> 0<span style="color: #eadd83;">},</span>
              <span style="color: #eadd83;">{</span><span style="color: #8cd0d3;">Asttypes</span>.txt <span style="color: #eadd83;">=</span> <span style="color: #8cd0d3;">Longident</span>.Lident <span style="color: #cc9393;">"i"</span><span style="color: #eadd83;">;</span> loc <span style="color: #eadd83;">=</span> <span style="color: #eadd83;">},</span>
              <span style="color: #eadd83;">{</span><span style="color: #8cd0d3;">Types</span>.val_type <span style="color: #eadd83;">=</span>
                <span style="color: #eadd83;">{</span><span style="color: #8cd0d3;">Types</span>.desc <span style="color: #eadd83;">=</span>
                  <span style="color: #8cd0d3;">Types</span>.Tlink
                   <span style="color: #eadd83;">{</span><span style="color: #8cd0d3;">Types</span>.desc <span style="color: #eadd83;">=</span>
                     <span style="color: #8cd0d3;">Types</span>.Tconstr
                      <span style="color: #eadd83;">(</span><span style="color: #8cd0d3;">Path</span>.Pident <span style="color: #eadd83;">{</span><span style="color: #8cd0d3;">Ident</span>.stamp <span style="color: #eadd83;">=</span> 1<span style="color: #eadd83;">;</span> name <span style="color: #eadd83;">=</span> <span style="color: #cc9393;">"int"</span><span style="color: #eadd83;">;</span> flags <span style="color: #eadd83;">=</span> 0<span style="color: #eadd83;">},</span>
                      <span style="color: #eadd83;">[],</span> <span style="color: #eadd83;">{</span>contents <span style="color: #eadd83;">=</span> <span style="color: #8cd0d3;">Types</span>.Mnil<span style="color: #eadd83;">});</span>
                    level <span style="color: #eadd83;">=</span> 3515<span style="color: #eadd83;">;</span> id <span style="color: #eadd83;">=</span> 45689<span style="color: #eadd83;">};</span>
                 level <span style="color: #eadd83;">=</span> 3515<span style="color: #eadd83;">;</span> id <span style="color: #eadd83;">=</span> 45684<span style="color: #eadd83;">};</span>
               val_kind <span style="color: #eadd83;">=</span> <span style="color: #8cd0d3;">Types</span>.Val_reg<span style="color: #eadd83;">;</span> val_loc <span style="color: #eadd83;">=</span> <span style="color: #eadd83;">});</span>
            exp_loc <span style="color: #eadd83;">=</span> <span style="color: #eadd83;">;</span> exp_extra <span style="color: #eadd83;">=</span> <span style="color: #eadd83;">[];</span>
            exp_type <span style="color: #eadd83;">=</span>
             <span style="color: #eadd83;">{</span><span style="color: #8cd0d3;">Types</span>.desc <span style="color: #eadd83;">=</span>
               <span style="color: #8cd0d3;">Types</span>.Tlink
                <span style="color: #eadd83;">{</span><span style="color: #8cd0d3;">Types</span>.desc <span style="color: #eadd83;">=</span>
                  <span style="color: #8cd0d3;">Types</span>.Tconstr
                   <span style="color: #eadd83;">(</span><span style="color: #8cd0d3;">Path</span>.Pident <span style="color: #eadd83;">{</span><span style="color: #8cd0d3;">Ident</span>.stamp <span style="color: #eadd83;">=</span> 1<span style="color: #eadd83;">;</span> name <span style="color: #eadd83;">=</span> <span style="color: #cc9393;">"int"</span><span style="color: #eadd83;">;</span> flags <span style="color: #eadd83;">=</span> 0<span style="color: #eadd83;">},</span>
                   <span style="color: #eadd83;">[],</span> <span style="color: #eadd83;">{</span>contents <span style="color: #eadd83;">=</span> <span style="color: #8cd0d3;">Types</span>.Mnil<span style="color: #eadd83;">});</span>
                 level <span style="color: #eadd83;">=</span> 3515<span style="color: #eadd83;">;</span> id <span style="color: #eadd83;">=</span> 45689<span style="color: #eadd83;">};</span>
              level <span style="color: #eadd83;">=</span> 3515<span style="color: #eadd83;">;</span> id <span style="color: #eadd83;">=</span> 45684<span style="color: #eadd83;">};</span>
            exp_env <span style="color: #eadd83;">=</span> <span style="color: #eadd83;">&lt;</span>abstr<span style="color: #eadd83;">&gt;},</span>
          <span style="color: #8cd0d3;">Typedtree</span>.Required<span style="color: #eadd83;">)]);</span>
      exp_loc <span style="color: #eadd83;">=</span> <span style="color: #eadd83;">;</span> exp_extra <span style="color: #eadd83;">=</span> <span style="color: #eadd83;">[];</span>
      exp_type <span style="color: #eadd83;">=</span>
       <span style="color: #eadd83;">{</span><span style="color: #8cd0d3;">Types</span>.desc <span style="color: #eadd83;">=</span>
         <span style="color: #8cd0d3;">Types</span>.Tconstr
          <span style="color: #eadd83;">(</span><span style="color: #8cd0d3;">Path</span>.Pident <span style="color: #eadd83;">{</span><span style="color: #8cd0d3;">Ident</span>.stamp <span style="color: #eadd83;">=</span> 6<span style="color: #eadd83;">;</span> name <span style="color: #eadd83;">=</span> <span style="color: #cc9393;">"unit"</span><span style="color: #eadd83;">;</span> flags <span style="color: #eadd83;">=</span> 0<span style="color: #eadd83;">},</span> <span style="color: #eadd83;">[],</span>
          <span style="color: #eadd83;">{</span>contents <span style="color: #eadd83;">=</span> <span style="color: #8cd0d3;">Types</span>.Mnil<span style="color: #eadd83;">});</span>
        level <span style="color: #eadd83;">=</span> 3515<span style="color: #eadd83;">;</span> id <span style="color: #eadd83;">=</span> 45688<span style="color: #eadd83;">};</span>
      exp_env <span style="color: #eadd83;">=</span> <span style="color: #eadd83;">&lt;</span>abstr<span style="color: #eadd83;">&gt;});</span>
   exp_loc <span style="color: #eadd83;">=</span> <span style="color: #eadd83;">;</span> exp_extra <span style="color: #eadd83;">=</span> <span style="color: #eadd83;">[];</span>
   exp_type <span style="color: #eadd83;">=</span>
    <span style="color: #eadd83;">{</span><span style="color: #8cd0d3;">Types</span>.desc <span style="color: #eadd83;">=</span>
      <span style="color: #8cd0d3;">Types</span>.Tconstr <span style="color: #eadd83;">(</span><span style="color: #8cd0d3;">Path</span>.Pident <span style="color: #eadd83;">{</span><span style="color: #8cd0d3;">Ident</span>.stamp <span style="color: #eadd83;">=</span> 6<span style="color: #eadd83;">;</span> name <span style="color: #eadd83;">=</span> <span style="color: #cc9393;">"unit"</span><span style="color: #eadd83;">;</span> flags <span style="color: #eadd83;">=</span> 0<span style="color: #eadd83;">},</span>
       <span style="color: #eadd83;">[],</span> <span style="color: #eadd83;">{</span>contents <span style="color: #eadd83;">=</span> <span style="color: #8cd0d3;">Types</span>.Mnil<span style="color: #eadd83;">});</span>
     level <span style="color: #eadd83;">=</span> 100000000<span style="color: #eadd83;">;</span> id <span style="color: #eadd83;">=</span> 45693<span style="color: #eadd83;">};</span>
   exp_env <span style="color: #eadd83;">=</span> <span style="color: #eadd83;">&lt;</span>abstr<span style="color: #eadd83;">&gt;}</span>

</pre>

</li>
<li>translate



<pre class="src src-ocaml"><span style="color: #ff7f00; font-weight: bold;">let</span> <span style="color: #dfaf8f;">c </span><span style="color: #eadd83;">=</span> <span style="color: #8cd0d3;">Translcore</span>.transl_exp b<span style="color: #eadd83;">;;</span>
<span style="color: #ff7f00; font-weight: bold;">val</span> <span style="color: #dfaf8f;">c </span><span style="color: #eadd83;">:</span> <span style="color: #8cd0d3;">Lambda.lambda </span><span style="color: #eadd83;">=</span>
  <span style="color: #8cd0d3;">Lambda</span>.Lfor <span style="color: #eadd83;">({</span><span style="color: #8cd0d3;">Ident</span>.stamp <span style="color: #eadd83;">=</span> 3515<span style="color: #eadd83;">;</span> name <span style="color: #eadd83;">=</span> <span style="color: #cc9393;">"i"</span><span style="color: #eadd83;">;</span> flags <span style="color: #eadd83;">=</span> 0<span style="color: #eadd83;">},</span>
     <span style="color: #8cd0d3;">Lambda</span>.Lconst <span style="color: #eadd83;">(</span><span style="color: #8cd0d3;">Lambda</span>.Const_base <span style="color: #eadd83;">(</span>Const_int 1<span style="color: #eadd83;">)),</span>
     <span style="color: #8cd0d3;">Lambda</span>.Lconst <span style="color: #eadd83;">(</span><span style="color: #8cd0d3;">Lambda</span>.Const_base <span style="color: #eadd83;">(</span>Const_int 10<span style="color: #eadd83;">)),</span> Upto<span style="color: #eadd83;">,</span>
     <span style="color: #8cd0d3;">Lambda</span>.Lapply
      <span style="color: #eadd83;">(</span><span style="color: #8cd0d3;">Lambda</span>.Lprim <span style="color: #eadd83;">(</span><span style="color: #8cd0d3;">Lambda</span>.Pfield 4<span style="color: #eadd83;">,</span>
        <span style="color: #eadd83;">[</span><span style="color: #8cd0d3;">Lambda</span>.Lprim
          <span style="color: #eadd83;">(</span><span style="color: #8cd0d3;">Lambda</span>.Pgetglobal <span style="color: #eadd83;">{</span><span style="color: #8cd0d3;">Ident</span>.stamp <span style="color: #eadd83;">=</span> 0<span style="color: #eadd83;">;</span> name <span style="color: #eadd83;">=</span> <span style="color: #cc9393;">"Format"</span><span style="color: #eadd83;">;</span> flags <span style="color: #eadd83;">=</span> 1<span style="color: #eadd83;">},</span> 
          <span style="color: #eadd83;">[])]),</span>
      <span style="color: #eadd83;">[</span><span style="color: #8cd0d3;">Lambda</span>.Lvar <span style="color: #eadd83;">{</span><span style="color: #8cd0d3;">Ident</span>.stamp <span style="color: #eadd83;">=</span> 3515<span style="color: #eadd83;">;</span> name <span style="color: #eadd83;">=</span> <span style="color: #cc9393;">"i"</span><span style="color: #eadd83;">;</span> flags <span style="color: #eadd83;">=</span> 0<span style="color: #eadd83;">}],</span> <span style="color: #eadd83;">))</span>
</pre>

</li>
<li>compile



<pre class="src src-ocaml"><span style="color: #ff7f00; font-weight: bold;">let</span> <span style="color: #dfaf8f;">d</span><span style="color: #eadd83;">,</span><span style="color: #dfaf8f;">e </span><span style="color: #eadd83;">=</span> <span style="color: #8cd0d3;">Bytegen</span>.compile_phrase c <span style="color: #eadd83;">;;</span>
<span style="color: #ff7f00; font-weight: bold;">val</span> <span style="color: #dfaf8f;">d </span><span style="color: #eadd83;">:</span> <span style="color: #8cd0d3;">Instruct.instruction list </span><span style="color: #eadd83;">=</span>
  <span style="color: #eadd83;">[</span><span style="color: #8cd0d3;">Instruct</span>.Kconst <span style="color: #eadd83;">(</span><span style="color: #8cd0d3;">Lambda</span>.Const_base <span style="color: #eadd83;">(</span>Const_int 1<span style="color: #eadd83;">));</span> <span style="color: #8cd0d3;">Instruct</span>.Kpush<span style="color: #eadd83;">;</span>
   <span style="color: #8cd0d3;">Instruct</span>.Kconst <span style="color: #eadd83;">(</span><span style="color: #8cd0d3;">Lambda</span>.Const_base <span style="color: #eadd83;">(</span>Const_int 10<span style="color: #eadd83;">));</span> <span style="color: #8cd0d3;">Instruct</span>.Kpush<span style="color: #eadd83;">;</span>
   <span style="color: #8cd0d3;">Instruct</span>.Kpush<span style="color: #eadd83;">;</span> <span style="color: #8cd0d3;">Instruct</span>.Kacc 2<span style="color: #eadd83;">;</span> <span style="color: #8cd0d3;">Instruct</span>.Kintcomp <span style="color: #8cd0d3;">Lambda</span>.Cgt<span style="color: #eadd83;">;</span>
   <span style="color: #8cd0d3;">Instruct</span>.Kbranchif 2<span style="color: #eadd83;">;</span> <span style="color: #8cd0d3;">Instruct</span>.Klabel 1<span style="color: #eadd83;">;</span> <span style="color: #8cd0d3;">Instruct</span>.Kcheck_signals<span style="color: #eadd83;">;</span>
   <span style="color: #8cd0d3;">Instruct</span>.Kacc 1<span style="color: #eadd83;">;</span> <span style="color: #8cd0d3;">Instruct</span>.Kpush<span style="color: #eadd83;">;</span>
   <span style="color: #8cd0d3;">Instruct</span>.Kgetglobal <span style="color: #eadd83;">{</span><span style="color: #8cd0d3;">Ident</span>.stamp <span style="color: #eadd83;">=</span> 0<span style="color: #eadd83;">;</span> name <span style="color: #eadd83;">=</span> <span style="color: #cc9393;">"Format"</span><span style="color: #eadd83;">;</span> flags <span style="color: #eadd83;">=</span> 1<span style="color: #eadd83;">};</span>
   <span style="color: #8cd0d3;">Instruct</span>.Kgetfield 4<span style="color: #eadd83;">;</span> <span style="color: #8cd0d3;">Instruct</span>.Kapply 1<span style="color: #eadd83;">;</span> <span style="color: #8cd0d3;">Instruct</span>.Kacc 1<span style="color: #eadd83;">;</span> <span style="color: #8cd0d3;">Instruct</span>.Kpush<span style="color: #eadd83;">;</span>
   <span style="color: #8cd0d3;">Instruct</span>.Koffsetint 1<span style="color: #eadd83;">;</span> <span style="color: #8cd0d3;">Instruct</span>.Kassign 2<span style="color: #eadd83;">;</span> <span style="color: #8cd0d3;">Instruct</span>.Kacc 1<span style="color: #eadd83;">;</span>
   <span style="color: #8cd0d3;">Instruct</span>.Kintcomp <span style="color: #8cd0d3;">Lambda</span>.Cneq<span style="color: #eadd83;">;</span> <span style="color: #8cd0d3;">Instruct</span>.Kbranchif 1<span style="color: #eadd83;">;</span> <span style="color: #8cd0d3;">Instruct</span>.Klabel 2<span style="color: #eadd83;">;</span>
   <span style="color: #8cd0d3;">Instruct</span>.Kconst <span style="color: #eadd83;">(</span><span style="color: #8cd0d3;">Lambda</span>.Const_pointer 0<span style="color: #eadd83;">);</span> <span style="color: #8cd0d3;">Instruct</span>.Kreturn 3<span style="color: #eadd83;">]</span>
<span style="color: #ff7f00; font-weight: bold;">val</span> <span style="color: #dfaf8f;">e </span><span style="color: #eadd83;">:</span> <span style="color: #8cd0d3;">Instruct.instruction list </span><span style="color: #eadd83;">=</span> <span style="color: #eadd83;">[]</span>
</pre>

</li>
<li>emit



<pre class="src src-ocaml"><span style="color: #ff7f00; font-weight: bold;">let</span> <span style="color: #dfaf8f;">n</span><span style="color: #eadd83;">,</span><span style="color: #dfaf8f;">i</span><span style="color: #eadd83;">,</span><span style="color: #dfaf8f;">lst </span><span style="color: #eadd83;">=</span> <span style="color: #8cd0d3;">Emitcode</span>.to_memory d e <span style="color: #eadd83;">;;</span>
Segmentation <span style="color: #dfaf8f;">fault</span><span style="color: #eadd83;">:</span> <span style="color: #8cd0d3;">11</span>

</pre>


<p>
    You can also refer  <a href="#Compiler-FLOW">Compiler FLOW</a> to see how compiler works.
</p></li>
</ul>


</div>
</div>
</div>
</div>

<div id="postamble">
<a href="http://validator.w3.org/check?uri=referer">Validate XHTML 1.0</a>

</div>
</body>
</html>
